#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "üîç Running pre-commit checks..."

# Check for files being committed
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

if [ -z "$STAGED_FILES" ]; then
  echo "‚ÑπÔ∏è  No files staged for commit"
  exit 0
fi

# Check for sensitive files
echo "üîí Checking for sensitive files..."
if echo "$STAGED_FILES" | grep -E "\.env$|\.env\.local$|.*\.sqlite$|.*\.log$"; then
  echo "‚ùå ERROR: Attempting to commit sensitive files!"
  echo "   The following files should not be committed:"
  echo "$STAGED_FILES" | grep -E "\.env$|\.env\.local$|.*\.sqlite$|.*\.log$"
  echo ""
  echo "   Run: git reset HEAD <file> to unstage"
  exit 1
fi

# Check for debug statements
echo "üêõ Checking for debug statements..."
DEBUGGER_FILES=$(echo "$STAGED_FILES" | grep -E "\.(js|ts|jsx|tsx)$" | xargs grep -l "debugger" 2>/dev/null || true)
if [ -n "$DEBUGGER_FILES" ]; then
  echo "‚ö†Ô∏è  WARNING: Found debugger statements in:"
  echo "$DEBUGGER_FILES"
  echo ""
  read -p "Continue anyway? (y/N): " -n 1 -r
  echo
  if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    exit 1
  fi
fi

# Check for large files
echo "üì¶ Checking file sizes..."
LARGE_FILES=$(echo "$STAGED_FILES" | while read file; do
  if [ -f "$file" ]; then
    SIZE=$(stat -f%z "$file" 2>/dev/null || stat -c%s "$file" 2>/dev/null || echo "0")
    if [ "$SIZE" -gt 1048576 ]; then  # 1MB
      echo "$file ($(numfmt --to=iec-i --suffix=B $SIZE 2>/dev/null || echo "${SIZE} bytes"))"
    fi
  fi
done)

if [ -n "$LARGE_FILES" ]; then
  echo "‚ö†Ô∏è  WARNING: Large files detected:"
  echo "$LARGE_FILES"
  echo ""
  read -p "Continue anyway? (y/N): " -n 1 -r
  echo
  if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    exit 1
  fi
fi

# Check for TODO/FIXME comments in staged files (informational only)
TODO_COUNT=$(echo "$STAGED_FILES" | grep -E "\.(js|ts|jsx|tsx)$" | xargs grep -c "TODO\|FIXME" 2>/dev/null | wc -l || echo "0")
if [ "$TODO_COUNT" -gt 0 ]; then
  echo "‚ÑπÔ∏è  Found TODO/FIXME comments in staged files (informational only)"
fi

echo "‚úÖ Pre-commit checks passed!"
exit 0

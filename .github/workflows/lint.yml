name: Lint & Type Check

on:
  push:
    branches: [main, develop, Refactor]
  pull_request:
    branches: [main, develop]

jobs:
  typescript:
    name: TypeScript Type Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Type check backend
        run: npm run type-check --workspace @plex-exporter/backend --if-present
        continue-on-error: true

      - name: Type check shared packages
        run: npm run type-check --workspace @plex-exporter/shared --if-present
        continue-on-error: true

  markdown:
    name: Markdown Lint
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check markdown files
        run: |
          echo "ğŸ“ Checking markdown files..."

          # Check for broken relative links
          find . -name "*.md" -not -path "*/node_modules/*" -not -path "*/.git/*" | while read file; do
            echo "Checking $file"

            # Extract markdown links
            grep -o '\[.*\]([^)]*\.md)' "$file" | while read link; do
              target=$(echo "$link" | sed 's/.*(\(.*\))/\1/')
              dir=$(dirname "$file")

              if [ ! -f "$dir/$target" ]; then
                echo "âš ï¸  Broken link in $file: $target"
              fi
            done
          done

          echo "âœ… Markdown check completed"

  security:
    name: Security Audit
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run npm audit
        run: |
          npm audit --audit-level=moderate || true
          echo "â„¹ï¸  Security audit completed"

      - name: Check for secrets in code
        run: |
          echo "ğŸ” Checking for potential secrets..."

          # Check for common secret patterns
          if grep -r "AKIAI[0-9A-Z]\{16\}" . --exclude-dir=node_modules --exclude-dir=.git; then
            echo "âŒ Found potential AWS keys"
            exit 1
          fi

          if grep -r "api[_-]key\s*=\s*['\"][^'\"]\+" . --exclude-dir=node_modules --exclude-dir=.git --include="*.js" --include="*.ts"; then
            echo "âš ï¸  Found hardcoded API keys (review manually)"
          fi

          echo "âœ… Secret scan completed"

  dockerfile:
    name: Dockerfile Lint
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Lint Dockerfiles
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: apps/backend/Dockerfile
          ignore: DL3008,DL3009
        continue-on-error: true

  yaml:
    name: YAML Lint
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: YAML Lint
        uses: ibiqlik/action-yamllint@v3
        with:
          file_or_dir: |
            .github/workflows/*.yml
            docker-compose.yml
          config_data: |
            extends: default
            rules:
              line-length:
                max: 120
                level: warning
              document-start: disable
              comments:
                min-spaces-from-content: 1
        continue-on-error: true

  editorconfig:
    name: EditorConfig Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check EditorConfig compliance
        uses: editorconfig-checker/action-editorconfig-checker@main
        with:
          version: 2.7.0
        continue-on-error: true

  dependencies:
    name: Check Dependencies
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Check for duplicate dependencies
        run: |
          echo "ğŸ“¦ Checking for duplicate dependencies..."
          npm ls --all 2>&1 | grep "UNMET DEPENDENCY" && echo "âŒ Unmet dependencies found" || echo "âœ… No unmet dependencies"

      - name: Check outdated packages
        run: |
          echo "ğŸ“Š Checking for outdated packages..."
          npm outdated || true
          echo "â„¹ï¸  Consider updating outdated packages"

      - name: Verify workspace integrity
        run: |
          echo "ğŸ” Verifying workspace setup..."
          npm run env --workspaces --if-present
          echo "âœ… Workspace verification completed"

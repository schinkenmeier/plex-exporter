<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Plex Exporter Admin</title>
  <style>
    :root {
      --color-bg: #13161b;
      --color-surface: #1b1f26;
      --color-panel: #212631;
      --color-border: #2c323f;
      --color-text: #f5f6f9;
      --color-muted: #9aa6b8;
      --color-accent: #e5a00d;
      --color-accent-strong: #f5bb39;
      --color-success: #46d369;
      --color-danger: #ef5b5b;
      --color-info: #38bdf8;
      --radius: 12px;
      --radius-sm: 8px;
      --transition: 0.18s ease-in-out;
      font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      background: radial-gradient(circle at top left, rgba(229, 160, 13, 0.08), var(--color-bg));
      color: var(--color-text);
      min-height: 100vh;
      display: flex;
    }

    a {
      color: var(--color-accent);
    }

    .app-shell {
      display: flex;
      width: 100%;
      min-height: 100vh;
    }

    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      z-index: 50;
      pointer-events: none;
    }

    .toast {
      background: rgba(15, 17, 21, 0.92);
      border-radius: var(--radius-sm);
      border: 1px solid rgba(255, 255, 255, 0.08);
      padding: 12px 16px;
      min-width: 220px;
      max-width: 320px;
      color: var(--color-text);
      box-shadow: 0 18px 32px rgba(0, 0, 0, 0.28);
      opacity: 0;
      transform: translateY(-8px);
      transition: opacity 0.2s ease, transform 0.2s ease;
      pointer-events: auto;
    }

    .toast.show {
      opacity: 1;
      transform: translateY(0);
    }

    .toast-success { border-left: 3px solid var(--color-success); }
    .toast-error { border-left: 3px solid var(--color-danger); }
    .toast-info { border-left: 3px solid var(--color-accent); }

    .sidebar {
      width: 240px;
      background: linear-gradient(180deg, rgba(16, 17, 20, 0.95), rgba(16, 17, 20, 0.88));
      border-right: 1px solid rgba(255, 255, 255, 0.04);
      padding: 28px 22px;
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    .brand {
      margin: 0;
      font-size: 20px;
      font-weight: 700;
      letter-spacing: 0.04em;
      text-transform: uppercase;
    }

    .brand-sub {
      margin: 0;
      color: var(--color-muted);
      font-size: 13px;
      letter-spacing: 0.05em;
      text-transform: uppercase;
    }

    .nav-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .nav-button {
      border: none;
      background: transparent;
      color: var(--color-muted);
      font-weight: 600;
      letter-spacing: 0.01em;
      padding: 10px 14px;
      border-radius: var(--radius-sm);
      text-align: left;
      cursor: pointer;
      transition: background var(--transition), color var(--transition), transform var(--transition);
    }

    .nav-button:hover {
      color: var(--color-text);
      transform: translateX(4px);
    }

    .nav-button.active {
      background: rgba(229, 160, 13, 0.16);
      color: var(--color-text);
      box-shadow: 0 8px 24px rgba(229, 160, 13, 0.18);
    }

    .sidebar-footer {
      margin-top: auto;
      display: flex;
      flex-direction: column;
      gap: 10px;
      font-size: 13px;
      color: var(--color-muted);
    }

    .auto-toggle {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
    }

    .auto-toggle input {
      width: 42px;
      height: 24px;
      border-radius: 12px;
      appearance: none;
      background: rgba(255, 255, 255, 0.12);
      position: relative;
      transition: background 0.2s ease;
    }

    .auto-toggle input::after {
      content: "";
      position: absolute;
      top: 3px;
      left: 4px;
      width: 18px;
      height: 18px;
      border-radius: 9px;
      background: #0d0f13;
      transition: transform 0.2s ease;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.45);
    }

    .auto-toggle input:checked {
      background: linear-gradient(135deg, var(--color-accent), var(--color-accent-strong));
    }

    .auto-toggle input:checked::after {
      transform: translateX(18px);
    }

    .main {
      flex: 1;
      padding: 32px 40px;
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    .page-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      flex-wrap: wrap;
      gap: 16px;
    }

    .page-header h2 {
      margin: 0;
      font-size: 26px;
      letter-spacing: -0.01em;
    }

    .page-header p {
      margin: 6px 0 0;
      color: var(--color-muted);
      font-size: 14px;
      max-width: 520px;
    }

    .header-actions {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }

    button {
      font-family: inherit;
      font-size: 14px;
      font-weight: 600;
      border: none;
      border-radius: var(--radius-sm);
      padding: 10px 16px;
      cursor: pointer;
      transition: transform 0.15s ease, box-shadow 0.2s ease, background 0.2s ease;
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .btn {
      background: rgba(255, 255, 255, 0.06);
      color: var(--color-text);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .btn:hover:not(:disabled) {
      transform: translateY(-1px);
      border-color: rgba(229, 160, 13, 0.5);
      box-shadow: 0 10px 18px rgba(229, 160, 13, 0.14);
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--color-accent), var(--color-accent-strong));
      color: #0d0f13;
      border: none;
    }

    .btn-danger {
      background: linear-gradient(135deg, #ff6b6b, var(--color-danger));
      color: #0d0f13;
    }

    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(190px, 1fr));
      gap: 16px;
    }

    .metric-card {
      background: linear-gradient(135deg, rgba(229, 160, 13, 0.1), rgba(27, 31, 38, 0.95));
      border-radius: var(--radius);
      border: 1px solid rgba(229, 160, 13, 0.2);
      padding: 18px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      box-shadow: 0 16px 32px rgba(229, 160, 13, 0.12);
    }

    .metric-card h3 {
      margin: 0;
      font-size: 14px;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      color: rgba(255, 255, 255, 0.75);
    }

    .metric-value {
      font-size: 34px;
      font-weight: 700;
    }

    .metric-sub {
      margin-top: auto;
      font-size: 13px;
      color: rgba(255, 255, 255, 0.7);
    }

    .panel-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 16px;
    }

    .panel {
      background: var(--color-panel);
      border-radius: var(--radius);
      border: 1px solid rgba(255, 255, 255, 0.05);
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 16px;
      box-shadow: 0 16px 30px rgba(0, 0, 0, 0.22);
    }

    .panel header {
      display: flex;
      justify-content: space-between;
      gap: 16px;
      align-items: flex-start;
    }

    .panel header h3 {
      margin: 0;
      font-size: 18px;
    }

    .panel header span {
      color: var(--color-muted);
      font-size: 13px;
    }

    .info-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
      font-size: 14px;
    }

    .info-item {
      display: flex;
      justify-content: space-between;
      gap: 12px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      padding-bottom: 8px;
    }

    .info-item:last-child {
      border-bottom: none;
      padding-bottom: 0;
    }

    .label {
      color: var(--color-muted);
      font-weight: 500;
    }

    .value {
      color: var(--color-text);
      font-weight: 600;
    }

    .chip {
      display: inline-flex;
      align-items: center;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 600;
      letter-spacing: 0.05em;
      text-transform: uppercase;
    }

    .chip-success {
      background: rgba(70, 211, 105, 0.15);
      color: var(--color-success);
    }

    .chip-danger {
      background: rgba(239, 91, 91, 0.15);
      color: var(--color-danger);
    }

    .chip-info {
      background: rgba(56, 189, 248, 0.18);
      color: var(--color-info);
    }

    .view {
      display: none;
      flex-direction: column;
      gap: 24px;
    }

    .view.active {
      display: flex;
    }

    .card {
      background: var(--color-panel);
      border-radius: var(--radius);
      border: 1px solid rgba(255, 255, 255, 0.05);
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 18px;
      box-shadow: 0 16px 28px rgba(0, 0, 0, 0.2);
    }

    .card h3 {
      margin: 0;
      font-size: 18px;
    }

    .card p {
      margin: 0;
      color: var(--color-muted);
      font-size: 14px;
    }

    .option-list {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 12px;
    }

    .checkbox {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      background: rgba(255, 255, 255, 0.04);
      border-radius: var(--radius-sm);
      border: 1px solid rgba(255, 255, 255, 0.07);
      font-size: 13px;
    }

    .checkbox input {
      width: 16px;
      height: 16px;
    }

    .button-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    .input-stack {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-top: 16px;
    }

    .input-stack input {
      padding: 10px 12px;
      border-radius: var(--radius-sm);
      border: 1px solid rgba(255, 255, 255, 0.1);
      background: rgba(255, 255, 255, 0.03);
      color: var(--color-text);
      font-size: 14px;
    }

    .input-stack input::placeholder {
      color: var(--color-muted);
    }

    .log-view {
      background: #101217;
      border-radius: var(--radius-sm);
      border: 1px solid rgba(255, 255, 255, 0.06);
      padding: 14px;
      font-family: "JetBrains Mono", "Fira Code", Consolas, monospace;
      font-size: 13px;
      line-height: 1.5;
      max-height: 280px;
      overflow: auto;
      white-space: pre-wrap;
    }

    .log-entry {
      margin: 0;
      padding: 5px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.04);
    }

    .log-entry:last-child {
      border-bottom: none;
    }

    .log-meta {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      margin-right: 12px;
      color: var(--color-muted);
    }

    .muted {
      color: var(--color-muted);
      font-size: 13px;
    }

    label.input-label {
      font-size: 13px;
      font-weight: 600;
      color: var(--color-muted);
    }

    input[type="text"],
    input[type="email"],
    input[type="number"],
    select {
      width: 100%;
      background: #151820;
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: var(--radius-sm);
      padding: 10px 12px;
      color: var(--color-text);
      font-family: inherit;
      font-size: 14px;
    }

    input:focus,
    select:focus {
      outline: none;
      border-color: rgba(229, 160, 13, 0.6);
      box-shadow: 0 0 0 3px rgba(229, 160, 13, 0.18);
    }

    details {
      background: rgba(255, 255, 255, 0.04);
      border-radius: var(--radius-sm);
      padding: 10px 14px;
      border: 1px solid rgba(255, 255, 255, 0.05);
      font-size: 13px;
    }

    details summary {
      cursor: pointer;
      font-weight: 600;
    }

    details pre {
      margin-top: 12px;
      background: #0f1116;
      border-radius: var(--radius-sm);
      padding: 12px;
      border: 1px solid rgba(255, 255, 255, 0.06);
      max-height: 320px;
      overflow: auto;
      color: var(--color-text);
    }

    .alert {
      border-radius: var(--radius-sm);
      padding: 12px 14px;
      font-size: 14px;
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .alert-info {
      background: rgba(56, 189, 248, 0.15);
      border: 1px solid rgba(56, 189, 248, 0.35);
      color: var(--color-info);
    }

    .alert-error {
      background: rgba(239, 91, 91, 0.16);
      border: 1px solid rgba(239, 91, 91, 0.35);
      color: var(--color-danger);
    }

    @media (max-width: 980px) {
      body {
        flex-direction: column;
      }

      .sidebar {
        width: 100%;
        height: auto;
        flex-direction: row;
        align-items: center;
        gap: 18px;
        overflow-x: auto;
      }

      .nav-list {
        flex-direction: row;
      }

      .sidebar-footer {
        display: none;
      }

      .main {
        padding: 24px;
      }
    }

    @media (max-width: 640px) {
      .main {
        padding: 18px;
      }

      .metrics-grid,
      .panel-grid,
      .option-list {
        grid-template-columns: 1fr;
      }

      .button-row {
        flex-direction: column;
        align-items: stretch;
      }

      .page-header {
        flex-direction: column;
        align-items: stretch;
      }
    }
  </style>
</head>
<body>
  <div class="toast-container" id="toast-container"></div>
  <div class="app-shell">
    <aside class="sidebar">
      <div>
        <h1 class="brand">Plex Exporter</h1>
        <p class="brand-sub">Admin control center</p>
      </div>
      <nav class="nav-list">
        <button class="nav-button active" data-view="dashboard">Dashboard</button>
        <button class="nav-button" data-view="config">Configuration</button>
        <button class="nav-button" data-view="logs">Logs</button>
        <button class="nav-button" data-view="tautulli-sync">Tautulli Sync</button>
        <button class="nav-button" data-view="diagnostics">Diagnostics</button>
      </nav>
      <div class="sidebar-footer">
        <label class="auto-toggle">
          <input type="checkbox" id="auto-refresh-toggle">
          Auto refresh
        </label>
        <div>
          <div>Last update</div>
          <div id="last-updated">not loaded yet</div>
        </div>
      </div>
    </aside>
    <main class="main">
      <header class="page-header">
        <div>
          <h2>Admin dashboard</h2>
          <p id="header-text">System overview and service status in one place.</p>
        </div>
        <div class="header-actions">
          <span class="muted" id="auto-refresh-label">auto refresh off</span>
          <button class="btn" id="refresh-button">Refresh view</button>
        </div>
      </header>

      <section class="view active" id="view-dashboard">
        <div class="metrics-grid">
          <article class="metric-card">
            <h3>Total media</h3>
            <div class="metric-value" id="stat-total-media">-</div>
            <div class="metric-sub">Movies <span id="stat-movie-count">-</span> | Shows <span id="stat-show-count">-</span></div>
          </article>
          <article class="metric-card">
            <h3>Series structure</h3>
            <div class="metric-value" id="stat-season-count">-</div>
            <div class="metric-sub">Episodes <span id="stat-episode-count">-</span> | Cast <span id="stat-cast-count">-</span></div>
          </article>
          <article class="metric-card">
            <h3>Thumbnails</h3>
            <div class="metric-value" id="stat-thumb-total">-</div>
            <div class="metric-sub">Combined media artwork count</div>
          </article>
          <article class="metric-card">
            <h3>Database size</h3>
            <div class="metric-value" id="stat-db-size">-</div>
            <div class="metric-sub" id="stat-db-path">path unknown</div>
          </article>
          <article class="metric-card">
            <h3>Uptime</h3>
            <div class="metric-value" id="stat-uptime">-</div>
            <div class="metric-sub">PID <span id="stat-pid">-</span> | Node <span id="stat-node">-</span></div>
          </article>
        </div>

        <div class="panel-grid">
          <article class="panel">
            <header>
              <div>
                <h3>System status</h3>
                <span>Runtime, memory and host details</span>
              </div>
              <div id="system-status-chip"></div>
            </header>
            <div class="info-list" id="system-status">
              <div class="muted">Loading system status...</div>
            </div>
          </article>
          <article class="panel">
            <header>
              <div>
                <h3>Services</h3>
                <span>TMDB, Tautulli, API auth</span>
              </div>
            </header>
            <div class="info-list" id="service-status">
              <div class="muted">Loading service configuration...</div>
            </div>
          </article>
          <article class="panel">
            <header>
              <div>
                <h3>Series samples</h3>
                <span>Recently indexed series with seasons and cast preview</span>
              </div>
            </header>
            <div class="info-list" id="series-overview">
              <div class="muted">Loading series overview...</div>
            </div>
          </article>
        </div>
      </section>

      <section class="view" id="view-config">
        <article class="card">
          <div>
            <h3>TMDb integration</h3>
            <p>Manage the TMDb API token used for hero enrichment and artwork fetching.</p>
          </div>
          <div class="input-stack">
            <label class="input-label" for="tmdb-token-input">TMDb access token</label>
            <input id="tmdb-token-input" type="password" autocomplete="off" placeholder="TMDb v4 API Read Access Token">
            <div class="muted" id="tmdb-token-status">Loading TMDb status…</div>
            <div class="button-row">
              <button class="btn btn-primary" id="btn-save-tmdb">Save token</button>
              <button class="btn" id="btn-test-tmdb">Test token</button>
              <button class="btn btn-danger" id="btn-clear-tmdb">Remove token</button>
            </div>
            <div class="muted" id="tmdb-test-output">No test executed yet.</div>
          </div>
        </article>
        <article class="card">
          <div>
            <h3>Resend email configuration</h3>
            <p>Manage email delivery settings using Resend for watchlist emails, welcome emails and newsletters.</p>
          </div>
          <div class="input-stack">
            <label class="input-label" for="resend-api-key-input">Resend API key</label>
            <input id="resend-api-key-input" type="password" autocomplete="off" placeholder="re_xxxxxxxxxxxxx">
            <label class="input-label" for="resend-from-email-input">From email address</label>
            <input id="resend-from-email-input" type="email" autocomplete="off" placeholder="no-reply@example.com">
            <div class="muted" id="resend-status">Loading Resend status…</div>
            <label class="input-label" for="resend-test-to-input">Test recipient email</label>
            <input id="resend-test-to-input" type="email" autocomplete="off" placeholder="test@example.com">
            <div class="button-row">
              <button class="btn btn-primary" id="btn-save-resend">Save configuration</button>
              <button class="btn" id="btn-test-resend">Send test email</button>
              <button class="btn btn-danger" id="btn-clear-resend">Remove configuration</button>
            </div>
            <div class="muted" id="resend-test-output">No test executed yet.</div>
          </div>
        </article>
        <article class="card">
          <div>
            <h3>Configuration snapshot</h3>
            <p>Current backend configuration (sensitive values are masked).</p>
          </div>
          <div id="config-view">
            <div class="muted">Loading configuration...</div>
          </div>
        </article>
      </section>

      <section class="view" id="view-logs">
        <article class="card">
          <div>
            <h3>Runtime logs</h3>
            <p>Recent entries from the in-memory log buffer.</p>
          </div>
          <div class="button-row">
            <label class="input-label" for="log-level">Level</label>
            <select id="log-level">
              <option value="">all levels</option>
              <option value="debug">debug</option>
              <option value="info">info</option>
              <option value="warn">warn</option>
              <option value="error">error</option>
            </select>
            <label class="input-label" for="log-limit">Limit</label>
            <input type="number" id="log-limit" min="10" max="500" value="150">
            <button class="btn" id="btn-refresh-logs">Refresh</button>
            <button class="btn" id="btn-clear-logs">Clear logs</button>
          </div>
          <div class="muted" id="log-summary">No logs loaded yet.</div>
          <div class="log-view" id="log-view">Press refresh to load logs.</div>
        </article>
      </section>

      <section class="view" id="view-tautulli-sync">
        <div class="panel-grid">
          <!-- Tautulli Connection Panel -->
          <article class="panel">
            <h3>Tautulli-Verbindung</h3>
            <p>Tautulli API-Verbindungseinstellungen konfigurieren</p>
            <div id="tautulli-config-content">
              <label class="input-label">Tautulli URL</label>
              <input type="text" id="tautulli-url" placeholder="https://tautulli.example.com" style="width: 100%; margin-bottom: 4px;">
              <small class="muted" style="display: block; margin-bottom: 12px;">
                Nur die Basis-URL eingeben (z.B. https://tautulli.dinspel.eu). /api/v2 nicht angeben - wird automatisch hinzugefügt.
              </small>
              <label class="input-label">API-Schlüssel</label>
              <input type="password" id="tautulli-api-key" placeholder="Ihren Tautulli API-Schlüssel eingeben" style="width: 100%; margin-bottom: 12px;">
              <label class="input-label">
                <input type="checkbox" id="show-api-key">
                API-Schlüssel anzeigen
              </label>
              <div style="margin-top: 12px;">
                <button class="btn-primary" id="btn-save-tautulli-config">Konfiguration speichern</button>
                <button class="btn" id="btn-test-connection" style="margin-left: 8px;">Verbindung testen</button>
              </div>
              <div id="tautulli-config-status" class="muted" style="margin-top: 16px;"></div>
            </div>
          </article>

          <!-- Library Selection Panel -->
          <article class="panel">
            <h3>Bibliotheks-Konfiguration</h3>
            <p>Wählen Sie aus, welche Tautulli-Bibliotheken synchronisiert werden sollen</p>
            <div id="library-config-content">
              <button class="btn" id="btn-load-libraries">Verfügbare Bibliotheken laden</button>
              <div id="library-list" class="muted" style="margin-top: 16px;">Klicken Sie auf "Verfügbare Bibliotheken laden", um diese von Tautulli abzurufen</div>
              <div id="selected-libraries" style="margin-top: 16px; display: none;">
                <h4>Ausgewählte Bibliotheken</h4>
                <div id="selected-libraries-list"></div>
                <button class="btn-primary" id="btn-save-libraries" style="margin-top: 12px;">Konfiguration speichern</button>
              </div>
            </div>
          </article>

          <!-- Manual Sync Panel -->
          <article class="panel">
            <h3>Manueller Sync</h3>
            <p>Einen einmaligen Synchronisationsvorgang auslösen</p>
            <div class="alert alert-info" style="margin-bottom: 16px;">
              <strong>Sync-Ablauf:</strong> Zuerst werden Metadaten und IDs (TMDb, IMDb) von Tautulli abgerufen, dann werden bei aktivierter Option die Bilder lokal gespeichert, und anschließend optional TMDb-Anreicherung durchgeführt.
            </div>
            <div class="option-list">
              <label class="checkbox">
                <input type="checkbox" id="sync-incremental" checked>
                <div>
                  <strong>Inkrementell</strong>
                  <div class="muted" style="font-size: 11px; margin-top: 2px;">Nur geänderte Einträge synchronisieren</div>
                </div>
              </label>
              <label class="checkbox">
                <input type="checkbox" id="sync-covers" checked>
                <div>
                  <strong>Covers von Tautulli herunterladen</strong>
                  <div class="muted" style="font-size: 11px; margin-top: 2px;">Poster und Backdrops lokal speichern (empfohlen für manuellen Sync)</div>
                </div>
              </label>
              <label class="checkbox">
                <input type="checkbox" id="sync-tmdb" checked>
                <div>
                  <strong>Mit TMDb anreichern</strong>
                  <div class="muted" style="font-size: 11px; margin-top: 2px;">Zusätzliche Metadaten und Bewertungen von TMDb abrufen</div>
                </div>
              </label>
            </div>
            <button class="btn-primary" id="btn-start-sync">Sync starten</button>
            <div id="sync-status" class="muted" style="margin-top: 16px;"></div>
          </article>

          <!-- Schedule Configuration Panel -->
          <article class="panel">
            <h3>Automatischer Sync</h3>
            <p>Automatische tägliche Synchronisation konfigurieren</p>
            <div class="alert alert-info" style="margin-bottom: 16px;">
              <strong>Hinweis:</strong> Bei automatischen Syncs werden standardmäßig keine Bilder heruntergeladen, um die Performance zu optimieren. Für Bild-Downloads verwenden Sie bitte den manuellen Sync.
            </div>
            <div id="schedule-config">
              <label class="input-label">Job-Typ</label>
              <select id="schedule-job-type">
                <option value="tautulli_sync">Tautulli Sync</option>
                <option value="cover_update">Cover Update</option>
              </select>
              <label class="input-label">Cron-Ausdruck</label>
              <input type="text" id="schedule-cron" placeholder="0 3 * * *" value="0 3 * * *">
              <small class="muted">Beispiel: "0 3 * * *" = Täglich um 3:00 Uhr</small>
              <label class="input-label">
                <input type="checkbox" id="schedule-enabled" checked>
                Aktiviert
              </label>
              <button class="btn" id="btn-save-schedule" style="margin-top: 12px;">Zeitplan speichern</button>
            </div>
            <div id="current-schedules" style="margin-top: 16px;">
              <h4>Aktuelle Zeitpläne</h4>
              <div id="schedules-list" class="muted">Lädt...</div>
            </div>
          </article>

          <!-- Sync Statistics Panel -->
          <article class="panel">
            <h3>Konfigurierte Bibliotheken</h3>
            <div id="library-sections-list" class="muted">Lädt...</div>
          </article>
        </div>
      </section>

      <section class="view" id="view-diagnostics">
        <div class="panel-grid">
          <article class="panel">
            <header>
              <div>
                <h3>Tautulli test</h3>
                <span>Check API connectivity and list libraries.</span>
              </div>
            </header>
            <div class="info-list">
              <button class="btn" id="btn-test-tautulli">Run test</button>
              <div class="muted" id="tautulli-output">No test executed yet.</div>
            </div>
          </article>
          <article class="panel">
            <header>
              <div>
                <h3>Database test</h3>
                <span>Verify SQLite access and record count.</span>
              </div>
            </header>
            <div class="info-list">
              <button class="btn" id="btn-test-db">Run test</button>
              <div class="muted" id="db-output">No test executed yet.</div>
            </div>
          </article>
          <article class="panel">
            <header>
              <div>
                <h3>Resend email test</h3>
                <span>Send a test email to verify Resend configuration.</span>
              </div>
            </header>
            <div class="info-list">
              <label class="input-label" for="resend-test-email">Test recipient email</label>
              <input type="email" id="resend-test-email" placeholder="test@example.com">
              <button class="btn" id="btn-test-resend-diag">Send test email</button>
              <div class="muted" id="resend-diag-output">No test executed yet.</div>
            </div>
          </article>
        </div>
      </section>
    </main>
  </div>
  <script>
    (() => {
      const API_BASE = "/admin/api";
      const DASHBOARD_INTERVAL = 30000;
      const toastRoot = document.getElementById("toast-container");

      const elements = {
        navButtons: Array.from(document.querySelectorAll(".nav-button")),
        views: {
          dashboard: document.getElementById("view-dashboard"),
          config: document.getElementById("view-config"),
          logs: document.getElementById("view-logs"),
          "tautulli-sync": document.getElementById("view-tautulli-sync"),
          diagnostics: document.getElementById("view-diagnostics"),
        },
        refreshButton: document.getElementById("refresh-button"),
        autoToggle: document.getElementById("auto-refresh-toggle"),
        autoLabel: document.getElementById("auto-refresh-label"),
        lastUpdated: document.getElementById("last-updated"),
        headerText: document.getElementById("header-text"),
        statTotalMedia: document.getElementById("stat-total-media"),
        statMovieCount: document.getElementById("stat-movie-count"),
        statShowCount: document.getElementById("stat-show-count"),
        statSeasonCount: document.getElementById("stat-season-count"),
        statEpisodeCount: document.getElementById("stat-episode-count"),
        statCastCount: document.getElementById("stat-cast-count"),
        statThumbTotal: document.getElementById("stat-thumb-total"),
        statDbSize: document.getElementById("stat-db-size"),
        statDbPath: document.getElementById("stat-db-path"),
        statUptime: document.getElementById("stat-uptime"),
        statPid: document.getElementById("stat-pid"),
        statNode: document.getElementById("stat-node"),
        systemStatusChip: document.getElementById("system-status-chip"),
        systemStatus: document.getElementById("system-status"),
        serviceStatus: document.getElementById("service-status"),
        seriesOverview: document.getElementById("series-overview"),
        configView: document.getElementById("config-view"),
        tmdbTokenInput: document.getElementById("tmdb-token-input"),
        tmdbTokenStatus: document.getElementById("tmdb-token-status"),
        tmdbSaveButton: document.getElementById("btn-save-tmdb"),
        tmdbTestButton: document.getElementById("btn-test-tmdb"),
        tmdbClearButton: document.getElementById("btn-clear-tmdb"),
        tmdbTestOutput: document.getElementById("tmdb-test-output"),
        resendApiKeyInput: document.getElementById("resend-api-key-input"),
        resendFromEmailInput: document.getElementById("resend-from-email-input"),
        resendTestToInput: document.getElementById("resend-test-to-input"),
        resendStatus: document.getElementById("resend-status"),
        resendSaveButton: document.getElementById("btn-save-resend"),
        resendTestButton: document.getElementById("btn-test-resend"),
        resendClearButton: document.getElementById("btn-clear-resend"),
        resendTestOutput: document.getElementById("resend-test-output"),
        resendTestEmail: document.getElementById("resend-test-email"),
        resendTestButtonDiag: document.getElementById("btn-test-resend-diag"),
        resendDiagOutput: document.getElementById("resend-diag-output"),
        logView: document.getElementById("log-view"),
        logSummary: document.getElementById("log-summary"),
        logLevel: document.getElementById("log-level"),
        logLimit: document.getElementById("log-limit"),
        refreshLogs: document.getElementById("btn-refresh-logs"),
        clearLogs: document.getElementById("btn-clear-logs"),
        tautulliOutput: document.getElementById("tautulli-output"),
        tautulliButton: document.getElementById("btn-test-tautulli"),
        dbOutput: document.getElementById("db-output"),
        dbButton: document.getElementById("btn-test-db"),
      };

      const state = {
        currentView: "dashboard",
        autoRefresh: false,
        autoTimer: null,
        tmdbStatus: null,
        resendStatus: null,
      };

      const viewDescriptions = {
        dashboard: "System overview and service status in one place.",
        config: "Manage TMDb credentials and inspect the backend configuration snapshot.",
        logs: "Inspect the in-memory log buffer. Useful for quick diagnostics.",
        "tautulli-sync": "Manage Tautulli synchronization, library selection, and sync schedules.",
        diagnostics: "Connectivity checks for Tautulli and database services.",
      };

      const viewLoaders = {
        dashboard: loadDashboard,
        config: loadConfig,
        logs: loadLogs,
        "tautulli-sync": async () => {
          await loadTautulliConfig();
          await loadLibrarySections();
          await loadSchedules();
        },
        diagnostics: async () => {},
      };

      function escapeHtml(value) {
        return String(value)
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#39;");
      }

      async function fetchJson(url, options) {
        const config = Object.assign({ headers: {} }, options);
        if (config.body && !config.headers["Content-Type"]) {
          config.headers["Content-Type"] = "application/json";
        }
        const response = await fetch(url, config);
        const text = await response.text();
        let data = {};
        if (text) {
          try {
            data = JSON.parse(text);
          } catch {
            data = { message: text };
          }
        }
        if (!response.ok) {
          const message = data.message || data.error || response.statusText || "request failed";
          throw new Error(message);
        }
        return data;
      }

      function showToast(message, type = "info", timeout = 3200) {
        const toast = document.createElement("div");
        toast.className = `toast toast-${type}`;
        toast.textContent = message;
        toastRoot.appendChild(toast);
        requestAnimationFrame(() => toast.classList.add("show"));
        setTimeout(() => {
          toast.classList.remove("show");
          setTimeout(() => toast.remove(), 200);
        }, timeout);
      }

      function setLastUpdated(source) {
        const ts = new Date().toLocaleTimeString("de-DE");
        elements.lastUpdated.textContent = `${source} | ${ts}`;
      }

      function updateHeader(view) {
        elements.headerText.textContent = viewDescriptions[view] || viewDescriptions.dashboard;
      }

      function switchView(view) {
        if (!elements.views[view]) {
          return;
        }
        state.currentView = view;
        elements.navButtons.forEach(btn => {
          btn.classList.toggle("active", btn.dataset.view === view);
        });
        Object.entries(elements.views).forEach(([name, node]) => {
          node.classList.toggle("active", name === view);
        });
        updateHeader(view);
        const loader = viewLoaders[view];
        if (typeof loader === "function") {
          loader().catch(err => {
            console.error(err);
            showToast(`Failed to load ${view}: ${err.message}`, "error");
          });
        }
      }

      function setAutoRefresh(enabled) {
        if (state.autoTimer) {
          clearInterval(state.autoTimer);
          state.autoTimer = null;
        }
        state.autoRefresh = enabled;
        elements.autoToggle.checked = enabled;
        elements.autoLabel.textContent = enabled ? "auto refresh every 30s" : "auto refresh off";
        localStorage.setItem("admin:autoRefresh", enabled ? "1" : "0");
        if (enabled) {
          state.autoTimer = setInterval(() => {
            if (state.currentView === "dashboard") {
              loadDashboard().catch(err => console.error(err));
            }
          }, DASHBOARD_INTERVAL);
        }
      }

      async function loadDashboard() {
        elements.systemStatus.innerHTML = `<div class="muted">Loading system status...</div>`;
        elements.serviceStatus.innerHTML = `<div class="muted">Loading service configuration...</div>`;
        elements.seriesOverview.innerHTML = `<div class="muted">Loading series overview...</div>`;
        try {
          const [status, stats, config] = await Promise.all([
            fetchJson(`${API_BASE}/status`),
            fetchJson(`${API_BASE}/stats`),
            fetchJson(`${API_BASE}/config`),
          ]);
          renderStats(stats);
          renderSeriesOverview(stats.seriesSamples || []);
          renderSystemStatus(status);
          renderServiceStatus(config);
          setLastUpdated("dashboard");
        } catch (error) {
          elements.systemStatus.innerHTML = `<div class="alert alert-error">${escapeHtml(error.message)}</div>`;
          elements.serviceStatus.innerHTML = `<div class="alert alert-error">${escapeHtml(error.message)}</div>`;
          renderSeriesOverview([]);
          throw error;
        }
      }

      function renderStats(stats) {
        const media = stats.media || {};
        const thumbs = stats.thumbnails || {};
        const db = stats.database || {};
        const cast = stats.cast || {};
        elements.statTotalMedia.textContent = media.total ?? "-";
        elements.statMovieCount.textContent = media.movies ?? "-";
        elements.statShowCount.textContent = media.series ?? "-";
        elements.statSeasonCount.textContent = media.seasons ?? "-";
        elements.statEpisodeCount.textContent = media.episodes ?? "-";
        elements.statCastCount.textContent = cast.members ?? "-";
        elements.statThumbTotal.textContent = thumbs.total ?? "-";
        elements.statDbSize.textContent = db.size ?? "-";
        elements.statDbPath.textContent = db.path ?? "path unknown";
      }

      function renderSystemStatus(status) {
        if (!status || status.status !== "ok") {
          elements.systemStatusChip.innerHTML = `<span class="chip chip-danger">error</span>`;
        } else {
          elements.systemStatusChip.innerHTML = `<span class="chip chip-success">online</span>`;
        }
        if (status?.uptime?.formatted) {
          elements.statUptime.textContent = status.uptime.formatted;
        }
        if (status?.process?.pid) {
          elements.statPid.textContent = status.process.pid;
        }
        if (status?.system?.nodeVersion) {
          elements.statNode.textContent = status.system.nodeVersion;
        }
        const rows = [
          { label: "Uptime (seconds)", value: status?.uptime?.seconds ?? "-" },
          { label: "RSS", value: status?.memory?.rss ?? "-" },
          { label: "Heap total", value: status?.memory?.heapTotal ?? "-" },
          { label: "Heap used", value: status?.memory?.heapUsed ?? "-" },
          { label: "Platform", value: status?.system?.platform ?? "-" },
          { label: "Architecture", value: status?.system?.arch ?? "-" },
          { label: "CPU count", value: status?.system?.cpus ?? "-" },
          { label: "Free memory", value: status?.system?.freeMemory ?? "-" },
          { label: "Total memory", value: status?.system?.totalMemory ?? "-" },
        ];
        elements.systemStatus.innerHTML = rows.map(row => `
          <div class="info-item">
            <span class="label">${escapeHtml(row.label)}</span>
            <span class="value">${escapeHtml(row.value)}</span>
          </div>
        `).join("");
      }

      function renderServiceStatus(config) {
        const items = [
          { name: "Tautulli", enabled: !!config.tautulli?.enabled, detail: config.tautulli?.url ?? "" },
          { name: "TMDB", enabled: !!config.tmdb?.enabled, detail: config.tmdb?.accessToken ? "access token set" : "" },
          { name: "API auth", enabled: !!config.auth?.enabled, detail: config.auth?.token ? "token set" : "" },
        ];
        elements.serviceStatus.innerHTML = items.map(item => `
          <div class="info-item">
            <span class="label">${escapeHtml(item.name)}</span>
            <span class="value">
              <span class="chip ${item.enabled ? "chip-success" : "chip-danger"}">${item.enabled ? "enabled" : "disabled"}</span>
            </span>
          </div>
          ${item.detail ? `<div class="muted">${escapeHtml(item.detail)}</div>` : ""}
        `).join("");
      }

      function renderSeriesOverview(samples) {
        if (!Array.isArray(samples) || samples.length === 0) {
          elements.seriesOverview.innerHTML = `<div class="muted">No series sample data available yet.</div>`;
          return;
        }

        const content = samples.map(sample => {
          const title = escapeHtml(sample.title ?? 'Untitled');
          const seasonCount = escapeHtml(String(sample.seasonCount ?? '-'));
          const episodeCount = escapeHtml(String(sample.episodeCount ?? '-'));

          const seasonsArray = Array.isArray(sample.seasons) ? sample.seasons : [];
          const seasonsSummary = seasonsArray.length
            ? seasonsArray
                .map(season => {
                  const number = escapeHtml(String(season?.number ?? '?'));
                  const episodes = escapeHtml(String(season?.episodeCount ?? 0));
                  return `S${number} (${episodes})`;
                })
                .join(', ')
            : 'n/a';

          const castArray = Array.isArray(sample.cast) ? sample.cast : [];
          const castSummary = castArray.length
            ? castArray
                .map(member => {
                  const name = member?.name ? escapeHtml(member.name) : '';
                  if (!name) return null;
                  const character = member?.character ? ` as ${escapeHtml(member.character)}` : '';
                  return `${name}${character}`;
                })
                .filter(Boolean)
                .join(', ')
            : 'n/a';

          return `
            <div class="info-item">
              <span class="label">${title}</span>
              <span class="value">Seasons ${seasonCount} • Episodes ${episodeCount}</span>
            </div>
            <div class="muted">Seasons: ${seasonsSummary || 'n/a'}</div>
            <div class="muted">Cast: ${castSummary || 'n/a'}</div>
          `;
        }).join('');

        elements.seriesOverview.innerHTML = content;
      }

      async function loadConfigSnapshot() {
        elements.configView.innerHTML = `<div class="muted">Loading configuration...</div>`;
        try {
          const data = await fetchJson(`${API_BASE}/config`);
          const sections = Object.entries(data).map(([key, value]) => `
            <details>
              <summary>${escapeHtml(key)}</summary>
              <pre>${escapeHtml(JSON.stringify(value, null, 2))}</pre>
            </details>
          `).join("");
          elements.configView.innerHTML = sections || `<div class="muted">No configuration data.</div>`;
        } catch (error) {
          elements.configView.innerHTML = `<div class="alert alert-error">${escapeHtml(error.message)}</div>`;
          throw error;
        }
      }

      function renderTmdbStatus(status) {
        state.tmdbStatus = status || null;
        if (!elements.tmdbTokenStatus) return;
        if (!status || !status.enabled) {
          elements.tmdbTokenStatus.textContent = status?.fromEnv
            ? "Active token provided via environment configuration."
            : "No TMDb token stored yet.";
        } else {
          const preview = status.tokenPreview ? ` (${status.tokenPreview})` : "";
          const updated = status.updatedAt
            ? ` — updated ${new Date(status.updatedAt).toLocaleString("de-DE")}`
            : "";
          const sourceLabel = status.source === "database" ? "stored in database" : "provided via environment";
          elements.tmdbTokenStatus.textContent = `Token ${sourceLabel}${preview}${updated}`;
        }
        if (elements.tmdbClearButton) {
          elements.tmdbClearButton.disabled = !status || !status.fromDatabase;
        }
        if (elements.tmdbTestButton) {
          elements.tmdbTestButton.disabled = false;
        }
      }

      async function loadTmdbStatus() {
        if (!elements.tmdbTokenStatus) return;
        elements.tmdbTokenStatus.textContent = "Loading TMDb status...";
        try {
          const data = await fetchJson(`${API_BASE}/tmdb`);
          renderTmdbStatus(data);
          if (elements.tmdbTestOutput) {
            elements.tmdbTestOutput.textContent = "No test executed yet.";
          }
        } catch (error) {
          elements.tmdbTokenStatus.textContent = `Failed to load TMDb status: ${error.message}`;
          throw error;
        }
      }

      function renderResendStatus(status) {
        state.resendStatus = status || null;
        if (!elements.resendStatus) return;
        if (!status || !status.enabled) {
          elements.resendStatus.textContent = status?.fromEnv
            ? "Active configuration provided via environment variables."
            : "No Resend configuration stored yet.";
        } else {
          const apiKeyPreview = status.apiKeyPreview ? ` (${status.apiKeyPreview})` : "";
          const fromEmail = status.fromEmail ? ` | From: ${status.fromEmail}` : "";
          const updated = status.updatedAt
            ? ` — updated ${new Date(status.updatedAt).toLocaleString("de-DE")}`
            : "";
          const sourceLabel = status.source === "database" ? "stored in database" : "provided via environment";
          elements.resendStatus.textContent = `Configuration ${sourceLabel}${apiKeyPreview}${fromEmail}${updated}`;
        }
        if (elements.resendClearButton) {
          elements.resendClearButton.disabled = !status || !status.fromDatabase;
        }
        if (elements.resendTestButton) {
          elements.resendTestButton.disabled = false;
        }
      }

      async function loadResendStatus() {
        if (!elements.resendStatus) return;
        elements.resendStatus.textContent = "Loading Resend status...";
        try {
          const data = await fetchJson(`${API_BASE}/resend/settings`);
          renderResendStatus(data);
          if (elements.resendTestOutput) {
            elements.resendTestOutput.textContent = "No test executed yet.";
          }
        } catch (error) {
          elements.resendStatus.textContent = `Failed to load Resend status: ${error.message}`;
          throw error;
        }
      }

      async function handleSaveResend(event) {
        event?.preventDefault();
        if (!elements.resendSaveButton || !elements.resendApiKeyInput || !elements.resendFromEmailInput) return;
        const apiKey = elements.resendApiKeyInput.value.trim();
        const fromEmail = elements.resendFromEmailInput.value.trim();
        if (!apiKey || !fromEmail) {
          showToast("Please enter both API key and from email address.", "error");
          return;
        }
        elements.resendSaveButton.disabled = true;
        if (elements.resendTestButton) elements.resendTestButton.disabled = true;
        if (elements.resendClearButton) elements.resendClearButton.disabled = true;
        try {
          await fetchJson(`${API_BASE}/resend/settings`, {
            method: "PUT",
            body: JSON.stringify({ apiKey, fromEmail }),
          });
          elements.resendApiKeyInput.value = "";
          elements.resendFromEmailInput.value = "";
          // Reload status to update state
          await loadResendStatus();
          if (elements.resendTestOutput) {
            elements.resendTestOutput.textContent = "Configuration saved. Run a test to verify.";
          }
          showToast("Resend configuration stored successfully.", "success");
        } catch (error) {
          showToast(error.message, "error");
        } finally {
          elements.resendSaveButton.disabled = false;
          if (elements.resendTestButton) elements.resendTestButton.disabled = false;
          if (elements.resendClearButton) {
            elements.resendClearButton.disabled = !state.resendStatus || !state.resendStatus.fromDatabase;
          }
        }
      }

      async function handleTestResend(event) {
        event?.preventDefault();
        if (!elements.resendTestButton || !elements.resendTestToInput) return;
        const toEmail = elements.resendTestToInput.value.trim();
        if (!toEmail) {
          if (elements.resendTestOutput) {
            elements.resendTestOutput.textContent = "Please enter a recipient email address.";
          }
          showToast("Please enter a recipient email address to send the test.", "error");
          return;
        }
        if (!state.resendStatus?.enabled) {
          if (elements.resendTestOutput) {
            elements.resendTestOutput.textContent = "Please save Resend configuration before running a test.";
          }
          showToast("Please save Resend configuration before running a test.", "error");
          return;
        }
        elements.resendTestButton.disabled = true;
        if (elements.resendTestOutput) {
          elements.resendTestOutput.textContent = "Sending test email...";
        }
        try {
          const data = await fetchJson(`${API_BASE}/test/resend`, {
            method: "POST",
            body: JSON.stringify({ to: toEmail }),
          });
          let message = `Success: Test email sent to ${toEmail}`;
          if (data.id) {
            message += ` | Email ID: ${data.id}`;
          }
          if (elements.resendTestOutput) {
            elements.resendTestOutput.textContent = message;
          }
          showToast("Resend test email sent successfully.", "success");
        } catch (error) {
          if (elements.resendTestOutput) {
            elements.resendTestOutput.textContent = `Error: ${error.message}`;
          }
          showToast(error.message, "error");
        } finally {
          elements.resendTestButton.disabled = false;
        }
      }

      async function handleClearResend(event) {
        event?.preventDefault();
        if (!elements.resendClearButton) return;
        if (!state.resendStatus?.fromDatabase) {
          showToast("There is no stored Resend configuration to remove.", "info");
          return;
        }
        elements.resendClearButton.disabled = true;
        try {
          const data = await fetchJson(`${API_BASE}/resend/settings`, { method: "DELETE" });
          renderResendStatus(data.status);
          if (elements.resendTestOutput) {
            elements.resendTestOutput.textContent = "Stored configuration removed. Provide configuration to test.";
          }
          showToast("Stored Resend configuration removed.", "success");
        } catch (error) {
          showToast(error.message, "error");
          elements.resendClearButton.disabled = false;
        }
      }

      async function handleTestResendDiag(event) {
        event?.preventDefault();
        if (!elements.resendTestButtonDiag || !elements.resendTestEmail) return;
        const recipientEmail = elements.resendTestEmail.value.trim();
        if (!recipientEmail) {
          showToast("Please enter a recipient email address.", "error");
          if (elements.resendDiagOutput) {
            elements.resendDiagOutput.textContent = "Please enter a recipient email address.";
          }
          return;
        }
        elements.resendTestButtonDiag.disabled = true;
        if (elements.resendDiagOutput) {
          elements.resendDiagOutput.textContent = "Sending test email...";
        }
        try {
          const data = await fetchJson(`${API_BASE}/test/resend`, {
            method: "POST",
            body: JSON.stringify({ to: recipientEmail }),
          });
          let message = `Success: Test email sent to ${recipientEmail}`;
          if (data.emailId) {
            message += ` | Email ID: ${data.emailId}`;
          }
          if (elements.resendDiagOutput) {
            elements.resendDiagOutput.textContent = message;
          }
          showToast("Test email sent successfully.", "success");
        } catch (error) {
          if (elements.resendDiagOutput) {
            elements.resendDiagOutput.textContent = `Error: ${error.message}`;
          }
          showToast(error.message, "error");
        } finally {
          elements.resendTestButtonDiag.disabled = false;
        }
      }

      async function loadConfig() {
        await Promise.all([loadTmdbStatus(), loadResendStatus(), loadConfigSnapshot()]);
        setLastUpdated("configuration");
      }

      async function handleSaveTmdbToken(event) {
        event?.preventDefault();
        if (!elements.tmdbSaveButton || !elements.tmdbTokenInput) return;
        const token = elements.tmdbTokenInput.value.trim();
        if (!token) {
          showToast("Please enter a TMDb access token before saving.", "error");
          return;
        }
        elements.tmdbSaveButton.disabled = true;
        if (elements.tmdbTestButton) elements.tmdbTestButton.disabled = true;
        if (elements.tmdbClearButton) elements.tmdbClearButton.disabled = true;
        try {
          const data = await fetchJson(`${API_BASE}/tmdb`, {
            method: "POST",
            body: JSON.stringify({ token }),
          });
          elements.tmdbTokenInput.value = "";
          renderTmdbStatus(data.status);
          if (elements.tmdbTestOutput) {
            elements.tmdbTestOutput.textContent = "Token saved. Run a test to verify.";
          }
          showToast("TMDb token stored successfully.", "success");
        } catch (error) {
          showToast(error.message, "error");
        } finally {
          elements.tmdbSaveButton.disabled = false;
          if (elements.tmdbTestButton) elements.tmdbTestButton.disabled = false;
          if (elements.tmdbClearButton) {
            elements.tmdbClearButton.disabled = !state.tmdbStatus || !state.tmdbStatus.fromDatabase;
          }
        }
      }

      async function handleTestTmdbToken(event) {
        event?.preventDefault();
        if (!elements.tmdbTestButton) return;
        const token = elements.tmdbTokenInput ? elements.tmdbTokenInput.value.trim() : "";
        if (!token && !state.tmdbStatus?.enabled) {
          if (elements.tmdbTestOutput) {
            elements.tmdbTestOutput.textContent = "Enter a token or save one before running a test.";
          }
          showToast("Provide a token to run the TMDb test.", "error");
          return;
        }
        elements.tmdbTestButton.disabled = true;
        if (elements.tmdbTestOutput) {
          elements.tmdbTestOutput.textContent = "Testing token...";
        }
        try {
          const data = await fetchJson(`${API_BASE}/test/tmdb`, {
            method: "POST",
            body: JSON.stringify(token ? { token } : {}),
          });
          let message = `Success: ${data.message}`;
          if (typeof data.tokenPreview === "string" && data.tokenPreview) {
            message += ` (${data.tokenPreview})`;
          }
          if (typeof data.rateLimitRemaining === "number" && Number.isFinite(data.rateLimitRemaining)) {
            message += ` | Remaining budget: ${data.rateLimitRemaining}`;
          }
          if (elements.tmdbTestOutput) {
            elements.tmdbTestOutput.textContent = message;
          }
          showToast("TMDb token test succeeded.", "success");
        } catch (error) {
          if (elements.tmdbTestOutput) {
            elements.tmdbTestOutput.textContent = `Error: ${error.message}`;
          }
          showToast(error.message, "error");
        } finally {
          elements.tmdbTestButton.disabled = false;
        }
      }

      async function handleClearTmdbToken(event) {
        event?.preventDefault();
        if (!elements.tmdbClearButton) return;
        if (!state.tmdbStatus?.fromDatabase) {
          showToast("There is no stored TMDb token to remove.", "info");
          return;
        }
        elements.tmdbClearButton.disabled = true;
        try {
          const data = await fetchJson(`${API_BASE}/tmdb`, { method: "DELETE" });
          renderTmdbStatus(data.status);
          if (elements.tmdbTestOutput) {
            elements.tmdbTestOutput.textContent = "Stored token removed. Provide a token to test.";
          }
          showToast("Stored TMDb token removed.", "success");
        } catch (error) {
          showToast(error.message, "error");
          elements.tmdbClearButton.disabled = false;
        }
      }

      async function loadLogs() {
        elements.logView.innerHTML = `<div class="muted">Loading log buffer...</div>`;
        try {
          const params = new URLSearchParams();
          const limit = parseInt(elements.logLimit.value, 10);
          if (!Number.isNaN(limit)) {
            params.set("limit", String(limit));
          }
          const level = elements.logLevel.value;
          if (level) {
            params.set("level", level);
          }
          const data = await fetchJson(`${API_BASE}/logs?${params.toString()}`);
          const logs = data.logs || [];
          if (logs.length === 0) {
            elements.logView.textContent = "No logs available.";
          } else {
            elements.logView.innerHTML = logs.map(entry => {
              const context = entry.context ? `\n${JSON.stringify(entry.context, null, 2)}` : "";
              return `
                <div class="log-entry">
                  <span class="log-meta">${escapeHtml(entry.timestamp)}</span>
                  <span class="log-meta">${escapeHtml(entry.level)}</span>
                  ${escapeHtml(entry.message)}
                  ${context ? `<pre>${escapeHtml(context)}</pre>` : ""}
                </div>
              `;
            }).join("");
            elements.logView.scrollTop = elements.logView.scrollHeight;
          }
          const stats = data.stats || {};
          elements.logSummary.textContent = `entries ${stats.total ?? logs.length} | error ${stats.byLevel?.error ?? 0} | warn ${stats.byLevel?.warn ?? 0}`;
          setLastUpdated("logs");
        } catch (error) {
          elements.logView.innerHTML = `<div class="alert alert-error">${escapeHtml(error.message)}</div>`;
          throw error;
        }
      }

      async function handleClearLogs() {
        try {
          await fetchJson(`${API_BASE}/logs`, { method: "DELETE" });
          elements.logView.textContent = "Log buffer cleared.";
          elements.logSummary.textContent = "entries 0";
          showToast("Log buffer cleared", "info");
        } catch (error) {
          showToast(error.message, "error");
        }
      }

      async function runTautulliTest() {
        elements.tautulliButton.disabled = true;
        elements.tautulliOutput.textContent = "Testing Tautulli connection...";
        try {
          const data = await fetchJson(`${API_BASE}/test/tautulli`, { method: "POST" });
          elements.tautulliOutput.textContent = `Success: ${data.libraries ?? 0} libraries reachable.`;
          showToast("Tautulli test succeeded", "success");
        } catch (error) {
          elements.tautulliOutput.textContent = `Error: ${error.message}`;
          showToast(error.message, "error");
        } finally {
          elements.tautulliButton.disabled = false;
        }
      }

      async function runDbTest() {
        elements.dbButton.disabled = true;
        elements.dbOutput.textContent = "Checking database...";
        try {
          const data = await fetchJson(`${API_BASE}/test/database`, { method: "POST" });
          elements.dbOutput.textContent = `Success: ${data.recordCount ?? 0} records accessible.`;
          showToast("Database test succeeded", "success");
        } catch (error) {
          elements.dbOutput.textContent = `Error: ${error.message}`;
          showToast(error.message, "error");
        } finally {
          elements.dbButton.disabled = false;
        }
      }

      function bindEvents() {
        elements.navButtons.forEach(btn => {
          btn.addEventListener("click", () => switchView(btn.dataset.view));
        });
        if (elements.tmdbTestButton) elements.tmdbTestButton.disabled = true;
        if (elements.tmdbClearButton) elements.tmdbClearButton.disabled = true;
        if (elements.resendTestButton) elements.resendTestButton.disabled = true;
        if (elements.resendClearButton) elements.resendClearButton.disabled = true;
        elements.refreshButton.addEventListener("click", () => {
          const loader = viewLoaders[state.currentView];
          if (loader) {
            loader().catch(err => showToast(err.message, "error"));
          }
        });
        elements.autoToggle.addEventListener("change", event => setAutoRefresh(event.target.checked));
        elements.refreshLogs.addEventListener("click", () => loadLogs().catch(err => showToast(err.message, "error")));
        elements.clearLogs.addEventListener("click", handleClearLogs);
        elements.logLevel.addEventListener("change", () => loadLogs().catch(err => showToast(err.message, "error")));
        elements.logLimit.addEventListener("change", () => loadLogs().catch(err => showToast(err.message, "error")));
        elements.tautulliButton.addEventListener("click", runTautulliTest);
        elements.dbButton.addEventListener("click", runDbTest);
        if (elements.tmdbSaveButton) {
          elements.tmdbSaveButton.addEventListener("click", handleSaveTmdbToken);
        }
        if (elements.tmdbTestButton) {
          elements.tmdbTestButton.addEventListener("click", handleTestTmdbToken);
        }
        if (elements.tmdbClearButton) {
          elements.tmdbClearButton.addEventListener("click", handleClearTmdbToken);
        }
        if (elements.resendSaveButton) {
          elements.resendSaveButton.addEventListener("click", handleSaveResend);
        }
        if (elements.resendTestButton) {
          elements.resendTestButton.addEventListener("click", handleTestResend);
        }
        if (elements.resendClearButton) {
          elements.resendClearButton.addEventListener("click", handleClearResend);
        }
        if (elements.resendTestButtonDiag) {
          elements.resendTestButtonDiag.addEventListener("click", handleTestResendDiag);
        }
      }

      // Tautulli Sync Functions
      let availableLibraries = [];
      let selectedLibraryIds = new Set();

      async function loadAvailableLibraries() {
        try {
          const res = await fetch("/admin/api/tautulli/libraries");
          if (!res.ok) throw new Error(`HTTP ${res.status}: ${res.statusText}`);
          const data = await res.json();
          availableLibraries = data.libraries || [];
          renderLibraryList();
          showToast("Libraries loaded", "success");
        } catch (err) {
          showToast(err.message, "error");
        }
      }

      function renderLibraryList() {
        const container = document.getElementById("library-list");
        if (availableLibraries.length === 0) {
          container.innerHTML = '<div class="muted">No libraries found</div>';
          return;
        }
        container.innerHTML = availableLibraries.map(lib => `
          <label style="display: block; margin: 8px 0;">
            <input type="checkbox" value="${lib.sectionId}" class="library-checkbox"
              ${selectedLibraryIds.has(lib.sectionId) ? 'checked' : ''}>
            ${lib.friendlyName || lib.sectionName} (${lib.sectionType})
          </label>
        `).join('');
        document.querySelectorAll('.library-checkbox').forEach(cb => {
          cb.addEventListener('change', (e) => {
            const id = parseInt(e.target.value);
            if (e.target.checked) {
              selectedLibraryIds.add(id);
            } else {
              selectedLibraryIds.delete(id);
            }
            updateSelectedLibraries();
          });
        });
        updateSelectedLibraries();
      }

      function updateSelectedLibraries() {
        const container = document.getElementById('selected-libraries');
        const list = document.getElementById('selected-libraries-list');
        if (selectedLibraryIds.size === 0) {
          container.style.display = 'none';
          return;
        }
        container.style.display = 'block';
        const selected = availableLibraries.filter(lib => selectedLibraryIds.has(lib.sectionId));
        list.innerHTML = selected.map(lib =>
          `<div style="padding: 4px 0;">${lib.friendlyName || lib.sectionName} (${lib.sectionType})</div>`
        ).join('');
      }

      async function saveLibraryConfiguration() {
        try {
          console.log('selectedLibraryIds:', selectedLibraryIds);
          console.log('availableLibraries:', availableLibraries);
          const selected = availableLibraries.filter(lib => selectedLibraryIds.has(lib.sectionId));
          console.log('selected libraries:', selected);
          const payload = {
            sections: selected.map(lib => ({
              sectionId: lib.sectionId,
              sectionName: lib.sectionName,
              sectionType: lib.sectionType,
              enabled: true
            }))
          };
          console.log('Sending payload:', payload);
          const res = await fetch("/admin/api/tautulli/library-sections", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
          });
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          showToast("Library configuration saved", "success");
          await loadLibrarySections();
        } catch (err) {
          showToast(err.message, "error");
        }
      }

      async function loadLibrarySections() {
        try {
          const res = await fetch("/admin/api/tautulli/library-sections");
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          const data = await res.json();
          const container = document.getElementById("library-sections-list");
          if (!data.sections || data.sections.length === 0) {
            container.innerHTML = '<div class="muted">No libraries configured</div>';
            return;
          }
          container.innerHTML = data.sections.map(s => `
            <div style="padding: 8px; background: var(--color-surface); border-radius: 8px; margin: 4px 0;">
              <strong>${s.sectionName}</strong> (${s.sectionType}) - ${s.enabled ? 'Enabled' : 'Disabled'}
            </div>
          `).join('');
        } catch (err) {
          showToast(err.message, "error");
        }
      }

      async function startManualSync() {
        try {
          const incremental = document.getElementById("sync-incremental").checked;
          const enrichWithTmdb = document.getElementById("sync-tmdb").checked;
          const syncCovers = document.getElementById("sync-covers").checked;

          const res = await fetch("/admin/api/tautulli/sync/manual", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ incremental, enrichWithTmdb, syncCovers })
          });
          if (!res.ok) throw new Error(`HTTP ${res.status}`);

          document.getElementById("sync-status").textContent = "Sync im Hintergrund gestartet. Prüfen Sie die Logs für den Fortschritt.";
          showToast("Sync started", "success");
        } catch (err) {
          showToast(err.message, "error");
        }
      }

      async function saveSchedule() {
        try {
          const jobType = document.getElementById("schedule-job-type").value;
          const cronExpression = document.getElementById("schedule-cron").value;
          const enabled = document.getElementById("schedule-enabled").checked;

          const res = await fetch("/admin/api/tautulli/sync/schedules", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ jobType, cronExpression, enabled })
          });
          if (!res.ok) throw new Error(`HTTP ${res.status}`);

          showToast("Schedule saved", "success");
          await loadSchedules();
        } catch (err) {
          showToast(err.message, "error");
        }
      }

      async function loadSchedules() {
        try {
          const res = await fetch("/admin/api/tautulli/sync/schedules");
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          const data = await res.json();
          const container = document.getElementById("schedules-list");
          if (!data.schedules || data.schedules.length === 0) {
            container.innerHTML = '<div class="muted">No schedules configured</div>';
            return;
          }
          container.innerHTML = data.schedules.map(s => `
            <div style="padding: 8px; background: var(--color-surface); border-radius: 8px; margin: 4px 0;">
              <strong>${s.jobType}</strong>: ${s.cronExpression} - ${s.enabled ? 'Enabled' : 'Disabled'}
              ${s.lastRunAt ? `<br><small>Last run: ${new Date(s.lastRunAt).toLocaleString()}</small>` : ''}
            </div>
          `).join('');
        } catch (err) {
          showToast(err.message, "error");
        }
      }

      async function loadTautulliConfig() {
        try {
          const res = await fetch("/admin/api/tautulli/config");
          const data = await res.json();

          if (data.configured) {
            document.getElementById("tautulli-url").value = data.tautulliUrl || "";
            document.getElementById("tautulli-config-status").textContent =
              "Configuration loaded. API Key is set.";
            document.getElementById("tautulli-config-status").classList.remove("error");
          } else {
            document.getElementById("tautulli-config-status").textContent =
              "No configuration found. Please enter Tautulli URL and API Key.";
            document.getElementById("tautulli-config-status").classList.add("muted");
          }
        } catch (err) {
          document.getElementById("tautulli-config-status").textContent =
            "Failed to load configuration: " + err.message;
          document.getElementById("tautulli-config-status").classList.add("error");
        }
      }

      async function saveTautulliConfig() {
        const url = document.getElementById("tautulli-url").value.trim();
        const apiKey = document.getElementById("tautulli-api-key").value.trim();
        const statusEl = document.getElementById("tautulli-config-status");

        if (!url || !apiKey) {
          statusEl.textContent = "Please enter both Tautulli URL and API Key";
          statusEl.classList.add("error");
          return;
        }

        try {
          statusEl.textContent = "Saving configuration...";
          statusEl.classList.remove("error");

          const res = await fetch("/admin/api/tautulli/config", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ tautulliUrl: url, apiKey }),
          });

          if (!res.ok) {
            const errData = await res.json();
            throw new Error(errData.message || "Failed to save configuration");
          }

          const data = await res.json();
          statusEl.textContent = "Configuration saved successfully!";
          statusEl.classList.remove("error");

          // Clear API key input for security
          document.getElementById("tautulli-api-key").value = "";

          showToast("Tautulli configuration saved", "success");
        } catch (err) {
          statusEl.textContent = "Failed to save: " + err.message;
          statusEl.classList.add("error");
          showToast(err.message, "error");
        }
      }

      async function testTautulliConnection() {
        const url = document.getElementById("tautulli-url").value.trim();
        const apiKey = document.getElementById("tautulli-api-key").value.trim();
        const statusEl = document.getElementById("tautulli-config-status");

        try {
          statusEl.textContent = "Testing connection...";
          statusEl.classList.remove("error");

          const body = url && apiKey ? { tautulliUrl: url, apiKey } : {};

          const res = await fetch("/admin/api/tautulli/config/test", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(body),
          });

          if (!res.ok) {
            const errData = await res.json();
            throw new Error(errData.message || "Connection test failed");
          }

          const data = await res.json();
          statusEl.textContent = `Connection successful! Found ${data.libraryCount} libraries.`;
          statusEl.classList.remove("error");
          showToast("Connection test successful", "success");
        } catch (err) {
          statusEl.textContent = "Connection test failed: " + err.message;
          statusEl.classList.add("error");
          showToast(err.message, "error");
        }
      }

      function bindTautulliSyncEvents() {
        const btnSaveConfig = document.getElementById("btn-save-tautulli-config");
        const btnTestConnection = document.getElementById("btn-test-connection");
        const showApiKeyCheckbox = document.getElementById("show-api-key");
        const apiKeyInput = document.getElementById("tautulli-api-key");
        const btnLoadLibs = document.getElementById("btn-load-libraries");
        const btnSaveLibs = document.getElementById("btn-save-libraries");
        const btnStartSync = document.getElementById("btn-start-sync");
        const btnSaveSchedule = document.getElementById("btn-save-schedule");

        if (btnSaveConfig) btnSaveConfig.addEventListener("click", saveTautulliConfig);
        if (btnTestConnection) btnTestConnection.addEventListener("click", testTautulliConnection);
        if (showApiKeyCheckbox) {
          showApiKeyCheckbox.addEventListener("change", (e) => {
            apiKeyInput.type = e.target.checked ? "text" : "password";
          });
        }
        if (btnLoadLibs) btnLoadLibs.addEventListener("click", loadAvailableLibraries);
        if (btnSaveLibs) btnSaveLibs.addEventListener("click", saveLibraryConfiguration);
        if (btnStartSync) btnStartSync.addEventListener("click", startManualSync);
        if (btnSaveSchedule) btnSaveSchedule.addEventListener("click", saveSchedule);
      }

      function init() {
        bindEvents();
        bindTautulliSyncEvents();
        const stored = localStorage.getItem("admin:autoRefresh") === "1";
        setAutoRefresh(stored);
        loadDashboard().catch(err => showToast(err.message, "error"));
        loadLibrarySections().catch(() => {});
        loadSchedules().catch(() => {});
      }

      window.addEventListener("visibilitychange", () => {
        if (document.visibilityState === "visible" && state.autoRefresh && !state.autoTimer) {
          setAutoRefresh(true);
        }
      });

      init();
    })();
  </script>
</body>
</html>

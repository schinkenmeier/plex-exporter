<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Plex Exporter Admin</title>
  <style>
    :root {
      --color-bg: #13161b;
      --color-surface: #1b1f26;
      --color-panel: #212631;
      --color-border: #2c323f;
      --color-text: #f5f6f9;
      --color-muted: #9aa6b8;
      --color-accent: #e5a00d;
      --color-accent-strong: #f5bb39;
      --color-success: #46d369;
      --color-danger: #ef5b5b;
      --color-info: #38bdf8;
      --radius: 12px;
      --radius-sm: 8px;
      --transition: 0.18s ease-in-out;
      font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      background: radial-gradient(circle at top left, rgba(229, 160, 13, 0.08), var(--color-bg));
      color: var(--color-text);
      min-height: 100vh;
      display: flex;
    }

    a {
      color: var(--color-accent);
    }

    .app-shell {
      display: flex;
      width: 100%;
      min-height: 100vh;
    }

    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      z-index: 50;
      pointer-events: none;
    }

    .toast {
      background: rgba(15, 17, 21, 0.92);
      border-radius: var(--radius-sm);
      border: 1px solid rgba(255, 255, 255, 0.08);
      padding: 12px 16px;
      min-width: 220px;
      max-width: 320px;
      color: var(--color-text);
      box-shadow: 0 18px 32px rgba(0, 0, 0, 0.28);
      opacity: 0;
      transform: translateY(-8px);
      transition: opacity 0.2s ease, transform 0.2s ease;
      pointer-events: auto;
    }

    .toast.show {
      opacity: 1;
      transform: translateY(0);
    }

    .toast-success { border-left: 3px solid var(--color-success); }
    .toast-error { border-left: 3px solid var(--color-danger); }
    .toast-info { border-left: 3px solid var(--color-accent); }

    .sidebar {
      width: 240px;
      background: linear-gradient(180deg, rgba(16, 17, 20, 0.95), rgba(16, 17, 20, 0.88));
      border-right: 1px solid rgba(255, 255, 255, 0.04);
      padding: 28px 22px;
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    .brand {
      margin: 0;
      font-size: 20px;
      font-weight: 700;
      letter-spacing: 0.04em;
      text-transform: uppercase;
    }

    .brand-sub {
      margin: 0;
      color: var(--color-muted);
      font-size: 13px;
      letter-spacing: 0.05em;
      text-transform: uppercase;
    }

    .nav-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .nav-button {
      border: none;
      background: transparent;
      color: var(--color-muted);
      font-weight: 600;
      letter-spacing: 0.01em;
      padding: 10px 14px;
      border-radius: var(--radius-sm);
      text-align: left;
      cursor: pointer;
      transition: background var(--transition), color var(--transition), transform var(--transition);
    }

    .nav-button:hover {
      color: var(--color-text);
      transform: translateX(4px);
    }

    .nav-button.active {
      background: rgba(229, 160, 13, 0.16);
      color: var(--color-text);
      box-shadow: 0 8px 24px rgba(229, 160, 13, 0.18);
    }

    .sidebar-footer {
      margin-top: auto;
      display: flex;
      flex-direction: column;
      gap: 10px;
      font-size: 13px;
      color: var(--color-muted);
    }

    .auto-toggle {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
    }

    .auto-toggle input {
      width: 42px;
      height: 24px;
      border-radius: 12px;
      appearance: none;
      background: rgba(255, 255, 255, 0.12);
      position: relative;
      transition: background 0.2s ease;
    }

    .auto-toggle input::after {
      content: "";
      position: absolute;
      top: 3px;
      left: 4px;
      width: 18px;
      height: 18px;
      border-radius: 9px;
      background: #0d0f13;
      transition: transform 0.2s ease;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.45);
    }

    .auto-toggle input:checked {
      background: linear-gradient(135deg, var(--color-accent), var(--color-accent-strong));
    }

    .auto-toggle input:checked::after {
      transform: translateX(18px);
    }

    .main {
      flex: 1;
      padding: 32px 40px;
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    .page-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      flex-wrap: wrap;
      gap: 16px;
    }

    .page-header h2 {
      margin: 0;
      font-size: 26px;
      letter-spacing: -0.01em;
    }

    .page-header p {
      margin: 6px 0 0;
      color: var(--color-muted);
      font-size: 14px;
      max-width: 520px;
    }

    .header-actions {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }

    button {
      font-family: inherit;
      font-size: 14px;
      font-weight: 600;
      border: none;
      border-radius: var(--radius-sm);
      padding: 10px 16px;
      cursor: pointer;
      transition: transform 0.15s ease, box-shadow 0.2s ease, background 0.2s ease;
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .btn {
      background: rgba(255, 255, 255, 0.06);
      color: var(--color-text);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .btn:hover:not(:disabled) {
      transform: translateY(-1px);
      border-color: rgba(229, 160, 13, 0.5);
      box-shadow: 0 10px 18px rgba(229, 160, 13, 0.14);
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--color-accent), var(--color-accent-strong));
      color: #0d0f13;
      border: none;
    }

    .btn-danger {
      background: linear-gradient(135deg, #ff6b6b, var(--color-danger));
      color: #0d0f13;
    }

    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(190px, 1fr));
      gap: 16px;
    }

    .metric-card {
      background: linear-gradient(135deg, rgba(229, 160, 13, 0.1), rgba(27, 31, 38, 0.95));
      border-radius: var(--radius);
      border: 1px solid rgba(229, 160, 13, 0.2);
      padding: 18px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      box-shadow: 0 16px 32px rgba(229, 160, 13, 0.12);
    }

    .metric-card h3 {
      margin: 0;
      font-size: 14px;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      color: rgba(255, 255, 255, 0.75);
    }

    .metric-value {
      font-size: 34px;
      font-weight: 700;
    }

    .metric-sub {
      margin-top: auto;
      font-size: 13px;
      color: rgba(255, 255, 255, 0.7);
    }

    .panel-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 16px;
    }

    .panel {
      background: var(--color-panel);
      border-radius: var(--radius);
      border: 1px solid rgba(255, 255, 255, 0.05);
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 16px;
      box-shadow: 0 16px 30px rgba(0, 0, 0, 0.22);
    }

    .panel header {
      display: flex;
      justify-content: space-between;
      gap: 16px;
      align-items: flex-start;
    }

    .panel header h3 {
      margin: 0;
      font-size: 18px;
    }

    .panel header span {
      color: var(--color-muted);
      font-size: 13px;
    }

    .info-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
      font-size: 14px;
    }

    .info-item {
      display: flex;
      justify-content: space-between;
      gap: 12px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      padding-bottom: 8px;
    }

    .info-item:last-child {
      border-bottom: none;
      padding-bottom: 0;
    }

    .label {
      color: var(--color-muted);
      font-weight: 500;
    }

    .value {
      color: var(--color-text);
      font-weight: 600;
    }

    .chip {
      display: inline-flex;
      align-items: center;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 600;
      letter-spacing: 0.05em;
      text-transform: uppercase;
    }

    .chip-success {
      background: rgba(70, 211, 105, 0.15);
      color: var(--color-success);
    }

    .chip-danger {
      background: rgba(239, 91, 91, 0.15);
      color: var(--color-danger);
    }

    .chip-info {
      background: rgba(56, 189, 248, 0.18);
      color: var(--color-info);
    }

    .view {
      display: none;
      flex-direction: column;
      gap: 24px;
    }

    .view.active {
      display: flex;
    }

    .card {
      background: var(--color-panel);
      border-radius: var(--radius);
      border: 1px solid rgba(255, 255, 255, 0.05);
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 18px;
      box-shadow: 0 16px 28px rgba(0, 0, 0, 0.2);
    }

    .card h3 {
      margin: 0;
      font-size: 18px;
    }

    .card p {
      margin: 0;
      color: var(--color-muted);
      font-size: 14px;
    }

    .option-list {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 12px;
    }

    .checkbox {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      background: rgba(255, 255, 255, 0.04);
      border-radius: var(--radius-sm);
      border: 1px solid rgba(255, 255, 255, 0.07);
      font-size: 13px;
    }

    .checkbox input {
      width: 16px;
      height: 16px;
    }

    .button-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    .input-stack {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-top: 16px;
    }

    .input-stack input {
      padding: 10px 12px;
      border-radius: var(--radius-sm);
      border: 1px solid rgba(255, 255, 255, 0.1);
      background: rgba(255, 255, 255, 0.03);
      color: var(--color-text);
      font-size: 14px;
    }

    .input-stack input::placeholder {
      color: var(--color-muted);
    }

    .log-view {
      background: #101217;
      border-radius: var(--radius-sm);
      border: 1px solid rgba(255, 255, 255, 0.06);
      padding: 14px;
      font-family: "JetBrains Mono", "Fira Code", Consolas, monospace;
      font-size: 13px;
      line-height: 1.5;
      max-height: 280px;
      overflow: auto;
      white-space: pre-wrap;
    }

    .log-entry {
      margin: 0;
      padding: 5px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.04);
    }

    .log-entry:last-child {
      border-bottom: none;
    }

    .log-meta {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      margin-right: 12px;
      color: var(--color-muted);
    }

    .muted {
      color: var(--color-muted);
      font-size: 13px;
    }

    label.input-label {
      font-size: 13px;
      font-weight: 600;
      color: var(--color-muted);
    }

    input[type="text"],
    input[type="email"],
    input[type="number"],
    select {
      width: 100%;
      background: #151820;
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: var(--radius-sm);
      padding: 10px 12px;
      color: var(--color-text);
      font-family: inherit;
      font-size: 14px;
    }

    input:focus,
    select:focus {
      outline: none;
      border-color: rgba(229, 160, 13, 0.6);
      box-shadow: 0 0 0 3px rgba(229, 160, 13, 0.18);
    }

    details {
      background: rgba(255, 255, 255, 0.04);
      border-radius: var(--radius-sm);
      padding: 10px 14px;
      border: 1px solid rgba(255, 255, 255, 0.05);
      font-size: 13px;
    }

    details summary {
      cursor: pointer;
      font-weight: 600;
    }

    details pre {
      margin-top: 12px;
      background: #0f1116;
      border-radius: var(--radius-sm);
      padding: 12px;
      border: 1px solid rgba(255, 255, 255, 0.06);
      max-height: 320px;
      overflow: auto;
      color: var(--color-text);
    }

    .alert {
      border-radius: var(--radius-sm);
      padding: 12px 14px;
      font-size: 14px;
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .alert-info {
      background: rgba(56, 189, 248, 0.15);
      border: 1px solid rgba(56, 189, 248, 0.35);
      color: var(--color-info);
    }

    .alert-error {
      background: rgba(239, 91, 91, 0.16);
      border: 1px solid rgba(239, 91, 91, 0.35);
      color: var(--color-danger);
    }

    @media (max-width: 980px) {
      body {
        flex-direction: column;
      }

      .sidebar {
        width: 100%;
        height: auto;
        flex-direction: row;
        align-items: center;
        gap: 18px;
        overflow-x: auto;
      }

      .nav-list {
        flex-direction: row;
      }

      .sidebar-footer {
        display: none;
      }

      .main {
        padding: 24px;
      }
    }

    @media (max-width: 640px) {
      .main {
        padding: 18px;
      }

      .metrics-grid,
      .panel-grid,
      .option-list {
        grid-template-columns: 1fr;
      }

      .button-row {
        flex-direction: column;
        align-items: stretch;
      }

      .page-header {
        flex-direction: column;
        align-items: stretch;
      }
    }
  </style>
</head>
<body>
  <div class="toast-container" id="toast-container"></div>
  <div class="app-shell">
    <aside class="sidebar">
      <div>
        <h1 class="brand">Plex Exporter</h1>
        <p class="brand-sub">Admin control center</p>
      </div>
      <nav class="nav-list">
        <button class="nav-button active" data-view="dashboard">Dashboard</button>
        <button class="nav-button" data-view="import">Imports</button>
        <button class="nav-button" data-view="config">Configuration</button>
        <button class="nav-button" data-view="logs">Logs</button>
        <button class="nav-button" data-view="diagnostics">Diagnostics</button>
      </nav>
      <div class="sidebar-footer">
        <label class="auto-toggle">
          <input type="checkbox" id="auto-refresh-toggle">
          Auto refresh
        </label>
        <div>
          <div>Last update</div>
          <div id="last-updated">not loaded yet</div>
        </div>
      </div>
    </aside>
    <main class="main">
      <header class="page-header">
        <div>
          <h2>Admin dashboard</h2>
          <p id="header-text">System overview, import control and service status in one place.</p>
        </div>
        <div class="header-actions">
          <span class="muted" id="auto-refresh-label">auto refresh off</span>
          <button class="btn" id="refresh-button">Refresh view</button>
        </div>
      </header>

      <section class="view active" id="view-dashboard">
        <div class="metrics-grid">
          <article class="metric-card">
            <h3>Total media</h3>
            <div class="metric-value" id="stat-total-media">-</div>
            <div class="metric-sub">Movies <span id="stat-movie-count">-</span> | Shows <span id="stat-show-count">-</span></div>
          </article>
          <article class="metric-card">
            <h3>Series structure</h3>
            <div class="metric-value" id="stat-season-count">-</div>
            <div class="metric-sub">Episodes <span id="stat-episode-count">-</span> | Cast <span id="stat-cast-count">-</span></div>
          </article>
          <article class="metric-card">
            <h3>Thumbnails</h3>
            <div class="metric-value" id="stat-thumb-total">-</div>
            <div class="metric-sub">Combined media artwork count</div>
          </article>
          <article class="metric-card">
            <h3>Database size</h3>
            <div class="metric-value" id="stat-db-size">-</div>
            <div class="metric-sub" id="stat-db-path">path unknown</div>
          </article>
          <article class="metric-card">
            <h3>Uptime</h3>
            <div class="metric-value" id="stat-uptime">-</div>
            <div class="metric-sub">PID <span id="stat-pid">-</span> | Node <span id="stat-node">-</span></div>
          </article>
        </div>

        <div class="panel-grid">
          <article class="panel">
            <header>
              <div>
                <h3>System status</h3>
                <span>Runtime, memory and host details</span>
              </div>
              <div id="system-status-chip"></div>
            </header>
            <div class="info-list" id="system-status">
              <div class="muted">Loading system status...</div>
            </div>
          </article>
          <article class="panel">
            <header>
              <div>
                <h3>Services</h3>
                <span>TMDB, Tautulli, API auth</span>
              </div>
            </header>
            <div class="info-list" id="service-status">
              <div class="muted">Loading service configuration...</div>
            </div>
          </article>
          <article class="panel">
            <header>
              <div>
                <h3>Series samples</h3>
                <span>Recently indexed series with seasons and cast preview</span>
              </div>
            </header>
            <div class="info-list" id="series-overview">
              <div class="muted">Loading series overview...</div>
            </div>
          </article>
        </div>
      </section>

      <section class="view" id="view-import">
        <article class="card">
          <div>
            <h3>Import control</h3>
            <p>Trigger and monitor library imports based on the export JSON data.</p>
          </div>
          <div class="option-list">
            <label class="checkbox"><input type="checkbox" id="opt-dry-run">Dry run (no database writes)</label>
            <label class="checkbox"><input type="checkbox" id="opt-force">Force overwrite existing entries</label>
            <label class="checkbox"><input type="checkbox" id="opt-verbose">Verbose logging</label>
            <label class="checkbox"><input type="checkbox" id="opt-movies">Import movies only</label>
            <label class="checkbox"><input type="checkbox" id="opt-shows">Import shows only</label>
          </div>
          <div class="button-row">
            <button class="btn-primary" id="btn-start-import">Start import</button>
            <button class="btn-danger" id="btn-stop-import" disabled>Stop import</button>
            <button class="btn" id="btn-refresh-import">Refresh status</button>
            <button class="btn" id="btn-clear-import-logs">Clear logs</button>
          </div>
          <div id="import-message"></div>
          <div class="panel">
            <header>
              <div>
                <h3>Current status</h3>
                <span>Running process details</span>
              </div>
            </header>
            <div class="info-list" id="import-status">
              <div class="muted">No status loaded yet.</div>
            </div>
          </div>
          <div class="panel">
            <header>
              <div>
                <h3>Import log</h3>
                <span>Latest console output</span>
              </div>
            </header>
            <div class="log-view" id="import-logs">No log output yet.</div>
          </div>
        </article>
      </section>

      <section class="view" id="view-config">
        <article class="card">
          <div>
            <h3>TMDb integration</h3>
            <p>Manage the TMDb API token used for hero enrichment and artwork fetching.</p>
          </div>
          <div class="input-stack">
            <label class="input-label" for="tmdb-token-input">TMDb access token</label>
            <input id="tmdb-token-input" type="password" autocomplete="off" placeholder="TMDb v4 API Read Access Token">
            <div class="muted" id="tmdb-token-status">Loading TMDb status…</div>
            <div class="button-row">
              <button class="btn btn-primary" id="btn-save-tmdb">Save token</button>
              <button class="btn" id="btn-test-tmdb">Test token</button>
              <button class="btn btn-danger" id="btn-clear-tmdb">Remove token</button>
            </div>
            <div class="muted" id="tmdb-test-output">No test executed yet.</div>
          </div>
        </article>
        <article class="card">
          <div>
            <h3>Resend email configuration</h3>
            <p>Manage email delivery settings using Resend for watchlist emails, welcome emails and newsletters.</p>
          </div>
          <div class="input-stack">
            <label class="input-label" for="resend-api-key-input">Resend API key</label>
            <input id="resend-api-key-input" type="password" autocomplete="off" placeholder="re_xxxxxxxxxxxxx">
            <label class="input-label" for="resend-from-email-input">From email address</label>
            <input id="resend-from-email-input" type="email" autocomplete="off" placeholder="no-reply@example.com">
            <div class="muted" id="resend-status">Loading Resend status…</div>
            <div class="button-row">
              <button class="btn btn-primary" id="btn-save-resend">Save configuration</button>
              <button class="btn" id="btn-test-resend">Send test email</button>
              <button class="btn btn-danger" id="btn-clear-resend">Remove configuration</button>
            </div>
            <div class="muted" id="resend-test-output">No test executed yet.</div>
          </div>
        </article>
        <article class="card">
          <div>
            <h3>Configuration snapshot</h3>
            <p>Current backend configuration (sensitive values are masked).</p>
          </div>
          <div id="config-view">
            <div class="muted">Loading configuration...</div>
          </div>
        </article>
      </section>

      <section class="view" id="view-logs">
        <article class="card">
          <div>
            <h3>Runtime logs</h3>
            <p>Recent entries from the in-memory log buffer.</p>
          </div>
          <div class="button-row">
            <label class="input-label" for="log-level">Level</label>
            <select id="log-level">
              <option value="">all levels</option>
              <option value="debug">debug</option>
              <option value="info">info</option>
              <option value="warn">warn</option>
              <option value="error">error</option>
            </select>
            <label class="input-label" for="log-limit">Limit</label>
            <input type="number" id="log-limit" min="10" max="500" value="150">
            <button class="btn" id="btn-refresh-logs">Refresh</button>
            <button class="btn" id="btn-clear-logs">Clear logs</button>
          </div>
          <div class="muted" id="log-summary">No logs loaded yet.</div>
          <div class="log-view" id="log-view">Press refresh to load logs.</div>
        </article>
      </section>

      <section class="view" id="view-diagnostics">
        <div class="panel-grid">
          <article class="panel">
            <header>
              <div>
                <h3>Tautulli test</h3>
                <span>Check API connectivity and list libraries.</span>
              </div>
            </header>
            <div class="info-list">
              <button class="btn" id="btn-test-tautulli">Run test</button>
              <div class="muted" id="tautulli-output">No test executed yet.</div>
            </div>
          </article>
          <article class="panel">
            <header>
              <div>
                <h3>Database test</h3>
                <span>Verify SQLite access and record count.</span>
              </div>
            </header>
            <div class="info-list">
              <button class="btn" id="btn-test-db">Run test</button>
              <div class="muted" id="db-output">No test executed yet.</div>
            </div>
          </article>
          <article class="panel">
            <header>
              <div>
                <h3>Resend email test</h3>
                <span>Send a test email to verify Resend configuration.</span>
              </div>
            </header>
            <div class="info-list">
              <label class="input-label" for="resend-test-email">Test recipient email</label>
              <input type="email" id="resend-test-email" placeholder="test@example.com">
              <button class="btn" id="btn-test-resend-diag">Send test email</button>
              <div class="muted" id="resend-diag-output">No test executed yet.</div>
            </div>
          </article>
        </div>
      </section>
    </main>
  </div>
  <script>
    (() => {
      const API_BASE = "/admin/api";
      const DASHBOARD_INTERVAL = 30000;
      const toastRoot = document.getElementById("toast-container");

      const elements = {
        navButtons: Array.from(document.querySelectorAll(".nav-button")),
        views: {
          dashboard: document.getElementById("view-dashboard"),
          import: document.getElementById("view-import"),
          config: document.getElementById("view-config"),
          logs: document.getElementById("view-logs"),
          diagnostics: document.getElementById("view-diagnostics"),
        },
        refreshButton: document.getElementById("refresh-button"),
        autoToggle: document.getElementById("auto-refresh-toggle"),
        autoLabel: document.getElementById("auto-refresh-label"),
        lastUpdated: document.getElementById("last-updated"),
        headerText: document.getElementById("header-text"),
        statTotalMedia: document.getElementById("stat-total-media"),
        statMovieCount: document.getElementById("stat-movie-count"),
        statShowCount: document.getElementById("stat-show-count"),
        statSeasonCount: document.getElementById("stat-season-count"),
        statEpisodeCount: document.getElementById("stat-episode-count"),
        statCastCount: document.getElementById("stat-cast-count"),
        statThumbTotal: document.getElementById("stat-thumb-total"),
        statDbSize: document.getElementById("stat-db-size"),
        statDbPath: document.getElementById("stat-db-path"),
        statUptime: document.getElementById("stat-uptime"),
        statPid: document.getElementById("stat-pid"),
        statNode: document.getElementById("stat-node"),
        systemStatusChip: document.getElementById("system-status-chip"),
        systemStatus: document.getElementById("system-status"),
        serviceStatus: document.getElementById("service-status"),
        seriesOverview: document.getElementById("series-overview"),
        importMessage: document.getElementById("import-message"),
        importStatus: document.getElementById("import-status"),
        importLogs: document.getElementById("import-logs"),
        startImport: document.getElementById("btn-start-import"),
        stopImport: document.getElementById("btn-stop-import"),
        refreshImport: document.getElementById("btn-refresh-import"),
        clearImportLogs: document.getElementById("btn-clear-import-logs"),
        optDryRun: document.getElementById("opt-dry-run"),
        optForce: document.getElementById("opt-force"),
        optVerbose: document.getElementById("opt-verbose"),
        optMovies: document.getElementById("opt-movies"),
        optShows: document.getElementById("opt-shows"),
        configView: document.getElementById("config-view"),
        tmdbTokenInput: document.getElementById("tmdb-token-input"),
        tmdbTokenStatus: document.getElementById("tmdb-token-status"),
        tmdbSaveButton: document.getElementById("btn-save-tmdb"),
        tmdbTestButton: document.getElementById("btn-test-tmdb"),
        tmdbClearButton: document.getElementById("btn-clear-tmdb"),
        tmdbTestOutput: document.getElementById("tmdb-test-output"),
        resendApiKeyInput: document.getElementById("resend-api-key-input"),
        resendFromEmailInput: document.getElementById("resend-from-email-input"),
        resendStatus: document.getElementById("resend-status"),
        resendSaveButton: document.getElementById("btn-save-resend"),
        resendTestButton: document.getElementById("btn-test-resend"),
        resendClearButton: document.getElementById("btn-clear-resend"),
        resendTestOutput: document.getElementById("resend-test-output"),
        resendTestEmail: document.getElementById("resend-test-email"),
        resendTestButtonDiag: document.getElementById("btn-test-resend-diag"),
        resendDiagOutput: document.getElementById("resend-diag-output"),
        logView: document.getElementById("log-view"),
        logSummary: document.getElementById("log-summary"),
        logLevel: document.getElementById("log-level"),
        logLimit: document.getElementById("log-limit"),
        refreshLogs: document.getElementById("btn-refresh-logs"),
        clearLogs: document.getElementById("btn-clear-logs"),
        tautulliOutput: document.getElementById("tautulli-output"),
        tautulliButton: document.getElementById("btn-test-tautulli"),
        dbOutput: document.getElementById("db-output"),
        dbButton: document.getElementById("btn-test-db"),
      };

      const state = {
        currentView: "dashboard",
        autoRefresh: false,
        autoTimer: null,
        importTimer: null,
        importPollCount: 0,
        tmdbStatus: null,
        resendStatus: null,
      };

      const viewDescriptions = {
        dashboard: "System overview, import control and service status in one place.",
        import: "Control the import worker and inspect the latest console output.",
        config: "Manage TMDb credentials and inspect the backend configuration snapshot.",
        logs: "Inspect the in-memory log buffer. Useful for quick diagnostics.",
        diagnostics: "Connectivity checks for Tautulli and database services.",
      };

      const viewLoaders = {
        dashboard: loadDashboard,
        import: loadImportView,
        config: loadConfig,
        logs: loadLogs,
        diagnostics: async () => {},
      };

      function escapeHtml(value) {
        return String(value)
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#39;");
      }

      async function fetchJson(url, options) {
        const config = Object.assign({ headers: {} }, options);
        if (config.body && !config.headers["Content-Type"]) {
          config.headers["Content-Type"] = "application/json";
        }
        const response = await fetch(url, config);
        const text = await response.text();
        let data = {};
        if (text) {
          try {
            data = JSON.parse(text);
          } catch {
            data = { message: text };
          }
        }
        if (!response.ok) {
          const message = data.message || data.error || response.statusText || "request failed";
          throw new Error(message);
        }
        return data;
      }

      function showToast(message, type = "info", timeout = 3200) {
        const toast = document.createElement("div");
        toast.className = `toast toast-${type}`;
        toast.textContent = message;
        toastRoot.appendChild(toast);
        requestAnimationFrame(() => toast.classList.add("show"));
        setTimeout(() => {
          toast.classList.remove("show");
          setTimeout(() => toast.remove(), 200);
        }, timeout);
      }

      function setLastUpdated(source) {
        const ts = new Date().toLocaleTimeString("de-DE");
        elements.lastUpdated.textContent = `${source} | ${ts}`;
      }

      function updateHeader(view) {
        elements.headerText.textContent = viewDescriptions[view] || viewDescriptions.dashboard;
      }

      function switchView(view) {
        if (!elements.views[view]) {
          return;
        }
        state.currentView = view;
        elements.navButtons.forEach(btn => {
          btn.classList.toggle("active", btn.dataset.view === view);
        });
        Object.entries(elements.views).forEach(([name, node]) => {
          node.classList.toggle("active", name === view);
        });
        updateHeader(view);
        const loader = viewLoaders[view];
        if (typeof loader === "function") {
          loader().catch(err => {
            console.error(err);
            showToast(`Failed to load ${view}: ${err.message}`, "error");
          });
        }
      }

      function setAutoRefresh(enabled) {
        if (state.autoTimer) {
          clearInterval(state.autoTimer);
          state.autoTimer = null;
        }
        state.autoRefresh = enabled;
        elements.autoToggle.checked = enabled;
        elements.autoLabel.textContent = enabled ? "auto refresh every 30s" : "auto refresh off";
        localStorage.setItem("admin:autoRefresh", enabled ? "1" : "0");
        if (enabled) {
          state.autoTimer = setInterval(() => {
            if (state.currentView === "dashboard") {
              loadDashboard().catch(err => console.error(err));
            }
          }, DASHBOARD_INTERVAL);
        }
      }

      async function loadDashboard() {
        elements.systemStatus.innerHTML = `<div class="muted">Loading system status...</div>`;
        elements.serviceStatus.innerHTML = `<div class="muted">Loading service configuration...</div>`;
        elements.seriesOverview.innerHTML = `<div class="muted">Loading series overview...</div>`;
        try {
          const [status, stats, config] = await Promise.all([
            fetchJson(`${API_BASE}/status`),
            fetchJson(`${API_BASE}/stats`),
            fetchJson(`${API_BASE}/config`),
          ]);
          renderStats(stats);
          renderSeriesOverview(stats.seriesSamples || []);
          renderSystemStatus(status);
          renderServiceStatus(config);
          setLastUpdated("dashboard");
        } catch (error) {
          elements.systemStatus.innerHTML = `<div class="alert alert-error">${escapeHtml(error.message)}</div>`;
          elements.serviceStatus.innerHTML = `<div class="alert alert-error">${escapeHtml(error.message)}</div>`;
          renderSeriesOverview([]);
          throw error;
        }
      }

      function renderStats(stats) {
        const media = stats.media || {};
        const thumbs = stats.thumbnails || {};
        const db = stats.database || {};
        const cast = stats.cast || {};
        elements.statTotalMedia.textContent = media.total ?? "-";
        elements.statMovieCount.textContent = media.movies ?? "-";
        elements.statShowCount.textContent = media.series ?? "-";
        elements.statSeasonCount.textContent = media.seasons ?? "-";
        elements.statEpisodeCount.textContent = media.episodes ?? "-";
        elements.statCastCount.textContent = cast.members ?? "-";
        elements.statThumbTotal.textContent = thumbs.total ?? "-";
        elements.statDbSize.textContent = db.size ?? "-";
        elements.statDbPath.textContent = db.path ?? "path unknown";
      }

      function renderSystemStatus(status) {
        if (!status || status.status !== "ok") {
          elements.systemStatusChip.innerHTML = `<span class="chip chip-danger">error</span>`;
        } else {
          elements.systemStatusChip.innerHTML = `<span class="chip chip-success">online</span>`;
        }
        if (status?.uptime?.formatted) {
          elements.statUptime.textContent = status.uptime.formatted;
        }
        if (status?.process?.pid) {
          elements.statPid.textContent = status.process.pid;
        }
        if (status?.system?.nodeVersion) {
          elements.statNode.textContent = status.system.nodeVersion;
        }
        const rows = [
          { label: "Uptime (seconds)", value: status?.uptime?.seconds ?? "-" },
          { label: "RSS", value: status?.memory?.rss ?? "-" },
          { label: "Heap total", value: status?.memory?.heapTotal ?? "-" },
          { label: "Heap used", value: status?.memory?.heapUsed ?? "-" },
          { label: "Platform", value: status?.system?.platform ?? "-" },
          { label: "Architecture", value: status?.system?.arch ?? "-" },
          { label: "CPU count", value: status?.system?.cpus ?? "-" },
          { label: "Free memory", value: status?.system?.freeMemory ?? "-" },
          { label: "Total memory", value: status?.system?.totalMemory ?? "-" },
        ];
        elements.systemStatus.innerHTML = rows.map(row => `
          <div class="info-item">
            <span class="label">${escapeHtml(row.label)}</span>
            <span class="value">${escapeHtml(row.value)}</span>
          </div>
        `).join("");
      }

      function renderServiceStatus(config) {
        const items = [
          { name: "Tautulli", enabled: !!config.tautulli?.enabled, detail: config.tautulli?.url ?? "" },
          { name: "TMDB", enabled: !!config.tmdb?.enabled, detail: config.tmdb?.accessToken ? "access token set" : "" },
          { name: "API auth", enabled: !!config.auth?.enabled, detail: config.auth?.token ? "token set" : "" },
        ];
        elements.serviceStatus.innerHTML = items.map(item => `
          <div class="info-item">
            <span class="label">${escapeHtml(item.name)}</span>
            <span class="value">
              <span class="chip ${item.enabled ? "chip-success" : "chip-danger"}">${item.enabled ? "enabled" : "disabled"}</span>
            </span>
          </div>
          ${item.detail ? `<div class="muted">${escapeHtml(item.detail)}</div>` : ""}
        `).join("");
      }

      function renderSeriesOverview(samples) {
        if (!Array.isArray(samples) || samples.length === 0) {
          elements.seriesOverview.innerHTML = `<div class="muted">No series sample data available yet.</div>`;
          return;
        }

        const content = samples.map(sample => {
          const title = escapeHtml(sample.title ?? 'Untitled');
          const seasonCount = escapeHtml(String(sample.seasonCount ?? '-'));
          const episodeCount = escapeHtml(String(sample.episodeCount ?? '-'));

          const seasonsArray = Array.isArray(sample.seasons) ? sample.seasons : [];
          const seasonsSummary = seasonsArray.length
            ? seasonsArray
                .map(season => {
                  const number = escapeHtml(String(season?.number ?? '?'));
                  const episodes = escapeHtml(String(season?.episodeCount ?? 0));
                  return `S${number} (${episodes})`;
                })
                .join(', ')
            : 'n/a';

          const castArray = Array.isArray(sample.cast) ? sample.cast : [];
          const castSummary = castArray.length
            ? castArray
                .map(member => {
                  const name = member?.name ? escapeHtml(member.name) : '';
                  if (!name) return null;
                  const character = member?.character ? ` as ${escapeHtml(member.character)}` : '';
                  return `${name}${character}`;
                })
                .filter(Boolean)
                .join(', ')
            : 'n/a';

          return `
            <div class="info-item">
              <span class="label">${title}</span>
              <span class="value">Seasons ${seasonCount} • Episodes ${episodeCount}</span>
            </div>
            <div class="muted">Seasons: ${seasonsSummary || 'n/a'}</div>
            <div class="muted">Cast: ${castSummary || 'n/a'}</div>
          `;
        }).join('');

        elements.seriesOverview.innerHTML = content;
      }

      async function loadImportView() {
        try {
          await updateImportStatus();
          setLastUpdated("import");
        } catch (error) {
          showToast(error.message, "error");
          elements.importStatus.innerHTML = `<div class="alert alert-error">${escapeHtml(error.message)}</div>`;
        }
      }

      async function updateImportStatus() {
        const status = await fetchJson(`${API_BASE}/import/status`);
        renderImportStatus(status);
        renderImportLogs(status.logs || []);
        updateImportButtons(status.running);
        if (status.running) {
          startImportPolling();
        } else {
          stopImportPolling();
        }
        return status;
      }

      function renderImportStatus(status) {
        if (!status) {
          elements.importStatus.innerHTML = `<div class="muted">No status returned.</div>`;
          return;
        }
        const badge = status.running ? `<span class="chip chip-info">running</span>` :
          status.error ? `<span class="chip chip-danger">failed</span>` :
            `<span class="chip chip-success">idle</span>`;
        elements.importStatus.innerHTML = `
          <div class="info-item"><span class="label">Status</span><span class="value">${badge}</span></div>
          <div class="info-item"><span class="label">PID</span><span class="value">${escapeHtml(status.pid ?? "-")}</span></div>
          <div class="info-item"><span class="label">Started</span><span class="value">${status.startedAt ? new Date(status.startedAt).toLocaleString("de-DE") : "-"}</span></div>
          <div class="info-item"><span class="label">Finished</span><span class="value">${status.finishedAt ? new Date(status.finishedAt).toLocaleString("de-DE") : "-"}</span></div>
          <div class="info-item"><span class="label">Exit code</span><span class="value">${escapeHtml(status.exitCode ?? "-")}</span></div>
          ${status.error ? `<div class="alert alert-error">${escapeHtml(status.error)}</div>` : ""}
        `;
      }

      function renderImportLogs(lines) {
        if (!lines || lines.length === 0) {
          elements.importLogs.textContent = "No log output yet.";
          return;
        }
        elements.importLogs.innerHTML = lines.map(line => `<div>${escapeHtml(line)}</div>`).join("");
        elements.importLogs.scrollTop = elements.importLogs.scrollHeight;
      }

      function updateImportButtons(running) {
        elements.startImport.disabled = running;
        elements.stopImport.disabled = !running;
      }

      function showImportMessage(type, message) {
        if (!message) {
          elements.importMessage.innerHTML = "";
          return;
        }
        const cls = type === "error" ? "alert-error" : type === "success" ? "alert-info" : "alert-info";
        elements.importMessage.innerHTML = `<div class="alert ${cls}">${escapeHtml(message)}</div>`;
      }

      async function handleStartImport() {
        const payload = {
          dryRun: elements.optDryRun.checked,
          force: elements.optForce.checked,
          verbose: elements.optVerbose.checked,
          moviesOnly: elements.optMovies.checked,
          seriesOnly: elements.optShows.checked,
        };
        elements.startImport.disabled = true;
        showImportMessage(null);
        try {
          const result = await fetchJson(`${API_BASE}/import`, {
            method: "POST",
            body: JSON.stringify(payload),
          });
          showToast(result.message || "Import started", "success");
          showImportMessage("success", result.message || "Import started.");
          updateImportButtons(true);
          startImportPolling(true);
        } catch (error) {
          elements.startImport.disabled = false;
          showToast(error.message, "error");
          showImportMessage("error", error.message);
        }
      }

      async function handleStopImport() {
        try {
          const result = await fetchJson(`${API_BASE}/import/stop`, { method: "POST" });
          showToast(result.message || "Stop signal sent", "info");
          showImportMessage("info", result.message || "Stop signal sent.");
          stopImportPolling();
          await updateImportStatus();
        } catch (error) {
          showToast(error.message, "error");
          showImportMessage("error", error.message);
        }
      }

      async function handleClearImportLogs() {
        try {
          await fetchJson(`${API_BASE}/import/logs`, { method: "DELETE" });
          elements.importLogs.textContent = "Import log cleared.";
          showToast("Import log cleared", "info");
        } catch (error) {
          showToast(error.message, "error");
        }
      }

      function startImportPolling(immediate = false) {
        if (state.importTimer) {
          return;
        }
        if (immediate) {
          updateImportStatus().catch(err => console.error(err));
        }
        state.importPollCount = 0;
        state.importTimer = setInterval(async () => {
          state.importPollCount += 1;
          try {
            const status = await updateImportStatus();
            if (!status.running) {
              stopImportPolling();
            }
          } catch (error) {
            console.error(error);
            showToast(`Import polling failed: ${error.message}`, "error");
          }
        }, state.importPollCount < 10 ? 1000 : 3000);
      }

      function stopImportPolling() {
        if (state.importTimer) {
          clearInterval(state.importTimer);
          state.importTimer = null;
        }
      }

      async function loadConfigSnapshot() {
        elements.configView.innerHTML = `<div class="muted">Loading configuration...</div>`;
        try {
          const data = await fetchJson(`${API_BASE}/config`);
          const sections = Object.entries(data).map(([key, value]) => `
            <details>
              <summary>${escapeHtml(key)}</summary>
              <pre>${escapeHtml(JSON.stringify(value, null, 2))}</pre>
            </details>
          `).join("");
          elements.configView.innerHTML = sections || `<div class="muted">No configuration data.</div>`;
        } catch (error) {
          elements.configView.innerHTML = `<div class="alert alert-error">${escapeHtml(error.message)}</div>`;
          throw error;
        }
      }

      function renderTmdbStatus(status) {
        state.tmdbStatus = status || null;
        if (!elements.tmdbTokenStatus) return;
        if (!status || !status.enabled) {
          elements.tmdbTokenStatus.textContent = status?.fromEnv
            ? "Active token provided via environment configuration."
            : "No TMDb token stored yet.";
        } else {
          const preview = status.tokenPreview ? ` (${status.tokenPreview})` : "";
          const updated = status.updatedAt
            ? ` — updated ${new Date(status.updatedAt).toLocaleString("de-DE")}`
            : "";
          const sourceLabel = status.source === "database" ? "stored in database" : "provided via environment";
          elements.tmdbTokenStatus.textContent = `Token ${sourceLabel}${preview}${updated}`;
        }
        if (elements.tmdbClearButton) {
          elements.tmdbClearButton.disabled = !status || !status.fromDatabase;
        }
        if (elements.tmdbTestButton) {
          elements.tmdbTestButton.disabled = false;
        }
      }

      async function loadTmdbStatus() {
        if (!elements.tmdbTokenStatus) return;
        elements.tmdbTokenStatus.textContent = "Loading TMDb status...";
        try {
          const data = await fetchJson(`${API_BASE}/tmdb`);
          renderTmdbStatus(data);
          if (elements.tmdbTestOutput) {
            elements.tmdbTestOutput.textContent = "No test executed yet.";
          }
        } catch (error) {
          elements.tmdbTokenStatus.textContent = `Failed to load TMDb status: ${error.message}`;
          throw error;
        }
      }

      function renderResendStatus(status) {
        state.resendStatus = status || null;
        if (!elements.resendStatus) return;
        if (!status || !status.enabled) {
          elements.resendStatus.textContent = status?.fromEnv
            ? "Active configuration provided via environment variables."
            : "No Resend configuration stored yet.";
        } else {
          const apiKeyPreview = status.apiKeyPreview ? ` (${status.apiKeyPreview})` : "";
          const fromEmail = status.fromEmail ? ` | From: ${status.fromEmail}` : "";
          const updated = status.updatedAt
            ? ` — updated ${new Date(status.updatedAt).toLocaleString("de-DE")}`
            : "";
          const sourceLabel = status.source === "database" ? "stored in database" : "provided via environment";
          elements.resendStatus.textContent = `Configuration ${sourceLabel}${apiKeyPreview}${fromEmail}${updated}`;
        }
        if (elements.resendClearButton) {
          elements.resendClearButton.disabled = !status || !status.fromDatabase;
        }
        if (elements.resendTestButton) {
          elements.resendTestButton.disabled = false;
        }
      }

      async function loadResendStatus() {
        if (!elements.resendStatus) return;
        elements.resendStatus.textContent = "Loading Resend status...";
        try {
          const data = await fetchJson(`${API_BASE}/resend/settings`);
          renderResendStatus(data);
          if (elements.resendTestOutput) {
            elements.resendTestOutput.textContent = "No test executed yet.";
          }
        } catch (error) {
          elements.resendStatus.textContent = `Failed to load Resend status: ${error.message}`;
          throw error;
        }
      }

      async function handleSaveResend(event) {
        event?.preventDefault();
        if (!elements.resendSaveButton || !elements.resendApiKeyInput || !elements.resendFromEmailInput) return;
        const apiKey = elements.resendApiKeyInput.value.trim();
        const fromEmail = elements.resendFromEmailInput.value.trim();
        if (!apiKey || !fromEmail) {
          showToast("Please enter both API key and from email address.", "error");
          return;
        }
        elements.resendSaveButton.disabled = true;
        if (elements.resendTestButton) elements.resendTestButton.disabled = true;
        if (elements.resendClearButton) elements.resendClearButton.disabled = true;
        try {
          const data = await fetchJson(`${API_BASE}/resend/settings`, {
            method: "PUT",
            body: JSON.stringify({ apiKey, fromEmail }),
          });
          elements.resendApiKeyInput.value = "";
          elements.resendFromEmailInput.value = "";
          renderResendStatus(data.status);
          if (elements.resendTestOutput) {
            elements.resendTestOutput.textContent = "Configuration saved. Run a test to verify.";
          }
          showToast("Resend configuration stored successfully.", "success");
        } catch (error) {
          showToast(error.message, "error");
        } finally {
          elements.resendSaveButton.disabled = false;
          if (elements.resendTestButton) elements.resendTestButton.disabled = false;
          if (elements.resendClearButton) {
            elements.resendClearButton.disabled = !state.resendStatus || !state.resendStatus.fromDatabase;
          }
        }
      }

      async function handleTestResend(event) {
        event?.preventDefault();
        if (!elements.resendTestButton) return;
        const apiKey = elements.resendApiKeyInput ? elements.resendApiKeyInput.value.trim() : "";
        const fromEmail = elements.resendFromEmailInput ? elements.resendFromEmailInput.value.trim() : "";
        if ((!apiKey || !fromEmail) && !state.resendStatus?.enabled) {
          if (elements.resendTestOutput) {
            elements.resendTestOutput.textContent = "Enter configuration or save one before running a test.";
          }
          showToast("Provide Resend configuration to run the test.", "error");
          return;
        }
        elements.resendTestButton.disabled = true;
        if (elements.resendTestOutput) {
          elements.resendTestOutput.textContent = "Sending test email...";
        }
        try {
          const payload = (apiKey && fromEmail) ? { apiKey, fromEmail } : {};
          const data = await fetchJson(`${API_BASE}/test/resend`, {
            method: "POST",
            body: JSON.stringify(payload),
          });
          let message = `Success: ${data.message}`;
          if (data.emailId) {
            message += ` | Email ID: ${data.emailId}`;
          }
          if (elements.resendTestOutput) {
            elements.resendTestOutput.textContent = message;
          }
          showToast("Resend test email sent successfully.", "success");
        } catch (error) {
          if (elements.resendTestOutput) {
            elements.resendTestOutput.textContent = `Error: ${error.message}`;
          }
          showToast(error.message, "error");
        } finally {
          elements.resendTestButton.disabled = false;
        }
      }

      async function handleClearResend(event) {
        event?.preventDefault();
        if (!elements.resendClearButton) return;
        if (!state.resendStatus?.fromDatabase) {
          showToast("There is no stored Resend configuration to remove.", "info");
          return;
        }
        elements.resendClearButton.disabled = true;
        try {
          const data = await fetchJson(`${API_BASE}/resend/settings`, { method: "DELETE" });
          renderResendStatus(data.status);
          if (elements.resendTestOutput) {
            elements.resendTestOutput.textContent = "Stored configuration removed. Provide configuration to test.";
          }
          showToast("Stored Resend configuration removed.", "success");
        } catch (error) {
          showToast(error.message, "error");
          elements.resendClearButton.disabled = false;
        }
      }

      async function handleTestResendDiag(event) {
        event?.preventDefault();
        if (!elements.resendTestButtonDiag || !elements.resendTestEmail) return;
        const recipientEmail = elements.resendTestEmail.value.trim();
        if (!recipientEmail) {
          showToast("Please enter a recipient email address.", "error");
          if (elements.resendDiagOutput) {
            elements.resendDiagOutput.textContent = "Please enter a recipient email address.";
          }
          return;
        }
        elements.resendTestButtonDiag.disabled = true;
        if (elements.resendDiagOutput) {
          elements.resendDiagOutput.textContent = "Sending test email...";
        }
        try {
          const data = await fetchJson(`${API_BASE}/test/resend`, {
            method: "POST",
            body: JSON.stringify({ to: recipientEmail }),
          });
          let message = `Success: Test email sent to ${recipientEmail}`;
          if (data.emailId) {
            message += ` | Email ID: ${data.emailId}`;
          }
          if (elements.resendDiagOutput) {
            elements.resendDiagOutput.textContent = message;
          }
          showToast("Test email sent successfully.", "success");
        } catch (error) {
          if (elements.resendDiagOutput) {
            elements.resendDiagOutput.textContent = `Error: ${error.message}`;
          }
          showToast(error.message, "error");
        } finally {
          elements.resendTestButtonDiag.disabled = false;
        }
      }

      async function loadConfig() {
        await Promise.all([loadTmdbStatus(), loadResendStatus(), loadConfigSnapshot()]);
        setLastUpdated("configuration");
      }

      async function handleSaveTmdbToken(event) {
        event?.preventDefault();
        if (!elements.tmdbSaveButton || !elements.tmdbTokenInput) return;
        const token = elements.tmdbTokenInput.value.trim();
        if (!token) {
          showToast("Please enter a TMDb access token before saving.", "error");
          return;
        }
        elements.tmdbSaveButton.disabled = true;
        if (elements.tmdbTestButton) elements.tmdbTestButton.disabled = true;
        if (elements.tmdbClearButton) elements.tmdbClearButton.disabled = true;
        try {
          const data = await fetchJson(`${API_BASE}/tmdb`, {
            method: "POST",
            body: JSON.stringify({ token }),
          });
          elements.tmdbTokenInput.value = "";
          renderTmdbStatus(data.status);
          if (elements.tmdbTestOutput) {
            elements.tmdbTestOutput.textContent = "Token saved. Run a test to verify.";
          }
          showToast("TMDb token stored successfully.", "success");
        } catch (error) {
          showToast(error.message, "error");
        } finally {
          elements.tmdbSaveButton.disabled = false;
          if (elements.tmdbTestButton) elements.tmdbTestButton.disabled = false;
          if (elements.tmdbClearButton) {
            elements.tmdbClearButton.disabled = !state.tmdbStatus || !state.tmdbStatus.fromDatabase;
          }
        }
      }

      async function handleTestTmdbToken(event) {
        event?.preventDefault();
        if (!elements.tmdbTestButton) return;
        const token = elements.tmdbTokenInput ? elements.tmdbTokenInput.value.trim() : "";
        if (!token && !state.tmdbStatus?.enabled) {
          if (elements.tmdbTestOutput) {
            elements.tmdbTestOutput.textContent = "Enter a token or save one before running a test.";
          }
          showToast("Provide a token to run the TMDb test.", "error");
          return;
        }
        elements.tmdbTestButton.disabled = true;
        if (elements.tmdbTestOutput) {
          elements.tmdbTestOutput.textContent = "Testing token...";
        }
        try {
          const data = await fetchJson(`${API_BASE}/test/tmdb`, {
            method: "POST",
            body: JSON.stringify(token ? { token } : {}),
          });
          let message = `Success: ${data.message}`;
          if (typeof data.tokenPreview === "string" && data.tokenPreview) {
            message += ` (${data.tokenPreview})`;
          }
          if (typeof data.rateLimitRemaining === "number" && Number.isFinite(data.rateLimitRemaining)) {
            message += ` | Remaining budget: ${data.rateLimitRemaining}`;
          }
          if (elements.tmdbTestOutput) {
            elements.tmdbTestOutput.textContent = message;
          }
          showToast("TMDb token test succeeded.", "success");
        } catch (error) {
          if (elements.tmdbTestOutput) {
            elements.tmdbTestOutput.textContent = `Error: ${error.message}`;
          }
          showToast(error.message, "error");
        } finally {
          elements.tmdbTestButton.disabled = false;
        }
      }

      async function handleClearTmdbToken(event) {
        event?.preventDefault();
        if (!elements.tmdbClearButton) return;
        if (!state.tmdbStatus?.fromDatabase) {
          showToast("There is no stored TMDb token to remove.", "info");
          return;
        }
        elements.tmdbClearButton.disabled = true;
        try {
          const data = await fetchJson(`${API_BASE}/tmdb`, { method: "DELETE" });
          renderTmdbStatus(data.status);
          if (elements.tmdbTestOutput) {
            elements.tmdbTestOutput.textContent = "Stored token removed. Provide a token to test.";
          }
          showToast("Stored TMDb token removed.", "success");
        } catch (error) {
          showToast(error.message, "error");
          elements.tmdbClearButton.disabled = false;
        }
      }

      async function loadLogs() {
        elements.logView.innerHTML = `<div class="muted">Loading log buffer...</div>`;
        try {
          const params = new URLSearchParams();
          const limit = parseInt(elements.logLimit.value, 10);
          if (!Number.isNaN(limit)) {
            params.set("limit", String(limit));
          }
          const level = elements.logLevel.value;
          if (level) {
            params.set("level", level);
          }
          const data = await fetchJson(`${API_BASE}/logs?${params.toString()}`);
          const logs = data.logs || [];
          if (logs.length === 0) {
            elements.logView.textContent = "No logs available.";
          } else {
            elements.logView.innerHTML = logs.map(entry => {
              const context = entry.context ? `\n${JSON.stringify(entry.context, null, 2)}` : "";
              return `
                <div class="log-entry">
                  <span class="log-meta">${escapeHtml(entry.timestamp)}</span>
                  <span class="log-meta">${escapeHtml(entry.level)}</span>
                  ${escapeHtml(entry.message)}
                  ${context ? `<pre>${escapeHtml(context)}</pre>` : ""}
                </div>
              `;
            }).join("");
            elements.logView.scrollTop = elements.logView.scrollHeight;
          }
          const stats = data.stats || {};
          elements.logSummary.textContent = `entries ${stats.total ?? logs.length} | error ${stats.byLevel?.error ?? 0} | warn ${stats.byLevel?.warn ?? 0}`;
          setLastUpdated("logs");
        } catch (error) {
          elements.logView.innerHTML = `<div class="alert alert-error">${escapeHtml(error.message)}</div>`;
          throw error;
        }
      }

      async function handleClearLogs() {
        try {
          await fetchJson(`${API_BASE}/logs`, { method: "DELETE" });
          elements.logView.textContent = "Log buffer cleared.";
          elements.logSummary.textContent = "entries 0";
          showToast("Log buffer cleared", "info");
        } catch (error) {
          showToast(error.message, "error");
        }
      }

      async function runTautulliTest() {
        elements.tautulliButton.disabled = true;
        elements.tautulliOutput.textContent = "Testing Tautulli connection...";
        try {
          const data = await fetchJson(`${API_BASE}/test/tautulli`, { method: "POST" });
          elements.tautulliOutput.textContent = `Success: ${data.libraries ?? 0} libraries reachable.`;
          showToast("Tautulli test succeeded", "success");
        } catch (error) {
          elements.tautulliOutput.textContent = `Error: ${error.message}`;
          showToast(error.message, "error");
        } finally {
          elements.tautulliButton.disabled = false;
        }
      }

      async function runDbTest() {
        elements.dbButton.disabled = true;
        elements.dbOutput.textContent = "Checking database...";
        try {
          const data = await fetchJson(`${API_BASE}/test/database`, { method: "POST" });
          elements.dbOutput.textContent = `Success: ${data.recordCount ?? 0} records accessible.`;
          showToast("Database test succeeded", "success");
        } catch (error) {
          elements.dbOutput.textContent = `Error: ${error.message}`;
          showToast(error.message, "error");
        } finally {
          elements.dbButton.disabled = false;
        }
      }

      function bindEvents() {
        elements.navButtons.forEach(btn => {
          btn.addEventListener("click", () => switchView(btn.dataset.view));
        });
        if (elements.tmdbTestButton) elements.tmdbTestButton.disabled = true;
        if (elements.tmdbClearButton) elements.tmdbClearButton.disabled = true;
        if (elements.resendTestButton) elements.resendTestButton.disabled = true;
        if (elements.resendClearButton) elements.resendClearButton.disabled = true;
        elements.refreshButton.addEventListener("click", () => {
          const loader = viewLoaders[state.currentView];
          if (loader) {
            loader().catch(err => showToast(err.message, "error"));
          }
        });
        elements.autoToggle.addEventListener("change", event => setAutoRefresh(event.target.checked));
        elements.startImport.addEventListener("click", handleStartImport);
        elements.stopImport.addEventListener("click", handleStopImport);
        elements.refreshImport.addEventListener("click", () => updateImportStatus().catch(err => showToast(err.message, "error")));
        elements.clearImportLogs.addEventListener("click", handleClearImportLogs);
        elements.refreshLogs.addEventListener("click", () => loadLogs().catch(err => showToast(err.message, "error")));
        elements.clearLogs.addEventListener("click", handleClearLogs);
        elements.logLevel.addEventListener("change", () => loadLogs().catch(err => showToast(err.message, "error")));
        elements.logLimit.addEventListener("change", () => loadLogs().catch(err => showToast(err.message, "error")));
        elements.tautulliButton.addEventListener("click", runTautulliTest);
        elements.dbButton.addEventListener("click", runDbTest);
        if (elements.tmdbSaveButton) {
          elements.tmdbSaveButton.addEventListener("click", handleSaveTmdbToken);
        }
        if (elements.tmdbTestButton) {
          elements.tmdbTestButton.addEventListener("click", handleTestTmdbToken);
        }
        if (elements.tmdbClearButton) {
          elements.tmdbClearButton.addEventListener("click", handleClearTmdbToken);
        }
        if (elements.resendSaveButton) {
          elements.resendSaveButton.addEventListener("click", handleSaveResend);
        }
        if (elements.resendTestButton) {
          elements.resendTestButton.addEventListener("click", handleTestResend);
        }
        if (elements.resendClearButton) {
          elements.resendClearButton.addEventListener("click", handleClearResend);
        }
        if (elements.resendTestButtonDiag) {
          elements.resendTestButtonDiag.addEventListener("click", handleTestResendDiag);
        }
      }

      function init() {
        bindEvents();
        const stored = localStorage.getItem("admin:autoRefresh") === "1";
        setAutoRefresh(stored);
        loadDashboard().catch(err => showToast(err.message, "error"));
      }

      window.addEventListener("visibilitychange", () => {
        if (document.visibilityState === "visible" && state.autoRefresh && !state.autoTimer) {
          setAutoRefresh(true);
        }
      });

      init();
    })();
  </script>
</body>
</html>

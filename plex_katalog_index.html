<!DOCTYPE html>

<html lang="de">

<head>

  <meta charset="utf-8" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <title>Plex-Katalog</title>

  <link rel="icon" type="image/png" href="assets/plex-katalog-favicon.png" />

  <style>

    :root{

      color-scheme: dark;

      --bg:#0b0d10;--fg:#e8ecf1;--muted:#9aa7b2;--card:#14181d;--accent:#6aa6ff;--chip:#20262d;--border:#1e242b;

      --hdr-a: rgba(121,168,255,0.38);

      --hdr-b: rgba(255,183,71,0.35);

    }

    *{box-sizing:border-box;margin:0;padding:0}

    body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}

    a{color:inherit;text-decoration:none}

    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}

header.site-header{
  position:relative;
  z-index:3;
  min-height: clamp(160px, 28vw, 320px);
  padding: 28px 16px 26px;
  background:
    radial-gradient(circle at 12% 18%, var(--hdr-a) 0%, rgba(121,168,255,0) 52%),
    radial-gradient(circle at 78% 14%, var(--hdr-b) 0%, rgba(255,183,71,0) 60%),
    linear-gradient(135deg,#09101c 0%,#0b0d10 38%,#1f2f4a 100%);
  background-size:220% 220%;
  background-position:48% 6%, 54% 20%, center;
  animation:headerDrift 18s ease-in-out infinite alternate;
  background-blend-mode:screen;
  border-bottom:1px solid rgba(255,255,255,0.06);
  overflow:hidden;
}

header.site-header::before{
  content:"";
  position:absolute;
  inset:-55% -28%;
  z-index:1;
  background:
    radial-gradient(ellipse at 32% 38%, var(--hdr-b) 0%, rgba(255,214,106,0) 68%),
    radial-gradient(ellipse at 72% 70%, var(--hdr-a) 0%, rgba(106,166,255,0) 70%);
  background-size:160% 160%;
  opacity:0.92;
  pointer-events:none;
  mix-blend-mode:screen;
  filter:blur(80px);
  animation:headerAurora 12s cubic-bezier(.55,.12,.37,.88) infinite alternate;
}

                    header.site-header .grain{position:absolute;inset:0;pointer-events:none;z-index:2;opacity:.08;mix-blend-mode:overlay;background-image:url("data:image/svg+xml;utf8,\<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"120\" height=\"120\" viewBox=\"0 0 120 120\">\<filter id=\"n\"><feTurbulence type=\"fractalNoise\" baseFrequency=\"0.9\" numOctaves=\"2\" stitchTiles=\"stitch\"/></filter>\<rect width=\"120\" height=\"120\" filter=\"url(%23n)\" opacity=\"0.75\"/></svg>");animation:grainShift 8s steps(12) infinite}


    .site-header__inner{
      position:relative;
      z-index:4;
      max-width:1200px;
      margin:0 auto;
      display:grid;
      grid-template-columns:auto 1fr auto;
      align-items:end;
      gap:24px;
    }
    .site-header__logo{
      height:clamp(72px,12vw,160px);
      width:auto;
      max-width:100%;
      filter:drop-shadow(0 16px 36px rgba(0,0,0,0.42));
      transform-origin:left center;
      animation:logoFloat 12s ease-in-out infinite alternate;
    }
.site-header__logo.logo-missing{display:none}

    .site-header__meta{
      display:flex;
      flex-direction:column;
      gap:10px;
      min-width:240px;
      max-width:560px;
    }
.site-title{margin:0;font-size:clamp(28px,3vw,40px);font-weight:700;letter-spacing:0.18em;text-transform:uppercase;color:var(--fg);line-height:1.1}

    .site-tagline{margin:0;color:var(--muted);font-size:clamp(16px,1.65vw,24px);letter-spacing:.15px;line-height:1.35;opacity:.98;transition:opacity .4s ease;max-width:640px}.site-tagline.is-fading{opacity:.25}

    .site-header__stats{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:8px 18px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.32);
      background:rgba(15,21,30,0.78);
      color:var(--fg);
      font-size:13px;
      font-weight:600;
      letter-spacing:.3px;
      justify-self:end;
      align-self:end;
    }
.filters{position:sticky;top:0;z-index:4;background:rgba(11,13,16,0.9);backdrop-filter:saturate(140%) blur(10px);border-bottom:1px solid rgba(255,255,255,0.06)}

    .filters-wrap{max-width:1200px;margin:0 auto;padding:16px 16px 14px;display:flex;flex-direction:column;gap:12px}

    .filters-main{display:flex;align-items:center;gap:12px;flex-wrap:wrap}

    .library-switch{display:flex;gap:6px;background:rgba(15,18,23,0.92);border:1px solid var(--border);border-radius:999px;padding:4px}

    .library-switch button{flex:1;border:none;background:transparent;color:var(--muted);padding:6px 12px;border-radius:999px;cursor:pointer;font-size:13px;transition:background .15s ease,color .15s ease}

    .library-switch button.active{background:var(--accent);color:#0b1524}

    .field{display:flex;align-items:center;gap:8px;background:rgba(15,18,23,0.85);border:1px solid var(--border);border-radius:14px;padding:8px 12px;min-height:44px}
    .field.is-disabled{opacity:0.5}

    .field.search{flex:1 1 260px}

    .field.search input{border:none;background:transparent;color:var(--fg);width:100%}

    .field.sort select{width:100%;border:1px solid var(--border);background:var(--card);color:var(--fg);border-radius:10px;padding:6px 10px}

    .toggle-advanced, .settings-button{border:1px solid var(--border);background:rgba(15,18,23,0.85);color:var(--muted);border-radius:999px;padding:8px 16px;font-size:13px;cursor:pointer;transition:background .15s ease,color .15s ease}

    .toggle-advanced:hover, .settings-button:hover{border-color:var(--accent);color:var(--accent)}

    .watchlist-button{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--border);background:rgba(15,18,23,0.85);color:var(--muted);border-radius:999px;padding:8px 16px;font-size:13px;cursor:pointer;transition:background .15s ease,color .15s ease,border .15s ease}

    .watchlist-button .count{display:inline-flex;align-items:center;justify-content:center;min-width:20px;height:20px;border-radius:999px;background:rgba(106,166,255,0.18);color:var(--accent);font-weight:600;font-size:12px;padding:0 8px}

    .watchlist-button.has-items{color:var(--accent);border-color:rgba(106,166,255,0.45);background:rgba(106,166,255,0.12)}

    .watchlist-button.active{background:var(--accent);color:#0b1524;border-color:var(--accent)}

    .filters-advanced{display:none;background:rgba(15,18,23,0.7);border:1px solid var(--border);border-radius:16px;padding:12px}

    .filters-advanced.active{display:block}

    .advanced-row{display:flex;gap:12px;flex-wrap:wrap}

    .field.chips{flex:1 1 280px}
    .field.collections{flex:1 1 220px}
    .field.collections select{width:100%;border:1px solid var(--border);background:var(--card);color:var(--fg);border-radius:10px;padding:6px 10px}

    .chip-group{display:flex;flex-wrap:wrap;gap:6px;overflow:auto;max-height:120px}

    .chip-group[data-state="empty"]::before{content:attr(data-empty);color:var(--muted);font-size:12px;opacity:0.6}

    .chip-filter{border:1px solid rgba(106,166,255,0.35);padding:4px 10px;border-radius:999px;color:var(--muted);cursor:pointer;transition:all .15s ease;background:rgba(14,17,22,0.6)}

    .chip-filter:hover{border-color:var(--accent);color:var(--accent);background:rgba(106,166,255,0.12)}

    .chip-filter.selected{background:var(--accent);color:#0b1524;border-color:var(--accent);box-shadow:0 0 0 1px rgba(106,166,255,0.4)}

    .field.year select{width:auto;min-width:110px;border:1px solid var(--border);background:var(--card);color:var(--fg);border-radius:10px;padding:6px 10px}

    .field.toggles{gap:10px;background:transparent;border:none;padding:0;flex-wrap:wrap}

    .toggle-chip{display:inline-flex;align-items:center;gap:6px;background:rgba(15,18,23,0.85);border:1px solid var(--border);border-radius:999px;padding:6px 12px;font-size:13px;color:var(--muted);cursor:pointer;transition:background .15s ease,color .15s ease}

    .toggle-chip:hover{border-color:var(--accent);color:var(--accent)}

    .toggle-chip input{margin:0}
    .toggle-chip.is-disabled{opacity:0.45;pointer-events:none;cursor:not-allowed}

    .icon{width:16px;height:16px;border-radius:999px;border:1px solid rgba(106,166,255,0.35);background:rgba(106,166,255,0.12);display:inline-flex;align-items:center;justify-content:center;font-size:10px;color:var(--accent)}

    main{padding-bottom:48px}

    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,280px));justify-content:center;gap:18px;padding:24px 16px;width:min(1600px,100%);margin:0 auto;transition:opacity .25s ease,transform .25s ease}

    .grid.is-leaving{opacity:0;transform:scale(.985)}

    .grid.is-entering{opacity:0;transform:scale(.985)}

    .grid.is-entering.is-ready{opacity:1;transform:scale(1)}

    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;overflow:hidden;display:flex;flex-direction:column;transition:transform .12s ease,box-shadow .12s ease;position:relative;will-change:transform;contain:paint;content-visibility:auto;contain-intrinsic-size:300px 480px;width:100%;max-width:280px;margin:0 auto}

    .card.in-watchlist{border-color:rgba(249,178,51,0.8);box-shadow:0 0 0 1px rgba(249,178,51,0.25)}

    .card:hover{transform:translateY(-2px);box-shadow:0 6px 18px rgba(0,0,0,.25)}

    .poster{position:relative;overflow:hidden;aspect-ratio:2/3;background:#111;transition:transform .2s ease}

    .poster img{width:100%;height:100%;object-fit:cover;opacity:0;transition:opacity .25s ease;display:block}

    .poster img.is-ready{opacity:1}

    .card:hover .poster{transform:scale(1.04)}

    .poster .rating{position:absolute;bottom:10px;right:10px;background:rgba(11,13,16,0.85);border:1px solid var(--accent);color:var(--accent);padding:4px 8px;border-radius:999px;font-size:12px;font-weight:600;letter-spacing:.3px;opacity:0;transform:translateY(6px);transition:opacity .18s ease,transform .18s ease}

    .card:hover .poster .rating{opacity:1;transform:translateY(0)}

    /* Recently added ribbon on poster */
    .poster .new-badge{
      position:absolute;top:12px;right:-36px;z-index:2;
      transform:rotate(45deg);
      background:var(--accent);color:#0b1524;
      font-size:10.5px;font-weight:800;letter-spacing:.4px;text-transform:uppercase;
      padding:6px 48px;
      box-shadow:0 2px 10px rgba(0,0,0,.35);
      pointer-events:none
    }

    .watchlist-toggle{position:absolute;top:10px;left:10px;border:none;background:rgba(11,13,16,0.78);color:var(--muted);border-radius:999px;padding:6px 10px;font-size:11px;font-weight:600;display:inline-flex;align-items:center;gap:6px;cursor:pointer;transition:background .15s ease,color .15s ease,transform .15s ease}

    .watchlist-toggle::before{content:"\2606";font-size:12px}

    .watchlist-toggle:hover{transform:translateY(-1px)}

    .watchlist-toggle.active{background:#f9b233;color:#11151d}

    .watchlist-toggle.active::before{content:"\2605"}

    .meta{padding:10px 12px}

    .title{font-weight:600;font-size:14.5px;margin:0 0 6px;letter-spacing:.2px;display:flex;align-items:center;gap:6px;flex-wrap:wrap}

    .badge{display:inline-block;font-size:10.5px;background:#163252;color:#cfe1ff;border:1px solid #20446e;padding:2px 6px;border-radius:999px}

    .sub{font-size:12.5px;color:var(--muted);display:flex;gap:8px;flex-wrap:wrap}

    .chips{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px}

    .chip{font-size:11.5px;color:#cfe1ff;background:var(--chip);border:1px solid var(--border);padding:2px 8px;border-radius:999px}
    .collection-hint{margin-top:6px;display:flex;align-items:center;gap:6px;font-size:12px;color:var(--muted)}
    .collection-hint .collection-label{opacity:0.8}
    .collection-hint .collection-link{border:1px solid var(--border);background:rgba(106,166,255,0.15);color:var(--accent);border-radius:999px;padding:2px 8px;font-size:11px;font-weight:600;cursor:pointer;transition:background .15s ease,color .15s ease,border .15s ease}
    .collection-hint .collection-link:hover{background:var(--accent);color:#0b1524;border-color:var(--accent)}
    .collection-hint .collection-more-count{font-size:11px;color:var(--muted)}
    .card.collection-card{min-height:0;border:2px dashed rgba(106,166,255,0.45)}
    .card.collection-card.in-watchlist{border-color:rgba(249,178,51,0.8)}
    .card.collection-card .collection-summary{margin-top:12px;display:flex;flex-direction:column;gap:6px}
    .card.collection-card .collection-summary.is-clickable{cursor:pointer;}
    .card.collection-card .collection-summary.is-clickable .collection-more{text-decoration:underline;}
    .card.collection-card .collection-summary.is-clickable:hover .collection-more{color:var(--accent);}
    .card.collection-card .collection-count{font-size:12px;font-weight:600;color:var(--accent);letter-spacing:.35px;text-transform:uppercase}
    .card.collection-card .collection-list{list-style:none;margin:0;padding:0;display:flex;flex-direction:column;gap:4px;font-size:12.5px;color:var(--muted)}
    .card.collection-card .collection-list li{display:flex;gap:6px;align-items:center}
    .card.collection-card .collection-list li .index{font-size:11px;color:var(--muted)}
    .card.collection-card .collection-list li .title{color:var(--fg);font-weight:600;flex:1}
    .card.collection-card .collection-list li .year{font-size:11px;color:var(--muted)}
    .card.collection-card .collection-more{font-size:12px;color:var(--muted)}

    .empty{color:var(--muted);text-align:center;padding:24px}

    .watchlist-panel{background:rgba(15,18,23,0.82);border:1px solid var(--border);border-radius:16px;margin:16px auto;padding:18px;max-width:1200px;box-shadow:0 12px 30px rgba(0,0,0,0.25)}

    .watchlist-panel[hidden]{display:none}

    .watchlist-header{display:flex;flex-wrap:wrap;justify-content:space-between;align-items:center;gap:12px;margin-bottom:12px}

    .watchlist-title{margin:0;font-size:18px;font-weight:600;letter-spacing:.3px}

    .watchlist-actions{display:flex;flex-wrap:wrap;gap:8px}

    .watchlist-actions button{border:1px solid var(--border);background:rgba(11,13,16,0.9);color:var(--fg);border-radius:999px;padding:8px 16px;font-size:13px;cursor:pointer;transition:background .15s ease,color .15s ease,border .15s ease}

    .watchlist-actions button.primary{background:var(--accent);color:#0b1524;border-color:var(--accent);font-weight:600}

    .watchlist-actions button:hover{border-color:var(--accent);color:var(--accent)}

    .watchlist-actions button.primary:hover{filter:brightness(1.05)}

    .watchlist-empty{color:var(--muted);font-size:13px;margin:0}

    .watchlist-items{list-style:none;margin:0;padding:0;display:flex;flex-direction:column;gap:10px}

    .watchlist-item{display:flex;justify-content:space-between;align-items:center;gap:12px;background:rgba(11,13,16,0.6);border:1px solid var(--border);border-radius:12px;padding:10px 14px}

    .watchlist-item-info{display:flex;flex-direction:column;gap:4px}

    .watchlist-item-title{font-size:14px;font-weight:600;color:var(--fg);display:flex;align-items:center;gap:6px;flex-wrap:wrap}

    .watchlist-item-meta{font-size:12px;color:var(--muted);display:flex;gap:8px;flex-wrap:wrap}
    .watchlist-collection-items{margin-top:6px;display:flex;flex-direction:column;gap:4px;font-size:12.5px;color:var(--muted)}
    .watchlist-collection-item{display:flex;align-items:center;gap:6px}
    .watchlist-collection-item::before{content:'\2022';color:var(--accent);font-size:10px}
    .watchlist-collection-more{font-size:12px;color:var(--muted);opacity:0.85}

    .watchlist-remove{border:1px solid rgba(255,255,255,0.12);background:transparent;color:var(--muted);border-radius:999px;padding:6px 12px;font-size:12px;cursor:pointer;transition:all .15s ease}

    .watchlist-remove:hover{border-color:var(--accent);color:var(--accent)}

                    @keyframes headerDrift{

      0%{background-position:48% 6%, 54% 20%, center}

      50%{background-position:65% 32%, 38% 46%, center}

      100%{background-position:30% 82%, 60% 60%, center}

    }

    @keyframes headerAurora{

      0%{transform:translate3d(-20%, -18%,0) scale(1.06)}

      50%{transform:translate3d(18%, 14%,0) scale(1.16)}

      100%{transform:translate3d(-12%, 28%,0) scale(1.09)}

    }

@keyframes grainShift{

      from{transform:translate3d(0,0,0)}

      to{transform:translate3d(-200px,-240px,0)}

    }footer.wrap{max-width:1200px;margin:24px auto 60px;padding:0 16px}



    @media (max-width:900px){
      .site-header{padding:26px 16px 22px}
      .site-header__inner{grid-template-columns:1fr auto;grid-template-rows:auto auto;gap:20px}
      #siteLogo{grid-column:1 / 2}
      .site-header__meta{grid-column:1 / -1}
      .site-header__stats{grid-column:2 / 3;justify-self:end;margin-top:12px}
      .filters-main{flex-direction:column;align-items:stretch}
      .filters-wrap{padding:12px}
      .filters-advanced{padding:10px}
    }
    @media (max-width:600px){
      .site-header{padding:22px 14px 18px}
      .site-header__inner{grid-template-columns:1fr;grid-template-rows:auto auto auto;align-items:flex-start;gap:18px}
      #siteLogo{grid-column:1 / -1}
      .site-header__logo{height:72px}
      .site-title{font-size:0}
      .site-tagline{font-size:15px;line-height:1.4}
      .site-header__stats{font-size:12px;grid-column:1 / -1;justify-self:start;align-self:start;margin-top:10px}
      .filters{position:relative;top:auto}
      .filters-wrap{padding:10px 12px}
      .toggle-advanced, .settings-button{width:100%;text-align:center}
      .filters-main{gap:8px}
      .watchlist-button{width:100%;justify-content:center}
      .watchlist-actions{flex-direction:column;align-items:stretch}
      .watchlist-actions button{width:100%}
      .watchlist-panel{margin:12px;padding:14px}
      .watchlist-item{flex-direction:column;align-items:flex-start}
      .watchlist-remove{align-self:flex-end}
    }
/* Reduced motion / accessibility */
@media (prefers-reduced-motion: reduce){
  *{scroll-behavior:auto !important}
  header.site-header, header.site-header::before{animation:none !important}
  header.site-header .grain{opacity:.05}
}

    /* Settings overlay */
    .settings-overlay{position:fixed;inset:0;z-index:20;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.45)}
    .settings-overlay[hidden]{display:none}
    .settings-dialog{background:rgba(15,18,23,0.95);border:1px solid var(--border);border-radius:16px;max-width:520px;width:92%;padding:18px;box-shadow:0 20px 60px rgba(0,0,0,0.45)}
    .settings-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
    .settings-title{margin:0;font-size:18px;font-weight:600;letter-spacing:.3px}
    .settings-body{display:flex;flex-direction:column;gap:12px}
    .settings-row{display:flex;flex-direction:column;gap:6px}
    .settings-row label{font-size:13px;color:var(--muted)}
    .settings-row input[type="text"], .settings-row input[type="password"]{width:100%;border:1px solid var(--border);background:var(--card);color:var(--fg);border-radius:10px;padding:8px 10px}
    .settings-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:8px}
    .settings-actions button, .settings-inline button{border:1px solid var(--border);background:rgba(15,18,23,0.85);color:var(--fg);border-radius:999px;padding:8px 16px;font-size:13px;cursor:pointer;transition:background .15s ease,color .15s ease,border .15s ease}
    .settings-actions button:hover, .settings-inline button:hover{border-color:var(--accent);color:var(--accent)}
    .settings-actions button.primary{background:var(--accent);color:#0b1524;border-color:var(--accent);font-weight:600}
    .settings-actions button.primary:hover{filter:brightness(1.05)}
    .settings-inline{display:flex;align-items:center;gap:8px}
    .settings-help{font-size:12px;color:var(--muted)}

    /* Manual reduce-motion preference via class */
    html.reduce-motion header.site-header,
    html.reduce-motion header.site-header::before{animation:none !important}
    html.reduce-motion .grain{opacity:.05}

    /* Footer */
    footer.wrap{display:flex;flex-direction:column;gap:10px}
    .footer-top{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
    .footer-actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:4px;justify-content:flex-end}
    .footer-actions .btn{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--border);background:rgba(15,18,23,0.85);color:var(--muted);border-radius:999px;padding:8px 16px;font-size:13px;cursor:pointer;transition:background .15s ease,color .15s ease,border .15s ease}
    .footer-actions .btn:hover{border-color:var(--accent);color:var(--accent)}
    .footer-meta{color:var(--muted);font-size:12.5px}
    .footer-note{color:var(--muted);font-size:12px;margin:0}

    /* Year reset button */
    #yearReset{border:1px solid var(--border);background:rgba(15,18,23,0.85);color:var(--muted);border-radius:999px;padding:6px 10px;font-size:12px;cursor:pointer;transition:background .15s ease,color .15s ease,border .15s ease}
    #yearReset:hover{border-color:var(--accent);color:var(--accent)}

    /* Scroll to top button */
    .scroll-top{position:fixed;right:18px;bottom:18px;z-index:30;border:1px solid var(--border);background:rgba(15,18,23,0.9);color:var(--accent);border-radius:999px;width:52px;height:52px;display:inline-flex;align-items:center;justify-content:center;font-weight:700;cursor:pointer;opacity:0;transform:translateY(8px) scale(.94);pointer-events:none;box-shadow:0 8px 24px rgba(0,0,0,.25);transition:opacity .2s ease,transform .24s ease,box-shadow .24s ease,background .2s ease,color .2s ease}
    .scroll-top:hover{border-color:var(--accent);color:#0b1524;background:var(--accent);box-shadow:0 10px 26px rgba(106,166,255,0.25)}
    .scroll-top:active{transform:translateY(0) scale(.94)}
    .scroll-top.visible{opacity:1;transform:translateY(0) scale(1);pointer-events:auto}
    .scroll-top.appearing{animation:scrollTopPop .24s cubic-bezier(.2,.7,.3,1) 1}
    .scroll-top.pressed{animation:scrollTopPress .18s ease 1}
    .scroll-top svg{width:22px;height:22px;display:block}
    .scroll-top.visible:not(.pressed):not(:hover){animation:scrollTopPulse 3.6s ease-in-out infinite .6s}
    @keyframes scrollTopPop{0%{transform:translateY(10px) scale(.86);opacity:.0}60%{transform:translateY(0) scale(1.04);opacity:1}100%{transform:translateY(0) scale(1)}}
    @keyframes scrollTopPress{0%{transform:translateY(0) scale(1)}70%{transform:translateY(0) scale(.92)}100%{transform:translateY(0) scale(1)}}
    @keyframes scrollTopPulse{0%,100%{box-shadow:0 8px 24px rgba(0,0,0,.25)}50%{box-shadow:0 12px 30px rgba(106,166,255,0.28)}}
    @media (prefers-reduced-motion: reduce){
      .scroll-top{transition:none}
      .scroll-top.appearing,.scroll-top.pressed,.scroll-top.visible{animation:none}
    }

    /* Detail Modal */
    .modal[hidden]{ display:none }
    .modal{ position:fixed; inset:0; z-index:100; display:grid; place-items:center; }
    .modal::before{
      content:""; position:absolute; inset:0; background:rgba(0,0,0,.55); backdrop-filter:blur(8px) saturate(120%);
      opacity:0; transition:opacity .2s ease; pointer-events:none; z-index:0;
    }
    .modal.open::before{ opacity:1 }
    .modal__panel{
      position:relative; width:min(980px, 92vw); max-height:86vh; overflow:auto;
      background:#0b0d10; border:1px solid #1d2635; border-radius:16px;
      box-shadow:0 30px 120px rgba(0,0,0,.6);
      transform: translateY(8px); opacity:0; transition:transform .2s ease, opacity .2s ease;
      z-index:1;
    }
    .modal.open .modal__panel{ transform:none; opacity:1 }
    /* no image backdrop; we blur the page behind */
    .modal__close{
      position:absolute; top:12px; right:12px;
      width:36px; height:36px; display:inline-flex; align-items:center; justify-content:center;
      border:none; background:rgba(15,18,23,0.9); color:var(--muted);
      border:1px solid var(--border); border-radius:999px; cursor:pointer; line-height:1; pointer-events:auto; z-index:3;
    }
    .modal__close:hover{ border-color:var(--accent); color:var(--accent) }
    .modal__hero{ display:grid; grid-template-columns:180px 1fr; gap:16px; padding:16px }
    .modal__poster img{ width:100%; aspect-ratio:2/3; object-fit:cover; border-radius:12px; display:block; opacity:0; transition:opacity .25s ease }
    .modal__poster img.is-ready{ opacity:1 }
    .modal__head .subline{ opacity:.9; color:#cfd6e2; margin:.25rem 0 .5rem }
    .modal__head .chips{ display:flex; flex-wrap:wrap; gap:.5rem }
    .chips .chip{ padding:.25rem .6rem; border-radius:999px; background:#1a2230; border:1px solid #263147 }
    .modal__body{ padding:0 16px 16px }
    .overview{ margin:.5rem 0 1rem; color:#d8dde6 }
    .cast{ display:flex; flex-wrap:wrap; gap:.5rem; margin-top:.5rem }
    .cast .chip{ opacity:.92 }
    .seasons{ margin-top:1rem }
    .season{ display:flex; gap:12px; padding:8px; border:1px solid #263147; border-radius:10px; margin-bottom:8px; background:#0f141d }
    .episodes{ margin-left:192px; margin-top:4px }

    /* Modal nav arrows */
    .modal__arrow{ position:absolute; top:50%; transform:translateY(-50%); width:54px; height:54px; border-radius:999px; border:1px solid rgba(106,166,255,0.35); background:linear-gradient(180deg, rgba(20,24,29,0.95), rgba(13,16,21,0.95)); color:#cfe1ff; display:inline-flex; align-items:center; justify-content:center; cursor:pointer; z-index:2; opacity:.92; transition:transform .18s ease, box-shadow .25s ease, opacity .2s ease }
    .modal__arrow:hover{ transform:translateY(-50%) scale(1.06); box-shadow:0 8px 22px rgba(0,0,0,.35), 0 0 0 2px rgba(106,166,255,0.25) inset }
    .modal__arrow:active{ transform:translateY(-50%) scale(.96) }
    .modal__arrow[disabled]{ opacity:.35; pointer-events:none; filter:saturate(60%) }
    .modal__arrow--prev{ left:clamp(8px, 3vw, 24px) }
    .modal__arrow--next{ right:clamp(8px, 3vw, 24px) }
    .modal__arrow .chev{ font-size:28px; line-height:1; transform:translateY(-1px) }
    .modal.is-updating .modal__arrow{ opacity:.6; transform:translateY(-50%) scale(.98) }

    /* Crossfade for title, overview, chips, cast and actions */
    #mTitle, #mOverview, #mChips, #mCast, #mActions{ transition: opacity .25s ease, transform .25s ease; will-change: opacity, transform }
    .modal.is-updating #mTitle, .modal.is-updating #mOverview, .modal.is-updating #mChips, .modal.is-updating #mCast, .modal.is-updating #mActions{ opacity:0; transform:translateY(2px) }

    /* Seasons accordion for TV shows */
    .seasons-accordion{ display:flex; flex-direction:column; gap:.75rem; }

    .season-card{
      border:1px solid #263147; background:#0f141d;
      border-radius:12px; overflow:hidden;
    }

    .season-head{
      display:grid; grid-template-columns:84px 1fr 24px;
      align-items:center; gap:12px;
      padding:10px 12px; cursor:pointer;
    }
    .season-thumb img{
      width:100%; aspect-ratio:2/3; object-fit:cover; border-radius:6px;
    }
    .season-title{ font-weight:700; }
    .season-sub{ color:#9fb0c6; opacity:.9; margin-top:2px; }

    .chev{
      width:24px; height:24px; display:grid; place-items:center;
      border-radius:6px; border:1px solid #263147; background:#101728;
      transition: transform .18s ease;
    }
    .season-card.open .chev{ transform:rotate(90deg); }

    .season-body{ display:none; padding:10px 12px 12px; }
    .season-card.open .season-body{ display:block; animation: fadeSlide .18s ease; }

    @keyframes fadeSlide{ from{opacity:0; transform:translateY(4px)} to{opacity:1; transform:none} }

    .episode{
      display:grid; grid-template-columns: 1fr auto; gap:8px;
      padding:8px 0; border-bottom:1px dashed #22304a;
      content-visibility:auto; contain-intrinsic-size: 48px;
    }
    .episode:last-child{ border-bottom:none; }
    .ep-title{ font-weight:600; }
    .ep-meta{ color:#9fb0c6; font-size:.9rem; }
    .badges{ display:flex; gap:.4rem; align-items:center; }
    .badge{
      padding:.15rem .5rem; border-radius:999px;
      border:1px solid #2b3a59; background:#121a2b; font-size:.85rem;
    }

    /* Modal modern overrides and additions */
    .modal__hero{ display:grid; grid-template-columns:180px 1fr; gap:18px; padding:16px 16px 10px }
    .modal__poster{ align-self:start }
    .modal__poster img{ aspect-ratio:2/3; border-radius:12px }
    .modal__head{ display:grid; grid-template-rows:auto auto auto; gap:6px }
    .modal__head .topbar{ display:flex; align-items:center; justify-content:space-between; gap:12px }
    .modal__head h2#mTitle{ font-size:clamp(20px,2.2vw,28px); line-height:1.2 }
    .util-actions{ display:flex; gap:8px; flex-wrap:wrap }
    .util-actions a, .util-actions button{ appearance:none; border:1px dashed #2a3a56; background:transparent; color:#cfe1ff; border-radius:999px; padding:6px 10px; font-size:13px; cursor:pointer; opacity:.95 }
    .util-actions a:hover, .util-actions button:hover{ border-style:solid; border-color:var(--accent); color:var(--accent); background:rgba(106,166,255,0.12) }
    .modal__subnav{ position:sticky; top:0; z-index:2; background:linear-gradient(180deg, rgba(11,13,16,0.96), rgba(11,13,16,0.85)); backdrop-filter:saturate(140%) blur(8px); border-block:1px solid rgba(255,255,255,0.06) }
    .modal__subnav .inner{ display:flex; gap:8px; padding:10px 12px }
    .modal__subnav button{ border:1px solid var(--border); background:#0f141d; color:#c8d5e8; border-radius:999px; padding:6px 10px; font-size:13px; cursor:pointer; opacity:.9 }
    .modal__subnav button.active{ border-color:var(--accent); color:var(--accent); background:rgba(106,166,255,0.12) }
    .modal-section{ padding:12px 0 }
    .overview{ max-width:72ch; line-height:1.6; hyphens:auto }
    .chips .chip{ padding:.25rem .6rem; border-radius:999px; background:#1a2230; border:1px solid #263147; color:#cfe1ff }
    .chips .chip.more{ background:transparent; border-style:dashed; color:var(--accent) }
    @media (max-width: 720px){ .modal__hero{ grid-template-columns:120px 1fr } }
    @media (max-width: 480px){ .modal__hero{ grid-template-columns:1fr } .modal__poster{ max-width:68% } .modal__poster img{ margin:0 auto } }

    /* --- Modal Tweaks: Raum, Hierarchie, Rhythmus --- */

    /* Hero: mehr Luft, bessere Raster */
    .modal__hero{
      grid-template-columns: 200px 1fr;
      gap: 20px 18px;
      padding: 18px 18px 8px;
    }
    @media (max-width: 900px){ .modal__hero{ grid-template-columns: 160px 1fr } }
    @media (max-width: 720px){ .modal__hero{ grid-template-columns: 120px 1fr } }
    @media (max-width: 560px){ .modal__hero{ grid-template-columns: 1fr } }

    .modal__head{ display:grid; gap: 8px }
    .modal__head .topbar{ display:grid; grid-template-columns: 1fr; gap:6px; align-items:start }
    .util-actions{ display:flex; gap: 6px; flex-wrap: wrap }
    .util-actions a, .util-actions button{
      border: 1px solid rgba(106,166,255,.28);
      background: rgba(16,23,40,.6);
      padding: 6px 12px;
      border-radius: 999px;
    }
    .util-actions a:hover, .util-actions button:hover{
      background: rgba(106,166,255,.12);
    }

    /* Chips ruhiger + "mehr" */
    .chips{ display:flex; flex-wrap:wrap; gap: 6px; margin-top: 6px }
    .chips .chip{
      background: #162033;
      border: 1px solid #24314a;
      color: #cfe1ff;
      border-radius: 999px;
      padding: .25rem .6rem;
    }
    .chips .chip.more{
      background: transparent;
      border-style: dashed;
      border-color: #2a3a56;
      color: var(--accent, #6aa6ff);
      cursor: pointer;
    }

    /* Sticky Tabs + Anker */
    .modal__subnav{ top: 0 }
    .modal-section{ padding: 12px 16px 16px; scroll-margin-top: 58px }

    /* Lesbarkeit der Overview */
    .overview{
      max-width: 72ch;
      line-height: 1.65;
      font-size: 0.98rem;
      color: #d8dde6;
      text-wrap: pretty;
      hyphens: auto;
    }

    /* Seasons kompakter */
    .season-card{ border-radius: 12px; overflow: hidden }
    .season-head{
      grid-template-columns: 84px 1fr auto;
      padding: 10px 12px;
    }
    .season-sub{ font-size: .92rem }
    .chev{
      width: 28px; height: 28px;
      display:grid; place-items:center;
      border: 1px solid #2a3a56;
      background: rgba(16,23,40,.6);
      border-radius: 8px;
      transition: transform .18s ease;
    }
    .season-card.open .chev{ transform: rotate(90deg) }

    .season-body{ padding: 8px 12px 10px }
    .episode{
      grid-template-columns: 1fr auto;
      gap: 10px; padding: 8px 0;
      border-bottom: 1px dashed #23324c;
    }
    .episode:last-child{ border-bottom: none }
    .ep-title{ font-weight: 600 }
    .ep-meta{ color: #9fb0c6; font-size: .9rem; grid-column: 2; text-align: right }

    /* Dezentere Scrollbar im Panel (WebKit/Chromium) */
    .modal__panel::-webkit-scrollbar{ width: 10px }
    .modal__panel::-webkit-scrollbar-thumb{
      background: rgba(255,255,255,.12);
      border-radius: 999px;
      border: 2px solid #0b0d10;
    }

    /* Motion-Reduktion respektieren */
    @media (prefers-reduced-motion: reduce){
      .chev, .season-card.open .season-body{ transition: none; animation: none }
    }

</style>

</head>

<body>

<header class="site-header">

  <div class="site-header__inner">

    <img src="assets/plex-katalog-logo.png" alt="Plex-Katalog" class="site-header__logo" id="siteLogo">

    <div class="site-header__meta">

      <h1 class="site-title">Plex-Katalog</h1>

      <p class="site-tagline" id="heroSubtitle">Offline stöbern & Wunschlisten teilen</p>

    </div>

    <div class="site-header__stats" id="heroStats" aria-live="polite">-- Filme | -- Serien</div>

  </div>

  <div class="grain" aria-hidden="true"></div>

</header>

<div id="scrollProgress" style="position:sticky;top:0;z-index:6;height:3px;background:linear-gradient(90deg,var(--accent),#f9b233);width:0%;box-shadow:0 1px 0 rgba(0,0,0,.25)"></div>

  <section class="filters" id="filterBar">

  <div class="wrap filters-wrap">

    <div class="filters-main">

      <div class="library-switch" id="librarySwitch" role="group" aria-label="Bibliotheken"></div>

      <div class="field search">

        <label class="sr-only" for="q">Suche</label>

        <span class="icon" aria-hidden="true">S</span>

        <input id="q" type="search" placeholder="Suche Titel, Darsteller, Studio..." autocomplete="off" />

      </div>

      <div class="field sort">

        <span class="icon" aria-hidden="true">O</span>

        <select id="sort">

          <option value="title-asc">Titel (A-Z)</option>

          <option value="title-desc">Titel (Z-A)</option>

          <option value="year-desc">Jahr (neueste)</option>

          <option value="year-asc">Jahr (&auml;lteste)</option>

          <option value="rating-desc">Bewertung (hoch)</option>

          <option value="rating-asc">Bewertung (niedrig)</option>

          <option value="added-desc">Zuletzt hinzugef&uuml;gt</option>

          <option value="added-asc">Zuerst hinzugef&uuml;gt</option>

        </select>

      </div>

      <button id="watchlistToggle" type="button" class="watchlist-button" aria-expanded="false">Merkliste <span class="count" id="watchlistCount">0</span></button>

      <button id="toggleAdvanced" class="toggle-advanced" aria-expanded="false">Erweiterte Filter anzeigen</button>
      <button id="settingsBtn" type="button" class="settings-button" aria-haspopup="dialog" aria-controls="settingsOverlay">Einstellungen</button>

    </div>

    <div class="filters-advanced" id="advancedFilters" hidden>

      <div class="advanced-row">

        <div class="field chips">

          <span class="icon" aria-hidden="true">G</span>

          <div id="genreFilters" class="chip-group" data-empty="Alle Genres" data-state="empty"></div>

        </div>

        <div class="field collections">

          <span class="icon" aria-hidden="true">C</span>

          <select id="collectionFilter"><option value="">Alle Collections</option></select>

        </div>

        <div class="field year">

          <span class="icon" aria-hidden="true">Y</span>

          <select id="yearFrom"><option value="">Ab Jahr</option></select>

          <select id="yearTo"><option value="">Bis Jahr</option></select>

          <button type="button" id="yearReset" title="Jahresfilter zurücksetzen">Reset</button>

        </div>

        <div class="field toggles">

          <label class="toggle-chip"><input id="onlyNew" type="checkbox" /> Neu (<=30 Tage)</label>

          <label class="toggle-chip"><input id="groupCollections" type="checkbox" /> Sammlungen bündeln</label>



        </div>

      </div>

    </div>

  </div>

</section>

<section class="watchlist-panel" id="watchlistPanel" hidden>

  <div class="watchlist-header">

    <h2 class="watchlist-title">Merkliste</h2>

    <div class="watchlist-actions">

      <button type="button" class="primary" id="exportWatchlist">Merkliste exportieren</button>

      <button type="button" id="clearWatchlist">Merkliste leeren</button>

      <button type="button" id="closeWatchlist">Schließen</button>

    </div>

  </div>

   Einträge gemerkt.

  <ul class="watchlist-items" id="watchlistItems"></ul>

</section>

<main>

  <div id="grid" class="grid"></div>

  <div id="empty" class="empty" hidden>Kein Treffer. Filter lockern?</div>

</main>

<footer class="wrap">
  <div class="footer-top">
    <div class="footer-meta" id="footerMeta">Plex-Katalog lädt.</div>
    <div class="footer-actions">
      <a href="#" id="openSettings" class="btn">Einstellungen öffnen</a>
      <a href="#" id="openWatchlist" class="btn">Merkliste anzeigen</a>
    </div>
  </div>
   ist Nils' aktuelle Plex-Mediathek &ndash; was gerade so da ist.
</footer>

<button id="scrollTop" class="scroll-top" aria-label="Nach oben" title="Nach oben">
  <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
    <path d="M6 14l6-6 6 6" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
  </svg>
</button>

<!-- Einstellungen Overlay -->
<div id="settingsOverlay" class="settings-overlay" role="dialog" aria-modal="true" aria-labelledby="settingsTitle" hidden>
  <div class="settings-dialog">
    <div class="settings-header">
      <h2 id="settingsTitle" class="settings-title">Einstellungen</h2>
    </div>
    <div class="settings-body">
      <div class="settings-row">
        <label for="tmdbTokenInput">TMDB v4 Access Token</label>
        <input id="tmdbTokenInput" type="password" placeholder="Bearer Token eingeben" autocomplete="off" />
        <div class="settings-inline">
          <button type="button" id="tmdbSave" class="primary">Token speichern</button>
          <button type="button" id="tmdbClearCache">TMDB-Cache leeren</button>
        </div>
        <p class="settings-help">Token wird lokal (localStorage) gespeichert. Leerlassen, um TMDB zu deaktivieren.</p>
      </div>
      <div class="settings-row">
        <label class="settings-inline"><input id="prefReduceMotion" type="checkbox" /> Animationen reduzieren</label>
      </div>
      <div class="settings-row">
        <label class="settings-inline"><input id="useTmdbSetting" type="checkbox" /> TMDB-Bilder nutzen</label>
        <p class="settings-help">Nur verfügbar mit gültigem Token.</p>
      </div>
      <div class="settings-row">
        <div class="settings-inline">
          <button type="button" id="resetFilters">Filter zurücksetzen</button>
        </div>
      </div>
    </div>
    <div class="settings-actions">
      <button type="button" id="settingsClose2">Schließen</button>
    </div>
  </div>
</div>

<script>

const CONFIG = {

  libraries: {

    movies: {

      label: 'Filme',

      countLabel: 'Filme',

      scriptUrl: 'Filme/movies.js',

      jsonUrl: 'Filme/movies.json',

      thumbBase: 'Filme/',

      exportKey: 'movies',

      globalVar: '__PLEX_MOVIES__',

      scriptId: 'movies-json',

      tmdbType: 'movie',

    },

    shows: {

      label: 'Serien',

      countLabel: 'Serien',

      scriptUrl: 'Serien/series.js',

      jsonUrl: 'Serien/series.json',

      thumbBase: 'Serien/',

      exportKey: 'shows',

      globalVar: '__PLEX_SHOWS__',

      scriptId: 'series-json',

      tmdbType: 'tv',

    },

  },

  defaultLibrary: 'movies',

  tmdbAccessToken: '',

  tmdbApiKey: '',

  tmdbLang: 'de-DE',

  newDays: 30,

  imageWidths: { poster: 'w342', backdrop: 'w780' },

};

// Read TMDB token from localStorage (no hardcoding)
CONFIG.tmdbAccessToken = localStorage.getItem('tmdbToken') || CONFIG.tmdbAccessToken || '';

function setTmdbToken(token){
  try{
    const t = String(token||'').trim();
    localStorage.setItem('tmdbToken', t);
    CONFIG.tmdbAccessToken = t;
  }catch{}
}

const state = {

  items: [],

  filtered: [],

  genres: [],

  years: [],

  collections: [],

  selectedCollection: '',

  groupCollections: false,

  collectionIndex: new Map(),

  ready: false,

  library: CONFIG.defaultLibrary,

  libraryBase: '',

  libraryType: 'movie',

  selectedGenres: new Set(),

  watchlist: new Map(),

  advancedExpanded: false,

  advancedManual: false,

};

let suppressSync = false;

const loadedScripts = new Set();

const libraryTotals = {};

Object.keys(CONFIG.libraries).forEach(key=>{ libraryTotals[key] = null; });

const heroElements = {

  subtitle: document.getElementById('heroSubtitle'),

  stats: document.getElementById('heroStats')

};

const TAGLINES = [

  "Offline stöbern & Wunschlisten teilen",

  "Nils Bibliothek, hübsch sortiert",

  "Filter. Finden. Freuen.",

  "Filme & Serien - stressfrei sichtbar",

  "Schneller als jeder SMB-Share",

  "Merkliste zuerst, Streit später"

];

let taglineIdx = 0;

function rotateTagline(){

  const el = heroElements.subtitle;

  if(!el || el.dataset.taglinePaused === '1') return;

  el.classList.add('is-fading');

  setTimeout(()=>{

    if(!heroElements.subtitle || heroElements.subtitle.dataset.taglinePaused === '1'){

      el.classList.remove('is-fading');

      return;

    }

    taglineIdx = (taglineIdx + 1) % TAGLINES.length;

    el.textContent = TAGLINES[taglineIdx];

    el.classList.remove('is-fading');

  }, 280);

}

if(heroElements.subtitle){

  heroElements.subtitle.textContent = TAGLINES[taglineIdx];

  heroElements.subtitle.dataset.taglinePaused = '0';

  if(!window.__taglineTicker){

    window.__taglineTicker = setInterval(rotateTagline, 6000);

    setTimeout(rotateTagline, 3000);

  }

}

const siteLogo = document.getElementById('siteLogo');

if(siteLogo){

  siteLogo.addEventListener('error', ()=>{

    siteLogo.classList.add('logo-missing');

    const titleEl = document.querySelector('.site-header__meta h1');

    if(titleEl) titleEl.classList.remove('sr-only');

  });

}

(function setHeaderThemeByTime(){

  const h = new Date().getHours();

  const root = document.documentElement;

  if(h >= 6 && h < 11){

    root.style.setProperty('--hdr-a','rgba(255,214,106,0.38)');

    root.style.setProperty('--hdr-b','rgba(106,166,255,0.35)');

  }else if(h >= 11 && h < 18){

    root.style.setProperty('--hdr-a','rgba(106,166,255,0.38)');

    root.style.setProperty('--hdr-b','rgba(92,236,210,0.32)');

  }else{

    root.style.setProperty('--hdr-a','rgba(196,106,255,0.32)');

    root.style.setProperty('--hdr-b','rgba(255,106,178,0.28)');

  }

})();

const scrollProgress = document.getElementById('scrollProgress');
const scrollTopBtn = document.getElementById('scrollTop');

if(scrollProgress){

  const updateScrollProgress = ()=>{

    const doc = document.documentElement;

    const max = doc.scrollHeight - doc.clientHeight;

    const pct = max > 0 ? (doc.scrollTop / max) * 100 : 0;

    scrollProgress.style.width = pct + '%';

    if(scrollTopBtn){
      const show = doc.scrollTop > 120;
      const wasVisible = scrollTopBtn.classList.contains('visible');
      if(show && !wasVisible){
        scrollTopBtn.classList.add('visible','appearing');
        setTimeout(()=>scrollTopBtn && scrollTopBtn.classList.remove('appearing'), 280);
      }else if(!show && wasVisible){
        scrollTopBtn.classList.remove('visible','appearing');
      }
    }

  };

  addEventListener('scroll', updateScrollProgress, { passive:true });

  updateScrollProgress();

}

if(scrollTopBtn){
  scrollTopBtn.addEventListener('click', ()=>{
    // press animation
    try{ scrollTopBtn.classList.add('pressed'); setTimeout(()=>scrollTopBtn && scrollTopBtn.classList.remove('pressed'), 220); }catch{}
    const reduce = document.documentElement.classList.contains('reduce-motion');
    try{ window.scrollTo({ top: 0, behavior: reduce ? 'auto' : 'smooth' }); }
    catch{ window.scrollTo(0,0); }
  });
}

const WATCHLIST_STORAGE_KEY = 'plexWatchlist';

const WATCHLIST_EXPORTED_KEY = 'plexWatchlistExported';

let watchlistDirty = false;

let watchlistExported = false;

let sessionStore = null;

const $ = (q, el=document) => el.querySelector(q);

const $$ = (q, el=document) => Array.from(el.querySelectorAll(q));

const day = 24*60*60*1000;

const dedup = arr => Array.from(new Set(arr));

function debounce(fn, ms = 120){

  let t;

  return function(...args){

    clearTimeout(t);

    t = setTimeout(function(){ fn(...args); }, ms);

  };

}

// Normalize strings for robust search (e.g., Umlaute)
const norm = s => String(s||'')
  .normalize('NFD')
  .replace(/[\u0300-\u036f]/g,'')
  .toLowerCase();

function parseGuids(item){

  const ids = { imdb:null, tmdb:null, tvdb:null };

  (item.guids||[]).forEach(g=>{

    const id = g && g.id || '';

    if(id.startsWith('imdb://')) ids.imdb = id.replace('imdb://','');

    if(id.startsWith('tmdb://')) ids.tmdb = id.replace('tmdb://','');

    if(id.startsWith('tvdb://')) ids.tvdb = id.replace('tvdb://','');

  });

  return ids;

}

function humanYear(item){

  if(item.year) return item.year;

  if(item.originallyAvailableAt) return String(item.originallyAvailableAt).slice(0,4);

  return '';

}

function loadTmdbCache(){

  try{

    return new Map(JSON.parse(localStorage.getItem('tmdbCache')||'[]'));

  }catch{ return new Map(); }

}

const tmdbCache = loadTmdbCache();

const persistTmdbCache = ()=>localStorage.setItem('tmdbCache', JSON.stringify(Array.from(tmdbCache.entries())));

function clearTmdbCache(){
  try{ tmdbCache.clear(); persistTmdbCache(); }catch{}
}

// Reduce-motion preference handling
function applyReduceMotionPref(){
  try{
    const pref = localStorage.getItem('prefReduceMotion') === '1';
    document.documentElement.classList.toggle('reduce-motion', pref);
  }catch{}
}
applyReduceMotionPref();

// TMDB preference helpers
function getUseTmdbPref(){
  try{ return localStorage.getItem('useTmdb') === '1'; }catch{ return false; }
}
function setUseTmdbPref(on){
  try{ localStorage.setItem('useTmdb', on ? '1' : '0'); }catch{}
}
function useTmdbEnabled(){
  const hasToken = Boolean(CONFIG.tmdbAccessToken);
  return hasToken && getUseTmdbPref();
}

function formatRating(val){

  if(val === undefined || val === null || val === '') return '';

  const num = Number(val);

  if(Number.isFinite(num)){

    const fixed = num.toFixed(1);

    return fixed.endsWith('.0') ? fixed.slice(0,-2) : fixed;

  }

  return String(val).trim();

}

function slugify(text){

  const base = String(text||'')

    .normalize('NFD')

    .replace(/[\u0300-\u036f]/g,'');

  const transliterated = base.replace(/[ÄÖÜäöüß]/g,char=>({
    'Ä':'Ae','Ö':'Oe','Ü':'Ue','ä':'ae','ö':'oe','ü':'ue','ß':'ss'
  })[char]||char);

  return transliterated

    .toLowerCase()

    .replace(/[^a-z0-9]+/g,'-')

    .replace(/^-+|-+$/g,'')

    || 'collection';

}

function itemIdentity(item){

  if(!item) return '';

  if(item.ratingKey != null) return `rating:${item.ratingKey}`;

  if(item.guid) return `guid:${item.guid}`;

  return `title:${(item.title||item.originalTitle||'').toLowerCase()}|${humanYear(item)||''}`;

}

function collectionTags(item){

  return ((item && item.collections) || [])

    .map(entry=>{

      if(!entry) return '';

      return entry.tag || entry.title || entry.name || '';

    })

    .filter(Boolean);

}

function collectionWatchlistKey(name){

  return `collection:${state.library}:${slugify(name)}`;

}

function buildCollectionIndex(items){

  const map = new Map();

  (items||[]).forEach(item=>{

    collectionTags(item).forEach(name=>{

      if(!map.has(name)) map.set(name, []);

      map.get(name).push(item);

    });

  });

  map.forEach(list=>{

    list.sort((a,b)=>{

      const ay = Number(humanYear(a)) || 0;

      const by = Number(humanYear(b)) || 0;

      if(ay !== by) return ay - by;

      return (a.title||'').localeCompare(b.title||'', 'de');

    });

  });

  return map;

}

function isNew(item){

  if(!item.addedAt) return false;

  const added = new Date(item.addedAt).getTime();

  if(!Number.isFinite(added)) return false;

  return Date.now() - added <= CONFIG.newDays * day;

}

function matches(item){

  const query = norm($('#q').value.trim());

  const onlyNew = $('#onlyNew').checked;

  const yearFrom = Number($('#yearFrom').value) || null;

  const yearTo = Number($('#yearTo').value) || null;

  const genresActive = state.selectedGenres;

  const selectedCollection = state.selectedCollection;

  const itemCollections = collectionTags(item);

  if(query){

    const haystack = norm([
      item.title,
      item.originalTitle,
      item.summary,
      item.studio,
      (item.genres||[]).map(g=>g && g.tag).join(' '),
      (item.roles||[]).map(r=>r && (r.tag||r.role)).join(' '),
      itemCollections.join(' '),
    ].filter(Boolean).join(' '));

    if(!haystack.includes(query)) return false;

  }

  if(onlyNew && !isNew(item)) return false;

  const year = Number(humanYear(item)) || null;

  if(yearFrom && (!year || year < yearFrom)) return false;

  if(yearTo && (!year || year > yearTo)) return false;

  if(genresActive.size){

    const itemGenres = new Set((item.genres||[]).map(g=>g && g.tag));

    for(const g of genresActive){

      if(!itemGenres.has(g)) return false;

    }

  }

  if(selectedCollection){

    if(!itemCollections.includes(selectedCollection)) return false;

  }

  return true;

}

function applySort(list){

  const mode = $('#sort').value;

  const value = (item) => ({

    title: (item.title || '').toLowerCase(),

    year: Number(humanYear(item)) || 0,

    rating: item.audienceRating ?? item.rating ?? 0,

    added: item.addedAt ? new Date(item.addedAt).getTime() : 0,

  });

  list.sort((a,b)=>{

    const av = value(a);

    const bv = value(b);

    switch(mode){

      case 'title-asc': return av.title.localeCompare(bv.title,'de');

      case 'title-desc': return bv.title.localeCompare(av.title,'de');

      case 'year-desc': return bv.year - av.year;

      case 'year-asc': return av.year - bv.year;

      case 'rating-desc': return (bv.rating||0) - (av.rating||0);

      case 'rating-asc': return (av.rating||0) - (bv.rating||0);

      case 'added-desc': return (bv.added||0) - (av.added||0);

      case 'added-asc': return (av.added||0) - (bv.added||0);

      default: return av.title.localeCompare(bv.title,'de');

    }

  });

}

function countTo(el, target, prev=0, dur=600){

  if(!el) return;

  if(!Number.isFinite(target)){

    el.textContent = target;

    el.dataset.value = String(target);

    return;

  }

  const startValue = Number(el.dataset.value) || prev;

  const start = performance.now();

  function tick(t){

    const k = Math.min(1, (t - start)/dur);

    const eased = 1 - Math.pow(1 - k, 3);

    const val = Math.round(startValue + (target - startValue) * eased);

    el.textContent = val.toLocaleString('de-DE');

    if(k < 1){

      requestAnimationFrame(tick);

    }else{

      el.textContent = target.toLocaleString('de-DE');

      el.dataset.value = String(target);

    }

  }

  requestAnimationFrame(tick);

}

function updateHeroStatsDisplay(){

  const el = heroElements.stats;

  if(!el) return;

  const numbers = Array.from(el.textContent.match(/(\d+)/g) || []);

  const oldMovies = Number(numbers[0]) || 0;

  const oldShows = Number(numbers[1]) || 0;

  const movies = libraryTotals.movies ?? '--';

  const shows = libraryTotals.shows ?? '--';

  if(Number.isFinite(movies) && Number.isFinite(shows)){

    el.innerHTML = `<span id="statMovies">${oldMovies}</span> Filme | <span id="statShows">${oldShows}</span> Serien`;

    countTo(document.getElementById('statMovies'), movies, oldMovies);

    countTo(document.getElementById('statShows'), shows, oldShows);

  }else{

    el.textContent = `${movies} Filme | ${shows} Serien`;

  }

}

function libraryDefinition(key = state.library){

  return CONFIG.libraries[key] || null;

}

function localThumbUrl(item){

  if(!item.thumbFile) return '';

  const base = state.libraryBase ? state.libraryBase.replace(/\/?$/, '/') : '';

  return `${base}${item.thumbFile}`;

}

function normalizeItems(raw){

  if(Array.isArray(raw)) return raw;

  if(raw && Array.isArray(raw.Metadata)) return raw.Metadata;

  if(raw && Array.isArray(raw.items)) return raw.items;

  return [];

}

async function loadLibraryPayload(def, key){

  const globalBag = window.__PLEX_EXPORTER__ || {};

  if(def.exportKey && Array.isArray(globalBag[def.exportKey])){

    return globalBag[def.exportKey];

  }

  if(def.globalVar && Array.isArray(window[def.globalVar])){

    return window[def.globalVar];

  }

  const embedded = document.getElementById(def.scriptId || `${key}-json`);

  if(embedded){

    try{ return JSON.parse(embedded.textContent); }

    catch(err){ console.warn('Embedded JSON parse failed', err); }

  }

  if(!loadedScripts.has(def.scriptUrl)){

    await new Promise((resolve, reject)=>{

      const script = document.createElement('script');

      script.src = def.scriptUrl;

      script.async = true;

      script.onload = ()=>{ loadedScripts.add(def.scriptUrl); resolve(); };

      script.onerror = reject;

      document.head.appendChild(script);

    });

    if(def.exportKey && Array.isArray((window.__PLEX_EXPORTER__||{})[def.exportKey])){

      return window.__PLEX_EXPORTER__[def.exportKey];

    }

    if(def.globalVar && Array.isArray(window[def.globalVar])){

      return window[def.globalVar];

    }

  }

  try{

    const res = await fetch(def.jsonUrl, { cache: 'no-store' });

    if(res.ok){

      const json = await res.json();

      return json;

    }

  }catch(err){

    console.warn('Fetch fallback failed', err);

  }

  return [];

}

function collectFacets(){

  const allGenres = [];

  const allYears = [];

  state.items.forEach(item=>{

    (item.genres||[]).forEach(g=>{ if(g && g.tag) allGenres.push(g.tag); });

    const yr = humanYear(item);

    if(yr) allYears.push(String(yr));

  });

  state.collectionIndex = buildCollectionIndex(state.items);

  state.genres = dedup(allGenres).sort((a,b)=>a.localeCompare(b,'de'));

  state.years = dedup(allYears).sort((a,b)=>Number(b)-Number(a));

  state.collections = Array.from(state.collectionIndex.keys()).sort((a,b)=>a.localeCompare(b,'de'));

  const available = new Set(state.genres);

  state.selectedGenres = new Set(Array.from(state.selectedGenres).filter(g=>available.has(g)));

  if(!state.collections.includes(state.selectedCollection)){

    state.selectedCollection = '';

  }

  if(state.collections.length === 0){

    state.groupCollections = false;

  }

}

function fillFilters(){

  const genreHolder = $('#genreFilters');

  if(genreHolder){

    genreHolder.innerHTML = '';

    if(!state.genres.length){

      genreHolder.dataset.state = 'empty';

    }else{

      genreHolder.dataset.state = '';

    }

    state.genres.forEach(name=>{

      const btn = document.createElement('button');

      btn.type = 'button';

      btn.className = 'chip-filter';

      btn.textContent = name;

      btn.setAttribute('aria-pressed', state.selectedGenres.has(name) ? 'true' : 'false');

      if(state.selectedGenres.has(name)) btn.classList.add('selected');

      btn.addEventListener('click', ()=>{

        if(state.selectedGenres.has(name)){

          state.selectedGenres.delete(name);

        }else{

          state.selectedGenres.add(name);

        }

        update();

      });

      genreHolder.appendChild(btn);

    });

  }

  const collectionSelect = $('#collectionFilter');

  if(collectionSelect){

    const prev = collectionSelect.value;

    collectionSelect.innerHTML = '<option value="">Alle Collections</option>';

    state.collections.forEach(name=>{

      const opt = document.createElement('option');

      opt.value = name;

      opt.textContent = name;

      collectionSelect.appendChild(opt);

    });

    if(state.selectedCollection && state.collections.includes(state.selectedCollection)){

      collectionSelect.value = state.selectedCollection;

    }else if(prev && state.collections.includes(prev)){

      collectionSelect.value = prev;

      state.selectedCollection = prev;

    }else{

      collectionSelect.value = '';

      state.selectedCollection = '';

    }

    const disabled = state.collections.length === 0;

    collectionSelect.disabled = disabled;

    const collectionsField = collectionSelect.closest('.field');

    if(collectionsField){

      collectionsField.classList.toggle('is-disabled', disabled);

    }

  }

  const groupToggle = $('#groupCollections');

  if(groupToggle){

    const disableToggle = state.collections.length === 0 || Boolean(state.selectedCollection);

    groupToggle.disabled = disableToggle;

    if(disableToggle){

      state.groupCollections = false;

    }

    groupToggle.checked = Boolean(state.groupCollections);

    const label = groupToggle.closest('label');

    if(label){

      label.classList.toggle('is-disabled', disableToggle);

    }

  }

  const yearFromSel = $('#yearFrom');

  const yearToSel = $('#yearTo');

  const prevFrom = yearFromSel ? yearFromSel.value : '';

  const prevTo = yearToSel ? yearToSel.value : '';

  if(yearFromSel){

    yearFromSel.innerHTML = '<option value="">Ab Jahr</option>';

    state.years.forEach(val=>{

      const opt = document.createElement('option');

      opt.value = val;

      opt.textContent = val;

      yearFromSel.appendChild(opt);

    });

    yearFromSel.value = prevFrom;

  }

  if(yearToSel){

    yearToSel.innerHTML = '<option value="">Bis Jahr</option>';

    state.years.forEach(val=>{

      const opt = document.createElement('option');

      opt.value = val;

      opt.textContent = val;

      yearToSel.appendChild(opt);

    });

    yearToSel.value = prevTo;

  }

}

function watchlistKey(item){

  if(!item) return '';

  if(item.isCollectionGroup || item.type === 'collection'){

    const name = item.collectionName || item.title || 'Collection';

    return collectionWatchlistKey(name);

  }

  if(item.ratingKey != null) return String(item.ratingKey);

  const base = [item.title||'', humanYear(item)||'', state.library].join('-');

  return base.trim().toLowerCase().replace(/\s+/g,'-');

}

function watchlistEntryFor(item){

  if(item && (item.isCollectionGroup || item.type === 'collection')){

    const members = (item.items||[]).map(child=>({

      key: watchlistKey(child),

      ratingKey: child.ratingKey ?? null,

      title: child.title || child.originalTitle || '-',

      year: humanYear(child) || '',

      duration: child.durationHuman || '',

    }));

    return {

      key: watchlistKey(item),

      ratingKey: null,

      title: item.title || item.collectionName || '-',

      originalTitle: '',

      year: humanYear(item) || '',

      library: state.library,

      libraryLabel: (CONFIG.libraries[state.library] && CONFIG.libraries[state.library].label) || state.library,

      type: 'collection',

      duration: '',

      genres: Array.isArray(item.genres) ? item.genres.slice(0,4) : [],

      studio: '',

      addedAt: item.addedAt || null,

      collectionName: item.collectionName || item.title || '',

      collectionItems: members,

      collectionSize: item.itemCount || members.length,

    };

  }

  return {

    key: watchlistKey(item),

    ratingKey: item.ratingKey ?? null,

    title: item.title || item.originalTitle || '-',

    originalTitle: item.originalTitle && item.originalTitle !== item.title ? item.originalTitle : '',

    year: humanYear(item) || '',

    library: state.library,

    libraryLabel: (CONFIG.libraries[state.library] && CONFIG.libraries[state.library].label) || state.library,

    type: item.type || state.libraryType,

    duration: item.durationHuman || '',

    genres: (item.genres||[]).map(g=>g && g.tag).filter(Boolean).slice(0,3),

    studio: item.studio || '',

    addedAt: item.addedAt || null,

  };

}

function applyWatchlistState(key, card, button){

  const active = key && state.watchlist.has(key);

  const isCollection = Boolean((card && card.dataset.collectionGroup === '1') || (button && button.dataset.collection === '1'));

  if(card) card.classList.toggle('in-watchlist', Boolean(active));

  if(button){

    button.classList.toggle('active', Boolean(active));

    button.setAttribute('aria-pressed', active ? 'true' : 'false');

    const activeLabel = isCollection ? 'Sammlung gemerkt' : 'Gemerkt';

    const inactiveLabel = isCollection ? 'Sammlung merken' : 'Merken';

    button.textContent = active ? activeLabel : inactiveLabel;

    button.title = active ? (isCollection ? 'Sammlung von der Merkliste entfernen' : 'Aus Merkliste entfernen') : (isCollection ? 'Komplette Sammlung zur Merkliste hinzufügen' : 'Zur Merkliste hinzufügen');

    const itemTitle = button.dataset.itemTitle || '';
    const ariaLabel = `${active ? 'Aus' : 'Zu'} Merkliste: ${itemTitle}`.trim();
    button.setAttribute('aria-label', ariaLabel);

  }

}

function refreshWatchlistIndicators(){

  $$('#grid .card').forEach(card=>{

    const key = card.dataset.watchlistKey;

    const btn = card.querySelector('.watchlist-toggle');

    applyWatchlistState(key, card, btn);

  });

}

function renderWatchlistItems(){

  const list = $('#watchlistItems');

  const empty = $('#watchlistEmpty');

  if(!list || !empty) return;

  list.innerHTML = '';

  if(state.watchlist.size === 0){

    empty.hidden = false;

    return;

  }

  empty.hidden = true;

  state.watchlist.forEach(entry=>{

    const li = document.createElement('li');

    li.className = 'watchlist-item';

    li.dataset.key = entry.key;

    const info = document.createElement('div');

    info.className = 'watchlist-item-info';

    const title = document.createElement('div');

    title.className = 'watchlist-item-title';

    const isCollection = entry.type === 'collection' && Array.isArray(entry.collectionItems);

    const displayTitle = entry.year && !isCollection ? `${entry.title} (${entry.year})` : (entry.title || entry.collectionName || '-');

    title.textContent = displayTitle;

    if(isCollection){

      const badge = document.createElement('span');

      badge.className = 'badge';

      badge.textContent = 'Sammlung';

      title.appendChild(badge);

      if(entry.collectionSize){

        const countBadge = document.createElement('span');

        countBadge.className = 'badge';

        countBadge.textContent = `${entry.collectionSize} ${entry.collectionSize === 1 ? 'Film' : 'Filme'}`;

        title.appendChild(countBadge);

      }

    }

    info.appendChild(title);

    if(entry.originalTitle && !isCollection){

      const original = document.createElement('div');

      original.className = 'watchlist-item-meta';

      original.textContent = `Original: ${entry.originalTitle}`;

      info.appendChild(original);

    }

    const metaParts = [];

    if(entry.libraryLabel) metaParts.push(entry.libraryLabel);

    if(isCollection){

      metaParts.push('Sammlung');

    }else if(entry.type && entry.type !== entry.libraryLabel){

      metaParts.push(entry.type);

    }

    if(!isCollection && entry.genres && entry.genres.length) metaParts.push(entry.genres.join(', '));

    if(!isCollection && entry.duration) metaParts.push(entry.duration);

    if(!isCollection && entry.studio) metaParts.push(entry.studio);

    if(metaParts.length){

      const meta = document.createElement('div');

      meta.className = 'watchlist-item-meta';

      meta.textContent = metaParts.join(' | ');

      info.appendChild(meta);

    }

    if(isCollection && entry.collectionItems && entry.collectionItems.length){

      const itemsWrap = document.createElement('div');

      itemsWrap.className = 'watchlist-collection-items';

      entry.collectionItems.slice(0,5).forEach(child=>{

        const row = document.createElement('div');

        row.className = 'watchlist-collection-item';

        row.textContent = child.year ? `${child.title} (${child.year})` : child.title;

        itemsWrap.appendChild(row);

      });

      if(entry.collectionItems.length > 5){

        const more = document.createElement('div');

        more.className = 'watchlist-collection-more';

        more.textContent = `+${entry.collectionItems.length - 5} weitere`;

        itemsWrap.appendChild(more);

      }

      info.appendChild(itemsWrap);

    }

    const removeBtn = document.createElement('button');

    removeBtn.type = 'button';

    removeBtn.className = 'watchlist-remove';

    removeBtn.textContent = 'Entfernen';

    removeBtn.addEventListener('click', ()=>removeWatchlistEntry(entry.key));

    li.appendChild(info);

    li.appendChild(removeBtn);

    list.appendChild(li);

  });

}

function updateWatchlistUI(){

  const count = state.watchlist.size;

  const countLabel = $('#watchlistCount');

  const toggleBtn = $('#watchlistToggle');

  if(countLabel) countLabel.textContent = count;

  if(toggleBtn){

    toggleBtn.classList.toggle('has-items', count > 0);

    const panel = $('#watchlistPanel');

    const expanded = panel ? !panel.hidden : false;

    toggleBtn.setAttribute('aria-expanded', expanded ? 'true' : 'false');

  }

  renderWatchlistItems();

  refreshWatchlistIndicators();

}

function persistWatchlist(){

  if(!sessionStore) return;

  try{

    const payload = JSON.stringify(Array.from(state.watchlist.values()));

    sessionStore.setItem(WATCHLIST_STORAGE_KEY, payload);

    sessionStore.setItem(WATCHLIST_EXPORTED_KEY, watchlistExported && !watchlistDirty ? '1' : '0');

  }catch(err){

    console.warn('Watchlist persist failed', err);

  }

}

function setWatchlistPanelVisible(show){

  const panel = $('#watchlistPanel');

  const toggleBtn = $('#watchlistToggle');

  if(panel) panel.hidden = !show;

  if(toggleBtn){

    toggleBtn.classList.toggle('active', Boolean(show));

    toggleBtn.setAttribute('aria-expanded', show ? 'true' : 'false');

  }

  if(show) updateWatchlistUI();

}

function toggleCollectionWatchlist(group){

  const key = watchlistKey(group);

  if(!key) return;

  if(state.watchlist.has(key)){

    state.watchlist.delete(key);

    if(state.watchlist.size === 0){

      watchlistDirty = false;

      watchlistExported = false;

    }else{

      watchlistDirty = true;

      watchlistExported = false;

    }

  }else{

    state.watchlist.set(key, watchlistEntryFor(group));

    watchlistDirty = true;

    watchlistExported = false;

  }

  persistWatchlist();

  updateWatchlistUI();

}

function toggleWatchlist(item){

  if(item && (item.isCollectionGroup || item.type === 'collection')){

    toggleCollectionWatchlist(item);

    return;

  }

  const key = watchlistKey(item);

  if(!key) return;

  if(state.watchlist.has(key)){

    state.watchlist.delete(key);

    if(state.watchlist.size === 0){

      watchlistDirty = false;

      watchlistExported = false;

    }else{

      watchlistDirty = true;

      watchlistExported = false;

    }

  }else{

    state.watchlist.set(key, watchlistEntryFor(item));

    watchlistDirty = true;

    watchlistExported = false;

  }

  persistWatchlist();

  updateWatchlistUI();

}

function removeWatchlistEntry(key){

  if(!key || !state.watchlist.has(key)) return;

  state.watchlist.delete(key);

  if(state.watchlist.size === 0){

    watchlistDirty = false;

    watchlistExported = false;

  }else{

    watchlistDirty = true;

    watchlistExported = false;

  }

  persistWatchlist();

  updateWatchlistUI();

}

function clearWatchlist(){

  state.watchlist.clear();

  watchlistDirty = false;

  watchlistExported = false;

  persistWatchlist();

  updateWatchlistUI();

}

function exportWatchlist(){

  if(state.watchlist.size === 0) return;

  const data = {

    exportedAt: new Date().toISOString(),

    itemCount: state.watchlist.size,

    items: Array.from(state.watchlist.values()),

  };

  const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });

  const url = URL.createObjectURL(blob);

  const dateStamp = new Date().toISOString().slice(0,10);

  const link = document.createElement('a');

  link.href = url;

  link.download = `plex-merkliste-${dateStamp}.json`;

  document.body.appendChild(link);

  link.click();

  document.body.removeChild(link);

  setTimeout(()=>URL.revokeObjectURL(url), 500);

  watchlistDirty = false;

  watchlistExported = true;

  persistWatchlist();

  updateWatchlistUI();

}

function bindWatchlistControls(){

  const toggleBtn = $('#watchlistToggle');

  if(toggleBtn){

    toggleBtn.addEventListener('click', ()=>{

      const panel = $('#watchlistPanel');

      const next = panel ? panel.hidden : true;

      setWatchlistPanelVisible(next);

    });

  }

  const closeBtn = $('#closeWatchlist');

  if(closeBtn) closeBtn.addEventListener('click', ()=>setWatchlistPanelVisible(false));

  const exportBtn = $('#exportWatchlist');

  if(exportBtn) exportBtn.addEventListener('click', exportWatchlist);

  const clearBtn = $('#clearWatchlist');

  if(clearBtn){

    clearBtn.addEventListener('click', ()=>{

      if(state.watchlist.size === 0) return;

      if(!confirm('Merkliste wirklich leeren?')) return;

      clearWatchlist();

    });

  }

}

function initWatchlist(){

  try{

    sessionStore = window.localStorage;

  }catch(err){ sessionStore = null; }

  state.watchlist = new Map();

  watchlistDirty = false;

  watchlistExported = false;

  if(sessionStore){

    try{

      const raw = sessionStore.getItem(WATCHLIST_STORAGE_KEY);

      if(raw){

        const parsed = JSON.parse(raw);

        if(Array.isArray(parsed)){

          parsed.forEach(entry=>{

            if(entry && entry.key){

              state.watchlist.set(String(entry.key), entry);

            }

          });

        }

      }

      watchlistExported = sessionStore.getItem(WATCHLIST_EXPORTED_KEY) === '1';

    }catch(err){

      console.warn('Watchlist restore failed', err);

    }

  }

  watchlistDirty = state.watchlist.size > 0 && !watchlistExported;

  setWatchlistPanelVisible(false);

  updateWatchlistUI();

}

function anyFilterActive(){

  return Boolean($('#q').value.trim() || state.selectedGenres.size || state.selectedCollection || $('#yearFrom').value || $('#yearTo').value || $('#onlyNew').checked);

}

const TMDB_CACHE_TTL_MS = 14 * 24 * 60 * 60 * 1000; // 14 days

async function tmdbLookup(item){

  if(!useTmdbEnabled()) return null;

  const hasToken = Boolean(CONFIG.tmdbAccessToken);

  const hasKey = Boolean(CONFIG.tmdbApiKey);

  if(!hasToken && !hasKey) return null;

  const ids = parseGuids(item);

  const category = state.libraryType === 'tv' ? 'tv' : 'movie';

  const cacheKey = `${state.library}:${category}:${ids.tmdb||ids.imdb||item.ratingKey}`;

  if(tmdbCache.has(cacheKey)){
    const entry = tmdbCache.get(cacheKey);
    if(entry && typeof entry === 'object' && 'data' in entry){
      if(entry.ts && (Date.now() - Number(entry.ts)) < TMDB_CACHE_TTL_MS){
        return entry.data;
      }
    }else if(entry){
      return entry; // legacy without TTL
    }
  }

  const headers = { Accept: 'application/json' };

  let query = '';

  if(hasToken){

    headers.Authorization = `Bearer ${CONFIG.tmdbAccessToken}`;

  }else{

    query = `&api_key=${encodeURIComponent(CONFIG.tmdbApiKey)}`;

  }

  try{

    let data = null;

    if(ids.tmdb){

      const url = `https://api.themoviedb.org/3/${category}/${ids.tmdb}?language=${encodeURIComponent(CONFIG.tmdbLang)}&append_to_response=images&include_image_language=${encodeURIComponent(CONFIG.tmdbLang)},en,null${query}`;

      const res = await fetch(url,{ headers });

      if(res.ok) data = await res.json();

    }else if(ids.imdb){

      const url = `https://api.themoviedb.org/3/find/${ids.imdb}?external_source=imdb_id&language=${encodeURIComponent(CONFIG.tmdbLang)}${query}`;

      const res = await fetch(url,{ headers });

      if(res.ok){

        const json = await res.json();

        data = category === 'tv' ? (json.tv_results && json.tv_results[0]) || null : (json.movie_results && json.movie_results[0]) || null;

      }

    }

    if(!data) return null;

    const posterPath = data.poster_path || (data.images && data.images.posters && data.images.posters[0] && data.images.posters[0].file_path) || null;

    const backdropPath = data.backdrop_path || (data.images && data.images.backdrops && data.images.backdrops[0] && data.images.backdrops[0].file_path) || null;

    const result = {

      poster: posterPath ? `https://image.tmdb.org/t/p/${CONFIG.imageWidths.poster}${posterPath}` : null,

      backdrop: backdropPath ? `https://image.tmdb.org/t/p/${CONFIG.imageWidths.backdrop}${backdropPath}` : null,

    };

    tmdbCache.set(cacheKey, { data: result, ts: Date.now() });

    persistTmdbCache();

    return result;

  }catch(err){

    console.warn('TMDB fetch failed', err);

    return null;

  }

}

const GRID_TRANSITION_MS = 260;

const GRID_CHUNK_SIZE = 60;

let renderRun = 0;

const cardRevealObserver = typeof IntersectionObserver === 'function'

  ? new IntersectionObserver((entries)=>{

    entries.forEach(entry=>{

      if(entry.isIntersecting){

        entry.target.style.transition = 'transform .25s ease, opacity .25s ease';

        entry.target.style.opacity = '1';

        entry.target.style.transform = 'translateY(0)';

        cardRevealObserver.unobserve(entry.target);

      }

    });

  }, { rootMargin: '80px 0px' })

  : null;

function cardEl(item, useTmdb){

  const card = document.createElement('article');

  card.className = 'card';

  card.style.opacity = '0';

  card.style.transform = 'translateY(6px)';

  const key = watchlistKey(item);

  card.dataset.watchlistKey = key;

  const posterDiv = document.createElement('div');

  posterDiv.className = 'poster';

  const img = document.createElement('img');

  img.alt = item.title || '';

  img.loading = 'lazy';

  img.decoding = 'async';

  const onLoad = ()=>{

    const finish = ()=> img.classList.add('is-ready');

    if(typeof img.decode === 'function'){

      img.decode().catch(()=>{}).finally(finish);

    }else{

      finish();

    }

  };

  img.addEventListener('load', onLoad);

  img.addEventListener('error', ()=> img.classList.add('is-ready'));

  const localUrl = localThumbUrl(item);

  if(localUrl){

    img.src = localUrl;

    if(img.complete) onLoad();

  }else{

    img.classList.add('is-ready');

  }

  posterDiv.appendChild(img);

  const watchBtn = document.createElement('button');

  watchBtn.type = 'button';

  watchBtn.className = 'watchlist-toggle';

  watchBtn.dataset.key = key;
  watchBtn.dataset.itemTitle = item.title || item.originalTitle || '-';
  watchBtn.setAttribute('aria-label', `Zu Merkliste: ${watchBtn.dataset.itemTitle}`);

  watchBtn.addEventListener('click', function(ev){ ev.stopPropagation(); toggleWatchlist(item); });

  posterDiv.appendChild(watchBtn);

  

  // Recently added badge (last CONFIG.newDays days)
  if(isNew(item)){
    const newBadge = document.createElement('div');
    newBadge.className = 'new-badge';
    newBadge.textContent = 'Neu';
    posterDiv.appendChild(newBadge);
  }

  const ratingValue = item.audienceRating ?? item.rating ?? null;

  const ratingText = formatRating(ratingValue);

  if(ratingText){

    const ratingBadge = document.createElement('div');

    ratingBadge.className = 'rating';

    ratingBadge.textContent = '* ' + ratingText;

    posterDiv.appendChild(ratingBadge);

  }

  const meta = document.createElement('div');

  meta.className = 'meta';

  const titleEl = document.createElement('h3');

  titleEl.className = 'title';

  titleEl.textContent = item.title || item.originalTitle || '-';

  // Removed inline title "Neu" chip; ribbon is shown on poster instead

  meta.appendChild(titleEl);

  const sub = document.createElement('div');

  sub.className = 'sub';

  const yr = humanYear(item);

  if(yr) sub.appendChild(span(yr));

  if(item.studio) sub.appendChild(span(item.studio));

  if(!ratingText && ratingValue){

    const fallback = formatRating(ratingValue);

    if(fallback) sub.appendChild(span('* ' + fallback));

  }

  meta.appendChild(sub);

  const collections = collectionTags(item);

  if(collections.length){

    const hint = document.createElement('div');

    hint.className = 'collection-hint';

    const label = document.createElement('span');

    label.className = 'collection-label';

    label.textContent = 'Sammlung:';

    hint.appendChild(label);

    const mainName = collections[0];

    const link = document.createElement('button');

    link.type = 'button';

    link.className = 'collection-link';

    link.textContent = mainName;

    link.setAttribute('aria-label', `Sammlung ${mainName} anzeigen`);

    link.title = 'Sammlung anzeigen';

    link.addEventListener('click', ev=>{ ev.stopPropagation(); focusCollection(mainName); });

    hint.appendChild(link);

    if(collections.length > 1){

      const more = document.createElement('span');

      more.className = 'collection-more-count';

      more.textContent = `+${collections.length - 1}`;

      hint.appendChild(more);

    }

    meta.appendChild(hint);

  }

  const chips = document.createElement('div');

  chips.className = 'chips';

  (item.genres||[]).slice(0,4).forEach(g=>{ if(g && g.tag) chips.appendChild(chip(g.tag)); });

  meta.appendChild(chips);

  card.appendChild(posterDiv);

  card.appendChild(meta);

  // Keep a back-reference for modal navigation
  try{ card.__item = item; }catch{}

  applyWatchlistState(key, card, watchBtn);

  if(cardRevealObserver){

    cardRevealObserver.observe(card);

  }else{

    card.style.opacity = '';

    card.style.transform = '';

  }

  if(useTmdb){

    tmdbLookup(item).then(tmdbData=>{

      if(tmdbData && tmdbData.poster && tmdbData.poster !== img.src){

        img.classList.remove('is-ready');

        img.src = tmdbData.poster;

      }

    }).catch(()=>{});

  }

  // Open detail modal on card click (ignore collection groups and internal buttons)
  card.addEventListener('click', (ev)=>{
    if(card.dataset.collectionGroup === '1') return;
    if(ev.defaultPrevented) return;
    try{
      if(typeof openModalFromCard === 'function'){ openModalFromCard(card, item); }
      else if(typeof openModal === 'function'){ openModal(buildUnifiedItem(item)); }
    }catch(err){ console.warn('Open modal failed', err); }
  });

  return card;

}

function collectionCardEl(group, useTmdb){

  const card = document.createElement('article');

  card.className = 'card collection-card';

  card.dataset.collectionGroup = '1';

  card.style.opacity = '0';

  card.style.transform = 'translateY(6px)';

  const key = watchlistKey(group);

  card.dataset.watchlistKey = key;

  const posterDiv = document.createElement('div');

  posterDiv.className = 'poster';

  const img = document.createElement('img');

  img.alt = group.title || '';

  img.loading = 'lazy';

  img.decoding = 'async';

  const onLoad = ()=>{

    const finish = ()=> img.classList.add('is-ready');

    if(typeof img.decode === 'function'){

      img.decode().catch(()=>{}).finally(finish);

    }else{

      finish();

    }

  };

  img.addEventListener('load', onLoad);

  img.addEventListener('error', ()=> img.classList.add('is-ready'));

  const posterItem = group.posterItem || (group.items && group.items[0]) || null;

  const localUrl = posterItem ? localThumbUrl(posterItem) : '';

  if(localUrl){

    img.src = localUrl;

    if(img.complete) onLoad();

  }else{

    img.classList.add('is-ready');

  }

  posterDiv.appendChild(img);

  const watchBtn = document.createElement('button');

  watchBtn.type = 'button';

  watchBtn.className = 'watchlist-toggle';

  watchBtn.dataset.key = key;

  watchBtn.dataset.collection = '1';
  watchBtn.dataset.itemTitle = group.title || group.collectionName || '-';
  watchBtn.setAttribute('aria-label', `Zu Merkliste: ${watchBtn.dataset.itemTitle}`);

  watchBtn.addEventListener('click', ev=>{ ev.stopPropagation(); toggleCollectionWatchlist(group); });

  posterDiv.appendChild(watchBtn);

  // Recently added ribbon for collection groups
  if(isNew(group)){
    const newBadge = document.createElement('div');
    newBadge.className = 'new-badge';
    newBadge.textContent = 'Neu';
    posterDiv.appendChild(newBadge);
  }

  const meta = document.createElement('div');

  meta.className = 'meta';

  const titleEl = document.createElement('h3');

  titleEl.className = 'title';

  titleEl.textContent = group.title || '-';

  meta.appendChild(titleEl);

  const countEl = document.createElement('div');

  countEl.className = 'collection-count';

  const count = group.itemCount || (group.items ? group.items.length : 0);

  if(count){

    countEl.textContent = `${count} ${count === 1 ? 'Film' : 'Filme'}`;

    meta.appendChild(countEl);

  }

  const summary = document.createElement('div');

  summary.className = 'collection-summary';

  const list = document.createElement('ul');

  list.className = 'collection-list';

  const collectionItems = group.items || [];

  const maxVisible = 3;

  collectionItems.slice(0, maxVisible).forEach((item, idx)=>{

    const li = document.createElement('li');

    const idxEl = document.createElement('span');

    idxEl.className = 'index';

    idxEl.textContent = `${idx+1}.`;

    const title = document.createElement('span');

    title.className = 'title';

    title.textContent = item.title || item.originalTitle || '-';

    const yearEl = document.createElement('span');

    yearEl.className = 'year';

    yearEl.textContent = humanYear(item) || '';

    li.appendChild(idxEl);

    li.appendChild(title);

    if(yearEl.textContent) li.appendChild(yearEl);

    list.appendChild(li);

  });

  summary.appendChild(list);

  const remaining = collectionItems.length - maxVisible;

  if(remaining > 0){

    const more = document.createElement('div');

    more.className = 'collection-more';

    more.textContent = `+${remaining} weitere anzeigen`;

    summary.appendChild(more);

    summary.classList.add('is-clickable');

    const focus = ev=>{

      ev.preventDefault();

      ev.stopPropagation();

      focusCollection(group.collectionName || group.title || '');

    };

    summary.addEventListener('click', focus);

    more.addEventListener('click', focus);

  }

  meta.appendChild(summary);

  if(group.genres && group.genres.length){

    const chipsHolder = document.createElement('div');

    chipsHolder.className = 'chips';

    group.genres.slice(0,4).forEach(name=>{ chipsHolder.appendChild(chip(name)); });

    meta.appendChild(chipsHolder);

  }

  card.appendChild(posterDiv);

  card.appendChild(meta);

  applyWatchlistState(key, card, watchBtn);

  if(cardRevealObserver){

    cardRevealObserver.observe(card);

  }else{

    card.style.opacity = '';

    card.style.transform = '';

  }

  if(useTmdb && posterItem){

    tmdbLookup(posterItem).then(tmdbData=>{

      if(tmdbData && tmdbData.poster && tmdbData.poster !== img.src){

        img.classList.remove('is-ready');

        img.src = tmdbData.poster;

      }

    }).catch(()=>{});

  }

  return card;

}

function renderGrid(items){

  const grid = $('#grid');

  if(!grid) return;

  const currentRun = ++renderRun;

  const useTmdb = useTmdbEnabled();

  const createCard = entry => entry && entry.isCollectionGroup ? collectionCardEl(entry, useTmdb) : cardEl(entry, useTmdb);

  grid.replaceChildren();

  let index = 0;

  const pushChunk = ()=>{

    if(currentRun !== renderRun) return;

    const fragment = document.createDocumentFragment();

    const end = Math.min(index + GRID_CHUNK_SIZE, items.length);

    for(; index < end; index++){

      fragment.appendChild(createCard(items[index]));

    }

    grid.appendChild(fragment);

    if(index < items.length){

      requestAnimationFrame(pushChunk);

    }

  };

  requestAnimationFrame(pushChunk);

}

function beginGridTransition(grid){

  if(!grid) return;

  grid.classList.remove('is-entering','is-ready');

  grid.classList.add('is-leaving');

}

function finishGridTransition(grid){

  if(!grid) return;

  grid.classList.remove('is-leaving');

  grid.classList.add('is-entering');

  requestAnimationFrame(()=>{

    grid.classList.add('is-ready');

    setTimeout(()=>grid.classList.remove('is-entering','is-ready'), GRID_TRANSITION_MS);

  });

}

async function preloadPosters(urls, limit = 30, timeoutMs = 600){

  const candidates = (urls || []).filter(Boolean).slice(0, limit);

  if(!candidates.length) return;

  const tasks = candidates.map(src=>new Promise(resolve=>{

    const img = new Image();

    img.decoding = 'async';

    if(typeof img.decode === 'function'){

      img.src = src;

      img.decode().catch(()=>{}).finally(resolve);

    }else{

      img.onload = resolve;

      img.onerror = resolve;

      img.src = src;

    }

  }));

  await Promise.race([

    Promise.all(tasks),

    new Promise(res=>setTimeout(res, timeoutMs))

  ]);

}

function createCollectionGroup(name, members){

  const list = (members||[]).slice().sort((a,b)=>{

    const ay = Number(humanYear(a)) || 0;

    const by = Number(humanYear(b)) || 0;

    if(ay !== by) return ay - by;

    return (a.title||'').localeCompare(b.title||'', 'de');

  });

  const years = list.map(item=>Number(humanYear(item))||0).filter(Boolean);

  const year = years.length ? Math.min(...years) : '';

  const addedTimestamps = list.map(item=>{

    if(!item.addedAt) return 0;

    const time = new Date(item.addedAt).getTime();

    return Number.isFinite(time) ? time : 0;

  }).filter(Boolean);

  const latestAdded = addedTimestamps.length ? new Date(Math.max(...addedTimestamps)).toISOString() : null;

  const ratings = list.map(item=>{

    const val = Number(item.rating ?? item.audienceRating);

    return Number.isFinite(val) ? val : NaN;

  }).filter(num=>Number.isFinite(num));

  const rating = ratings.length ? ratings.reduce((sum,val)=>sum+val,0) / ratings.length : null;

  const posterItem = list.find(entry=>localThumbUrl(entry)) || list[0] || null;

  const genres = dedup(list.flatMap(entry=>((entry.genres||[]).map(g=>g && g.tag).filter(Boolean)))).slice(0,4);

  return {

    isCollectionGroup: true,

    type: 'collection',

    title: name,

    collectionName: name,

    items: list,

    itemCount: list.length,

    year: year || '',

    addedAt: latestAdded,

    rating,

    posterItem,

    genres,

  };

}

function mergeCollectionView(items){

  if(!state.groupCollections) return items.slice();

  const membership = new Map();

  items.forEach(item=>{

    collectionTags(item).forEach(name=>{

      if(state.selectedCollection && name !== state.selectedCollection) return;

      if(!membership.has(name)) membership.set(name, []);

      membership.get(name).push(item);

    });

  });

  const groups = new Map();

  const groupedIds = new Set();

  const output = [];

  items.forEach(item=>{

    const id = itemIdentity(item);

    const tags = collectionTags(item);

    let contributedToGroup = false;

    if(tags.length){

      tags.forEach(name=>{

        if(state.selectedCollection && name !== state.selectedCollection) return;

        const members = membership.get(name) || [];

        const qualifies = members.length > 1 || state.selectedCollection === name;

        if(!qualifies) return;

        if(!groups.has(name)){

          const group = createCollectionGroup(name, members);

          groups.set(name, group);

          output.push(group);

        }

        members.forEach(member=> groupedIds.add(itemIdentity(member)));

        contributedToGroup = true;

      });

    }

    if(!contributedToGroup){

      if(!groupedIds.has(id)){

        output.push(item);

        groupedIds.add(id);

      }

    }

  });

  return output;

}

function ensureCollectionSort(){

  const sortSel = $('#sort');

  if(!sortSel) return;

  if(state.selectedCollection && sortSel.value === 'title-asc'){

    sortSel.value = 'year-desc';

  }

}

function focusCollection(name){

  const target = String(name || '').trim();

  if(!target) return;

  state.selectedCollection = target;

  state.groupCollections = false;

  state.advancedManual = false;

  ensureCollectionSort();

  fillFilters();

  update();

}

function update(){

  if(!state.ready) return;

  if(!state.advancedManual){

    setAdvancedExpanded(shouldExpandAdvanced(), { manual: false });

  }

  state.filtered = state.items.filter(matches);

  applySort(state.filtered);

  const viewItems = mergeCollectionView(state.filtered);

  updateHeroSubtitleDisplay(viewItems.length);

  const grid = $('#grid');

  if(!grid) return;

  const empty = $('#empty');

  if(viewItems.length === 0){

    renderRun++;

    grid.replaceChildren();

    if(empty){

      empty.hidden = false;

      empty.textContent = (state.filtered.length === 0 && !anyFilterActive()) ? 'Keine Einträge für diese Bibliothek gefunden.' : 'Kein Treffer. Filter lockern?';

    }

    updateWatchlistUI();

    return;

  }

  if(empty) empty.hidden = true;

  renderGrid(viewItems);

  updateWatchlistUI();

}

function span(text){ const el = document.createElement('span'); el.textContent = text; return el; }

function chip(text){ const el = document.createElement('span'); el.className = 'chip'; el.textContent = text; return el; }

async function setLibrary(key){

  if(!CONFIG.libraries[key]) return;

  if(state.library === key && state.ready) return;

  const def = libraryDefinition(key);

  if(!def) return;

  const grid = $('#grid');

  const animate = state.ready && Boolean(grid);

  if(animate) beginGridTransition(grid);

  state.library = key;

  state.libraryBase = def.thumbBase || '';

  state.libraryType = def.tmdbType || 'movie';

  const payload = await loadLibraryPayload(def, key);

  state.items = normalizeItems(payload);

  libraryTotals[key] = state.items.length;

  collectFacets();

  fillFilters();

  state.ready = true;

  updateHeroStatsDisplay();
  updateFooterMeta();

  if(animate){

    const preloadUrls = state.items.slice(0,30).map(item=>localThumbUrl(item)).filter(Boolean);

    try{

      await preloadPosters(preloadUrls);

    }catch(err){

      console.warn('Poster preload failed', err);

    }

  }

  update();

  if(animate && grid){

    requestAnimationFrame(()=>finishGridTransition(grid));

  }

  updateLibrarySwitch();

  // Ensure clean document title (avoid mojibake)
  try{
    const def2 = libraryDefinition(state.library);
    const label2 = (def2 && def2.label) || state.library;
    const count2 = state.items.length || 0;
    document.title = `Plex-Katalog - ${label2} (${count2})`;
  }catch{}
  localStorage.setItem('plexLibrary', key);

  // Update document title with library + count
  try{
    const label = (def && def.label) || key;
    const count = state.items.length || 0;
    document.title = `Plex-Katalog – ${label} (${count})`;
  }catch{}

  // Finalize: set clean document title (wins last)
  try{
    const labelX = (def && def.label) || key;
    const countX = state.items.length || 0;
    document.title = `Plex-Katalog - ${labelX} (${countX})`;
  }catch{}

}

function initLibrarySwitch(){

  const holder = $('#librarySwitch');

  if(!holder) return;

  holder.innerHTML = '';

  Object.entries(CONFIG.libraries).forEach(([key, def])=>{

    const btn = document.createElement('button');

    btn.type = 'button';

    btn.dataset.key = key;

    btn.textContent = def.label || key;

    btn.setAttribute('aria-pressed', key === state.library ? 'true' : 'false');

    btn.addEventListener('click', ()=>{

      $$('#librarySwitch button').forEach(b=>{
        const isActive = b === btn;
        b.classList.toggle('active', isActive);
        b.setAttribute('aria-pressed', isActive ? 'true' : 'false');
      });

      setLibrary(key);

    });

    holder.appendChild(btn);

  });

  updateLibrarySwitch();

}

function updateLibrarySwitch(){

  $$('#librarySwitch button').forEach(btn=>{

    const isActive = btn.dataset.key === state.library;
    btn.classList.toggle('active', isActive);
    btn.setAttribute('aria-pressed', isActive ? 'true' : 'false');

  });

}

function advancedElements(){

  return {

    button: $('#toggleAdvanced'),

    panel: $('#advancedFilters'),

  };

}

function setAdvancedExpanded(next, { manual } = { manual:false }){

  state.advancedExpanded = Boolean(next);

  if(manual) state.advancedManual = true;

  const { button, panel } = advancedElements();

  if(button){

    button.setAttribute('aria-expanded', next ? 'true' : 'false');

    button.textContent = next ? 'Erweiterte Filter verbergen' : 'Erweiterte Filter anzeigen';

  }

  if(panel){

    panel.hidden = !next;

    panel.classList.toggle('active', next);

  }

}

function shouldExpandAdvanced(){

  return state.advancedManual ? state.advancedExpanded : state.selectedGenres.size > 0 || state.selectedCollection || state.groupCollections || $('#yearFrom').value || $('#yearTo').value || $('#onlyNew').checked;

}

function initAdvancedToggle(){

  const { button } = advancedElements();

  if(!button) return;

  button.addEventListener('click', ()=>{

    const next = !state.advancedExpanded;

    setAdvancedExpanded(next, { manual: true });

  });

  setAdvancedExpanded(shouldExpandAdvanced(), { manual: false });

}

function bindFilters(){

  const qInput = $('#q');

  if(qInput){

    const debounced = debounce(update, 120);

    qInput.addEventListener('input', debounced);

  }

  const collectionSelect = $('#collectionFilter');

  if(collectionSelect){

    collectionSelect.addEventListener('change', ()=>{

      state.selectedCollection = collectionSelect.value || '';

      if(state.selectedCollection){

        state.groupCollections = false;

        ensureCollectionSort();

      }

      fillFilters();

      update();

    });

  }

  const groupToggle = $('#groupCollections');

  if(groupToggle){

    groupToggle.addEventListener('change', ()=>{

      state.groupCollections = groupToggle.checked;

      update();

    });

  }

  $('#yearFrom').addEventListener('change', update);

  $('#yearTo').addEventListener('change', update);

  const yearReset = $('#yearReset');
  if(yearReset){
    yearReset.addEventListener('click', ()=>{
      const yf = $('#yearFrom');
      const yt = $('#yearTo');
      if(yf) yf.value = '';
      if(yt) yt.value = '';
      update();
    });
  }

  $('#sort').addEventListener('change', update);

  $('#onlyNew').addEventListener('change', update);

  // TMDB toggle moved to settings overlay (useTmdbSetting)

}

function resetFilters(){
  try{
    const q = $('#q'); if(q) q.value = '';
    state.selectedGenres.clear();
    state.selectedCollection = '';
    const yf = $('#yearFrom'); if(yf) yf.value = '';
    const yt = $('#yearTo'); if(yt) yt.value = '';
    const onlyNew = $('#onlyNew'); if(onlyNew) onlyNew.checked = false;
    const group = $('#groupCollections'); if(group) group.checked = false; state.groupCollections = false;
    fillFilters();
    update();
  }catch(err){ console.warn('resetFilters failed', err); }
}

function initSettingsOverlay(){
  const openBtn = $('#settingsBtn');
  const overlay = $('#settingsOverlay');
  const closeBtns = ['#settingsClose2'].map(sel=>$(sel)).filter(Boolean);
  const tokenInput = $('#tmdbTokenInput');
  const saveBtn = $('#tmdbSave');
  const clearBtn = $('#tmdbClearCache');
  const reduceChk = $('#prefReduceMotion');
  const resetBtn = $('#resetFilters');
  const useTmdbChk = $('#useTmdbSetting');

  if(openBtn && overlay){
    openBtn.addEventListener('click', ()=>{
      overlay.hidden = false;
      let hasToken = false;
      try{ tokenInput.value = localStorage.getItem('tmdbToken') || ''; hasToken = Boolean(tokenInput.value); }catch{}
      try{ reduceChk.checked = (localStorage.getItem('prefReduceMotion') === '1'); }catch{}
      if(useTmdbChk){
        useTmdbChk.disabled = !hasToken;
        useTmdbChk.checked = hasToken && getUseTmdbPref();
        if(!hasToken){
          useTmdbChk.setAttribute('title','TMDB-Token erforderlich');
          useTmdbChk.setAttribute('aria-disabled','true');
        }else{
          useTmdbChk.removeAttribute('title');
          useTmdbChk.removeAttribute('aria-disabled');
        }
      }
      // focus first control
      setTimeout(()=>tokenInput && tokenInput.focus(), 0);
    });
  }
  closeBtns.forEach(btn=>btn.addEventListener('click', ()=>{ overlay.hidden = true; }));
  // Allow clicking overlay backdrop to close
  if(overlay){
    overlay.addEventListener('click', (ev)=>{ if(ev.target === overlay) overlay.hidden = true; });
  }
  if(saveBtn && tokenInput){
    saveBtn.addEventListener('click', ()=>{
      const t = tokenInput.value||'';
      setTmdbToken(t);
      if(useTmdbChk){
        const has = Boolean(t);
        useTmdbChk.disabled = !has;
        if(!has){
          setUseTmdbPref(false);
          useTmdbChk.checked = false;
          useTmdbChk.setAttribute('title','TMDB-Token erforderlich');
          useTmdbChk.setAttribute('aria-disabled','true');
        }else{
          useTmdbChk.removeAttribute('title');
          useTmdbChk.removeAttribute('aria-disabled');
        }
      }
      update();
    });
  }
  if(clearBtn){
    clearBtn.addEventListener('click', ()=>{ clearTmdbCache(); alert('TMDB-Cache geleert.'); });
  }
  if(reduceChk){
    reduceChk.addEventListener('change', ()=>{
      try{ localStorage.setItem('prefReduceMotion', reduceChk.checked ? '1' : '0'); }catch{}
      applyReduceMotionPref();
    });
  }
  if(useTmdbChk){
    useTmdbChk.addEventListener('change', ()=>{
      setUseTmdbPref(Boolean(useTmdbChk.checked));
      update();
    });
  }
  if(resetBtn){
    resetBtn.addEventListener('click', ()=>{ resetFilters(); });
  }
}

window.addEventListener('beforeunload', event=>{

  if(watchlistDirty && !watchlistExported){

    const msg = 'Merkliste wurde noch nicht exportiert.';

    event.preventDefault();

    event.returnValue = msg;

    return msg;

  }

  return undefined;

});

window.addEventListener('storage', evt=>{

  if(evt.key === WATCHLIST_STORAGE_KEY && sessionStore){

    initWatchlist();

  }

});

function updateHeroSubtitleDisplay(count){

  const target = heroElements.subtitle;

  if(!target) return;

  if(typeof count === 'number' && count === 0){

    target.dataset.taglinePaused = '1';

    target.textContent = 'Keine Einträge gefunden.';

    return;

  }

  target.dataset.taglinePaused = '0';

  target.classList.remove('is-fading');

  const current = target.textContent;

  if(!TAGLINES.includes(current)){

    target.textContent = TAGLINES[taglineIdx];

  }

}

 function updateFooterMeta(){
   const el = document.getElementById('footerMeta');
   if(!el) return;
   try{
     const lib = CONFIG.libraries[state.library];
     const label = (lib && lib.label) || state.library;
     const movies = libraryTotals.movies ?? '--';
     const shows = libraryTotals.shows ?? '--';
     const date = new Date().toLocaleDateString('de-DE');
     el.textContent = `Bibliothek: ${label} – Filme ${movies} | Serien ${shows} – Stand: ${date}`;
   }catch{}
 }

const initialLibrary = localStorage.getItem('plexLibrary');

(async function init(){

  initLibrarySwitch();

  bindFilters();

  bindWatchlistControls();

  initAdvancedToggle();

  initSettingsOverlay();

  initWatchlist();

  const first = CONFIG.libraries[initialLibrary] ? initialLibrary : CONFIG.defaultLibrary;

  await setLibrary(first);


  const openSettings = document.getElementById('openSettings');
  if(openSettings){ openSettings.addEventListener('click', (ev)=>{ ev.preventDefault(); document.getElementById('settingsBtn')?.click(); }); }
  const openWatchlist = document.getElementById('openWatchlist');
  if(openWatchlist){ openWatchlist.addEventListener('click', (ev)=>{ ev.preventDefault(); setWatchlistPanelVisible(true); }); }

})();

</script>

<!-- Detail Modal -->
<div id="modal" class="modal" hidden>
  <button class="modal__arrow modal__arrow--prev" id="mPrev" aria-label="Vorheriger"><span class="chev"><</span></button>
  <div class="modal__panel" role="dialog" aria-modal="true" aria-labelledby="mTitle">
    <button class="modal__close" id="mClose" aria-label="Schließen">✕</button>

    <div class="modal__hero">
      <div class="modal__poster"><img id="mPoster" alt="" loading="lazy" decoding="async"></div>
      <div class="modal__head">
        <div class="topbar">
          <h2 id="mTitle"></h2>
          <div class="util-actions" id="mActions" aria-label="Externe Links und Trailer">
            <a id="mTmdb" target="_blank" rel="noopener" aria-label="Auf TMDB öffnen" style="display:none">TMDB</a>
            <a id="mImdb" target="_blank" rel="noopener" aria-label="Auf IMDb öffnen" style="display:none">IMDb</a>
            <button id="mTrailer" aria-label="Trailer abspielen" hidden>Trailer</button>
          </div>
        </div>
        <div id="mSubline" class="subline"></div>
        <div id="mChips" class="chips" aria-label="Attribute"></div>
      </div>
    </div>

    <nav class="modal__subnav" aria-label="Details Navigation">
      <div class="inner">
        <button type="button" id="navOverview" data-target="#sec-overview" class="active" aria-controls="sec-overview" aria-label="Zum Überblick">Überblick</button>
        <button type="button" id="navSeasons" data-target="#sec-seasons" aria-controls="sec-seasons" aria-label="Zu den Staffeln">Staffeln</button>
        <button type="button" id="navCast" data-target="#sec-cast" aria-controls="sec-cast" aria-label="Zur Besetzung">Besetzung</button>
      </div>
    </nav>

    <div class="modal__body">
      <section id="sec-overview" class="modal-section" tabindex="-1">
        <h3 class="sr-only">Überblick</h3>
        <p id="mOverview" class="overview"></p>
        <p id="mOverviewShow" class="overview" hidden></p>
        <div class="kpis chips" id="mKpiShow" hidden></div>
      </section>

      <section id="sec-seasons" class="modal-section" tabindex="-1" hidden>
        <h3>Staffeln</h3>
        <div id="mSeasons" class="seasons" hidden></div>
        <div id="seasonsAccordion" class="seasons-accordion"></div>
      </section>

      <section id="sec-cast" class="modal-section" tabindex="-1">
        <h3>Besetzung</h3>
        <div id="mCast" class="cast"></div>
        <div id="mCastShow" class="cast chips" hidden></div>
      </section>
    </div>
  </div>
  <button class="modal__arrow modal__arrow--next" id="mNext" aria-label="Nächster"><span class="chev">></span></button>
  <div class="sr-only" aria-live="polite" id="modalAriaLive"></div>
  <div class="sr-only" id="modalFocusSentinelStart" tabindex="0"></div>
  <div class="sr-only" id="modalFocusSentinelEnd" tabindex="0"></div>
</div>

<script>
// Modal logic: offline-first, optional TMDB hydration
(function(){
  const modal = {
    el: document.getElementById('modal'),
    panel: null,
    poster: document.getElementById('mPoster'),
    title: document.getElementById('mTitle'),
    sub: document.getElementById('mSubline'),
    chips: document.getElementById('mChips'),
    overview: document.getElementById('mOverview'),
    overviewShow: document.getElementById('mOverviewShow'),
    cast: document.getElementById('mCast'),
    castShow: document.getElementById('mCastShow'),
    actions: document.getElementById('mActions'),
    tmdb: document.getElementById('mTmdb'),
    imdb: document.getElementById('mImdb'),
    trailerBtn: document.getElementById('mTrailer'),
    seasons: document.getElementById('mSeasons'),
    secOverview: document.getElementById('sec-overview'),
    secSeasons: document.getElementById('sec-seasons'),
    secCast: document.getElementById('sec-cast'),
    navBtns: {
      overview: document.getElementById('navOverview'),
      seasons: document.getElementById('navSeasons'),
      cast: document.getElementById('navCast'),
    },
    closeBtn: document.getElementById('mClose'),
    lastFocus: null,
    current: null,
  };
  modal.panel = modal.el ? modal.el.querySelector('.modal__panel') : null;

  function mapFSK(s){
    if(!s) return '';
    if(/^de\//i.test(s)) return 'FSK ' + s.split('/')[1];
    return s;
  }

  function childChip(text){ const el = document.createElement('span'); el.className='chip'; el.textContent=String(text); return el; }

  function runtimeToMin(item){
    const ms = Number(item.duration)||0; if(ms>0) return Math.round(ms/60000);
    const h = String(item.durationHuman||''); const m = h.match(/(\d+)\s*min|mins|minutes/i); if(m && m[1]) return Number(m[1]);
    return null;
  }

  function toType(item){
    const t = (item.type||'').toLowerCase();
    if(t === 'show' || t === 'tv') return 'tv';
    return 'movie';
  }

  function buildUnifiedItem(item){
    const ids = parseGuids(item);
    const type = toType(item || {});
    const yr = humanYear(item);
    const r = item.audienceRating ?? item.userRating ?? item.rating ?? null;
    const run = runtimeToMin(item);
    const poster = localThumbUrl(item);
    const genres = (item.genres||[]).map(g=>g && g.tag).filter(Boolean);
    const cast = (item.roles||[]).map(r=>r && r.tag).filter(Boolean);
    return {
      type,
      ids,
      title: item.title || item.originalTitle || '-',
      year: yr ? Number(yr) : null,
      studio: item.studio || '',
      contentRating: item.contentRating || '',
      rating: r,
      runtimeMin: run,
      genres,
      overview: item.summary || '',
      poster: poster || '',
      backdrop: null,
      cast,
      addedAt: item.addedAt || null,
      seasonCount: item.seasonCount || null,
      seasons: null,
      ratingKey: (item && item.ratingKey != null) ? String(item.ratingKey) : '',
      _raw: item,
    };
  }

  function buildSubline(i){
    const parts = [];
    if(i.year) parts.push(i.year);
    if(i.contentRating) parts.push(mapFSK(i.contentRating));
    if(i.studio) parts.push(i.studio);
    if(isFinite(i.rating)) parts.push(`★ ${Number(i.rating).toFixed(1)}`);
    return parts.join(' • ');
  }

  function fillChips(i){
    if(!modal.chips) return;
    modal.chips.replaceChildren();
    const extra = [];
    const base = (i.genres||[]);
    base.forEach((g, idx)=>{
      const chip = childChip(g);
      if(idx < 6){ modal.chips.appendChild(chip); }
      else{ extra.push(chip); }
    });
    if(i.type === 'movie' && i.runtimeMin) modal.chips.appendChild(childChip(`${i.runtimeMin} min`));
    if(i.type === 'tv'){
      if(i.runtimeMin) modal.chips.appendChild(childChip(`~${i.runtimeMin} min/Ep`));
      if(i.seasonCount) modal.chips.appendChild(childChip(`Staffeln: ${i.seasonCount}`));
    }
    if(extra.length){
      const more = document.createElement('button');
      more.type='button';
      more.className='chip more';
      more.textContent = `+${extra.length} mehr`;
      more.addEventListener('click', ()=>{
        try{ extra.forEach(el=> more.before(el)); }catch{}
        more.remove();
      });
      modal.chips.appendChild(more);
    }
  }

  // Override possibly mangled buildSubline due to encoding issues
  buildSubline = function(i){
    const parts = [];
    if(i && i.year) parts.push(i.year);
    if(i && i.contentRating) parts.push(mapFSK(i.contentRating));
    if(i && i.studio) parts.push(i.studio);
    if(i && Number.isFinite(i.rating)) parts.push(`★ ${Number(i.rating).toFixed(1)}`);
    return parts.join(' • ');
  };

  function fillCast(arr){
    if(!modal.cast) return;
    modal.cast.replaceChildren();
    (arr||[]).slice(0,10).forEach(n=> modal.cast.appendChild(childChip(n)));
  }

  function fillActions(item){
    const ids = item.ids || {};
    const imdbId = ids.imdb; const tmdbId = ids.tmdb;
    if(modal.imdb){ modal.imdb.style.display = imdbId ? '' : 'none'; if(imdbId) modal.imdb.href = `https://www.imdb.com/title/${imdbId}/`; }
    if(modal.tmdb){ modal.tmdb.style.display = tmdbId ? '' : 'none'; if(tmdbId){ const path = (item.type === 'tv') ? 'tv' : 'movie'; modal.tmdb.href = `https://www.themoviedb.org/${path}/${tmdbId}`; } }
    if(modal.trailerBtn){ modal.trailerBtn.hidden = true; modal.trailerBtn.onclick = null; }
  }

  function renderSeasons(item){
    if(!modal.seasons) return;
    modal.seasons.replaceChildren();
    if(!Array.isArray(item.seasons) || !item.seasons.length){ modal.seasons.hidden = true; return; }
    item.seasons.forEach(s=>{
      const row = document.createElement('div'); row.className='season';
      if(s.poster){ const t=document.createElement('div'); t.className='season-thumb'; const img=document.createElement('img'); img.src=s.poster; img.alt=s.title||''; t.appendChild(img); row.appendChild(t); }
      const tx=document.createElement('div'); tx.className='season-text'; const st=document.createElement('strong'); st.textContent = s.title || (`Staffel ${s.number||''}`); const yr=document.createElement('div'); yr.className='muted'; yr.textContent = String(s.year||''); tx.appendChild(st); tx.appendChild(yr); row.appendChild(tx);
      const ep = document.createElement('div'); ep.className='episodes';
      (s.episodes||[]).forEach(e=>{
        const r=document.createElement('div'); r.className='episode-row';
        const c=document.createElement('span'); c.className='code'; c.textContent = e.code||''; r.appendChild(c);
        const tt=document.createElement('span'); tt.className='title'; tt.textContent = e.title||''; r.appendChild(tt);
        const m=document.createElement('span'); m.className='meta'; m.textContent = [ e.durationMin && `${e.durationMin} min`, e.date ].filter(Boolean).join(' • '); r.appendChild(m);
        ep.appendChild(r);
      });
      modal.seasons.appendChild(row);
      if(ep.childNodes.length) modal.seasons.appendChild(ep);
    });
    modal.seasons.hidden = false;
  }

  function trapFocus(container){
    if(!container) return;
    const focusable = container.querySelectorAll('a, button, input, select, textarea, [tabindex]:not([tabindex="-1"])');
    const first = focusable[0]; const last = focusable[focusable.length-1];
    function onKey(e){
      if(e.key !== 'Tab') return;
      if(e.shiftKey && document.activeElement === first){ e.preventDefault(); last && last.focus(); }
      else if(!e.shiftKey && document.activeElement === last){ e.preventDefault(); first && first.focus(); }
    }
    container.addEventListener('keydown', onKey);
    container.__trap = onKey;
    first && first.focus();
  }
  function releaseFocus(){ if(modal.panel && modal.panel.__trap){ modal.panel.removeEventListener('keydown', modal.panel.__trap); delete modal.panel.__trap; } }

  async function tmdbDetailLookup(item){
    try{
      const ids = item.ids||{}; if(!ids.tmdb) return null;
      const hasToken = Boolean(CONFIG.tmdbAccessToken); if(!hasToken) return null;
      const category = item.type === 'tv' ? 'tv' : 'movie';
      const cacheKey = `details:${category}:${ids.tmdb}`;
      if(tmdbCache.has(cacheKey)){
        const entry = tmdbCache.get(cacheKey);
        if(entry && entry.ts && (Date.now() - Number(entry.ts)) < 14*24*60*60*1000){ return entry.data; }
      }
      const url = `https://api.themoviedb.org/3/${category}/${ids.tmdb}?language=${encodeURIComponent(CONFIG.tmdbLang)}&append_to_response=images,credits,videos&include_image_language=${encodeURIComponent(CONFIG.tmdbLang)},en,null`;
      const res = await fetch(url, { headers: { Authorization: `Bearer ${CONFIG.tmdbAccessToken}` } });
      if(!res.ok) return null;
      const data = await res.json();
      const posterPath = data.poster_path || null;
      const videos = (data.videos && data.videos.results) || [];
      const youtube = videos.find(v=>v && v.site==='YouTube' && v.type==='Trailer');
      const cast = (data.credits && Array.isArray(data.credits.cast)) ? data.credits.cast.map(x=>x && x.name).filter(Boolean) : [];
      const result = {
        poster: posterPath ? `https://image.tmdb.org/t/p/${CONFIG.imageWidths.poster}${posterPath}` : null,
        overview: data.overview || '',
        cast,
        trailerKey: youtube && youtube.key || null,
      };
      tmdbCache.set(cacheKey, { data: result, ts: Date.now() }); persistTmdbCache();
      return result;
    }catch(err){ console.warn('TMDB detail fetch failed', err); return null; }
  }

  async function maybeHydrateFromTmdb(unified){
    try{
      const data = await tmdbDetailLookup(unified);
      if(!data) return;
      if(data.overview && !unified.overview && modal.overview) modal.overview.textContent = data.overview;
      if(Array.isArray(data.cast) && (!unified.cast || unified.cast.length < 3)) fillCast(data.cast);
      if(data.trailerKey && modal.trailerBtn){ modal.trailerBtn.hidden = false; modal.trailerBtn.onclick = ()=>{ window.open(`https://www.youtube.com/watch?v=${data.trailerKey}`, '_blank', 'noopener'); }; }
    }catch{}
  }

  function renderModal(unified){
    if(!modal.el) return;
    // begin crossfade for title/overview
    modal.el.classList.add('is-updating');
    if(modal.title) modal.title.textContent = unified.title || '—';
    if(modal.poster){
      modal.poster.classList.remove('is-ready');
      const onLoad = ()=>{
        const finish = ()=> modal.poster.classList.add('is-ready');
        if(typeof modal.poster.decode === 'function'){
          modal.poster.decode().catch(()=>{}).finally(finish);
        }else{ finish(); }
      };
      modal.poster.onload = onLoad;
      modal.poster.onerror = ()=> modal.poster.classList.add('is-ready');
      modal.poster.src = unified.poster || '';
      modal.poster.alt = unified.title || '';
      if(modal.poster.complete) onLoad();
    }
    if(modal.sub) modal.sub.textContent = buildSubline(unified);
    fillChips(unified);
    if(modal.overview) modal.overview.textContent = unified.overview || '-';
    if(modal.overviewShow) modal.overviewShow.textContent = unified.overview || '-';
    fillCast(unified.cast || []);
    fillActions(unified);

    // Toggle modal sections by type and render detail views
    const isTV = unified.type === 'tv';
    if(modal.overview) modal.overview.hidden = isTV;
    if(modal.overviewShow) modal.overviewShow.hidden = !isTV;
    if(modal.cast) modal.cast.hidden = isTV;
    if(modal.castShow) modal.castShow.hidden = !isTV;
    if(modal.secSeasons) modal.secSeasons.hidden = !isTV;
    try{ const k=document.getElementById('mKpiShow'); if(k) k.hidden = !isTV; }catch{}

    if(isTV){
      try{ renderShowView(unified); }catch(e){ /* noop */ }
      if(modal.seasons) modal.seasons.hidden = true; // legacy block off
      try{ if(modal.navBtns && modal.navBtns.seasons) modal.navBtns.seasons.hidden = false; }catch{}
    }else{
      try{ renderMovieView(unified); }catch(e){ /* noop */ }
      if(modal.seasons) modal.seasons.hidden = true;
      try{ if(modal.navBtns && modal.navBtns.seasons) modal.navBtns.seasons.hidden = true; }catch{}
    }
    activateSubnavIO();
    maybeHydrateFromTmdb(unified).catch(()=>{});
    // finish crossfade on next frame
    requestAnimationFrame(()=>{ modal.el.classList.remove('is-updating'); });
  }

  function updateArrows(){
    const prev = document.getElementById('mPrev');
    const next = document.getElementById('mNext');
    const nav = modal.nav;
    if(!nav || !Array.isArray(nav.list)){
      if(prev) prev.disabled = true; if(next) next.disabled = true; return;
    }
    if(prev) prev.disabled = nav.index <= 0;
    if(next) next.disabled = nav.index >= (nav.list.length - 1);
  }

  function openModal(unified){
    if(!modal.el) return;
    modal.current = unified;
    modal.lastFocus = document.activeElement;
    renderModal(unified);
    modal.el.hidden = false; modal.el.classList.add('open');
    trapFocus(modal.panel);
    updateArrows();
    updateHashForItem(unified);
  }

  function closeModal(){
    if(!modal.el) return;
    modal.el.classList.remove('open');
    setTimeout(()=>{ modal.el.hidden = true; }, 180);
    releaseFocus();
    if(modal.lastFocus && typeof modal.lastFocus.focus === 'function') try{ modal.lastFocus.focus(); }catch{}
    // clear hash without adding history entry
    try{ history.replaceState(null, '', location.pathname + location.search); }catch{}
  }

  window.openModal = openModal; // expose
  window.buildUnifiedItem = buildUnifiedItem; // expose for debugging

  // Render functions per type
  function renderMovieView(item){
    // Overview and cast already handled in renderModal
    if(Array.isArray(item.cast)) fillCast(item.cast);
    if(modal.secSeasons) modal.secSeasons.hidden = true;
  }

  function collectCardList(){
    const grid = document.getElementById('grid');
    if(!grid) return [];
    return Array.from(grid.querySelectorAll('.card:not(.collection-card)'));
  }

  function buildUnifiedFromCard(card){
    const item = card && card.__item;
    return item ? buildUnifiedItem(item) : null;
  }

  function openModalFromCard(card, item){
    try{
      const list = collectCardList();
      const idx = Math.max(0, list.indexOf(card));
      modal.nav = { list, index: idx };
      const unified = buildUnifiedItem(item || (card && card.__item) || {});
      openModal(unified);
    }catch(err){ console.warn('openModalFromCard failed', err); }
  }
  window.openModalFromCard = openModalFromCard;

  function go(step){
    const nav = modal.nav; if(!nav || !Array.isArray(nav.list)) return;
    const nextIdx = nav.index + step;
    if(nextIdx < 0 || nextIdx >= nav.list.length) return;
    nav.index = nextIdx;
    const el = nav.list[nav.index];
    const unified = buildUnifiedFromCard(el);
    if(!unified) return;
    modal.current = unified;
    // soft refresh content
    renderModal(unified);
    updateArrows();
    updateHashForItem(unified);
  }

  const prevBtn = document.getElementById('mPrev');
  const nextBtn = document.getElementById('mNext');
  // fix aria/chevrons in case of encoding issues
  try{
    if(prevBtn){ prevBtn.setAttribute('aria-label','Vorheriger'); const c = prevBtn.querySelector('.chev'); if(c) c.textContent = '<'; }
    if(nextBtn){ nextBtn.setAttribute('aria-label','Nächster'); const c = nextBtn.querySelector('.chev'); if(c) c.textContent = '>'; }
    const closeBtn = document.getElementById('mClose');
    if(closeBtn){ closeBtn.setAttribute('aria-label','Schließen'); try{ closeBtn.textContent='✕'; }catch{} }
    const closeWatchlist = document.getElementById('closeWatchlist');
    if(closeWatchlist){ closeWatchlist.textContent = 'Schließen'; }
    const settingsClose = document.getElementById('settingsClose2');
    if(settingsClose){ settingsClose.textContent = 'Schließen'; }
  }catch{}
  if(prevBtn) prevBtn.addEventListener('click', (e)=>{ e.preventDefault(); go(-1); });
  if(nextBtn) nextBtn.addEventListener('click', (e)=>{ e.preventDefault(); go(1); });

  if(modal.closeBtn) modal.closeBtn.addEventListener('click', closeModal);
  if(modal.el) modal.el.addEventListener('click', (e)=>{ if(e.target === modal.el) closeModal(); });
  document.addEventListener('keydown', (e)=>{
    if(!modal.el || modal.el.hidden) return;
    if(e.key === 'Escape'){ closeModal(); return; }
    if(e.key === 'ArrowLeft'){ e.preventDefault(); go(-1); return; }
    if(e.key === 'ArrowRight'){ e.preventDefault(); go(1); return; }
  });

  // Subnav: smooth scroll + active state via IntersectionObserver
  function scrollToSection(sel){
    const node = typeof sel === 'string' ? document.querySelector(sel) : sel;
    if(!node || !modal.panel) return;
    const reduce = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
    const top = node.getBoundingClientRect().top - modal.panel.getBoundingClientRect().top + modal.panel.scrollTop - 8;
    modal.panel.scrollTo({ top, behavior: reduce ? 'auto' : 'smooth' });
  }
  if(modal.navBtns){
    const bind = (btn)=>{ if(!btn) return; btn.addEventListener('click', ()=>{ const t=btn.getAttribute('data-target'); if(t) scrollToSection(t); }); };
    bind(modal.navBtns.overview); bind(modal.navBtns.seasons); bind(modal.navBtns.cast);
  }
  let subnavObserver;
  function activateSubnavIO(){
    if(!('IntersectionObserver' in window)) return;
    try{ if(subnavObserver){ subnavObserver.disconnect(); subnavObserver = null; } }catch{}
    const sections = [modal.secOverview, modal.secSeasons, modal.secCast].filter(Boolean).filter(s=> !s.hidden);
    if(!sections.length) return;
    const map = new Map([
      [modal.secOverview, modal.navBtns && modal.navBtns.overview],
      [modal.secSeasons, modal.navBtns && modal.navBtns.seasons],
      [modal.secCast,     modal.navBtns && modal.navBtns.cast],
    ]);
    const opts = { root: modal.panel, threshold: [0.5, 0.75], rootMargin: '0px 0px -35% 0px' };
    subnavObserver = new IntersectionObserver((entries)=>{
      let best = null; let bestRatio = 0;
      for(const e of entries){ if(e.isIntersecting && e.intersectionRatio > bestRatio){ best = e.target; bestRatio = e.intersectionRatio; } }
      if(best && map.has(best)){
        const activeBtn = map.get(best);
        for(const b of Object.values(modal.navBtns||{})){ if(!b) continue; b.classList.toggle('active', b === activeBtn); }
      }
    }, opts);
    sections.forEach(s=> subnavObserver.observe(s));
  }

  // Hash deep-linking
  let suppressHash = false;
  function buildHashFor(item){
    if(!item) return '';
    const type = (item.type === 'tv') ? 'tv' : 'movie';
    const ids = item.ids || {};
    if(ids.tmdb) return `#/${type}/${ids.tmdb}`;
    if(ids.imdb) return `#/${type}/imdb/${ids.imdb}`;
    if(item.ratingKey) return `#/${type}/rk/${item.ratingKey}`;
    return `#/${type}/${encodeURIComponent(item.title||'')}`;
  }
  function updateHashForItem(item){
    try{
      const h = buildHashFor(item);
      if(!h) return;
      suppressHash = true;
      if(location.hash !== h){ location.hash = h; }
      setTimeout(()=>{ suppressHash = false; }, 0);
    }catch{}
  }
  function parseHash(h){
    try{
      const m = String(h||'').match(/^#\/(tv|movie)\/(?:imdb\/([\w]+)|rk\/(\d+)|([\d]+)|(.+))$/);
      if(!m) return null;
      const type = m[1];
      if(m[2]) return { type, idType:'imdb', id:m[2] };
      if(m[3]) return { type, idType:'rk', id:m[3] };
      if(m[4]) return { type, idType:'tmdb', id:m[4] };
      if(m[5]) return { type, idType:'title', id:decodeURIComponent(m[5]) };
      return null;
    }catch{ return null; }
  }
  async function ensureLibraryForType(type){
    const want = (type === 'tv') ? 'shows' : 'movies';
    if(state.library !== want){ await setLibrary(want); }
  }
  function findItemByHash(info){
    const list = state.items || [];
    for(const it of list){
      const ids = parseGuids(it);
      if(info.idType === 'tmdb' && ids.tmdb === info.id) return it;
      if(info.idType === 'imdb' && ids.imdb === info.id) return it;
      if(info.idType === 'rk' && String(it.ratingKey||'') === String(info.id)) return it;
      if(info.idType === 'title' && (it.title||'').toLowerCase() === String(info.id).toLowerCase()) return it;
    }
    return null;
  }
  async function openFromHash(h){
    if(suppressHash) return;
    const info = parseHash(h||location.hash);
    if(!info){ return; }
    await ensureLibraryForType(info.type);
    // wait a tick for grid render
    await new Promise(r=>setTimeout(r,0));
    const target = findItemByHash(info);
    if(!target){ return; }
    // try to find its card for nav
    const cards = collectCardList();
    const card = cards.find(c=> c.__item === target);
    if(card){ openModalFromCard(card, target); }
    else{ modal.nav = { list: cards, index: -1 }; openModal(buildUnifiedItem(target)); }
  }
  window.openFromHash = openFromHash;
  window.addEventListener('hashchange', ()=>{ openFromHash(location.hash); });
  // attempt initial open
  openFromHash(location.hash);
})();
</script>

<!-- TV show view renderer: seasons accordion -->
<script>
 // Mini-helpers (non-conflicting names)
 const _chipView = t => { const s=document.createElement('span'); s.className='chip'; s.textContent=String(t||''); return s; };
 const _setTextView = (sel, txt)=>{ const n = $(sel); if(n) n.textContent = txt ?? ''; };
 const _fillChipsEl = (sel, arr)=>{ const n=$(sel); if(!n) return; const nodes=(arr||[]).filter(Boolean).map(_chipView); n.replaceChildren(...nodes); };

 function renderShowView(item){
   try{
     const seasons = Array.isArray(item.seasons) ? item.seasons : (item._raw && Array.isArray(item._raw.seasons) ? item._raw.seasons : []);

     // Overview & KPIs
     _setTextView('#mOverviewShow', item.overview || '');
    _fillChipsEl('#mKpiShow', [
      (item.runtimeMin ? `~${item.runtimeMin} min/Ep` : null),
      (item.seasonCount ? `Staffeln: ${item.seasonCount}` : null)
    ]);
    try{ const k=document.getElementById('mKpiShow'); if(k) k.hidden = false; }catch{}

     // Cast (top 10)
    _fillChipsEl('#mCastShow', (item.cast||[]).slice(0,10));
    try{ const c=document.getElementById('mCastShow'); if(c) c.hidden = false; }catch{}

     // Seasons accordion
     renderSeasonsAccordion('#seasonsAccordion', seasons);
   }catch(err){ console.warn('renderShowView failed', err); }
 }

 function renderSeasonsAccordion(sel, seasons){
   const root = $(sel); if(!root) return; root.replaceChildren();
   (seasons||[]).forEach((s, idx)=> root.append(seasonCardEl(s, idx)));
 }

 function seasonCardEl(season, idx){
   const card = document.createElement('article'); card.className='season-card';

   const head = document.createElement('div'); head.className='season-head';

   // Thumb (local)
   const th = document.createElement('div'); th.className='season-thumb';
   const img = new Image();
   try{ img.src = (typeof localThumbUrl === 'function' ? (localThumbUrl(season) || season.thumbFile || '') : (season.thumbFile || '')); }catch{ img.src = season.thumbFile || ''; }
   img.alt = season.title || `Staffel ${season.seasonNumber||idx+1}`;
   img.loading = 'lazy'; img.decoding = 'async';
   th.append(img);

   // Text
   const txt = document.createElement('div');
   const title = document.createElement('div'); title.className='season-title';
   title.textContent = season.title || `Staffel ${season.seasonNumber||idx+1}`;
   const sub = document.createElement('div'); sub.className='season-sub';
   const year = season.year || season.releaseYear || '';
   const epCount = Array.isArray(season.episodes) ? season.episodes.length : (season.episodeCount || 0);
   sub.textContent = [year, epCount ? `${epCount} Episoden` : ''].filter(Boolean).join(' • ');
   txt.append(title, sub);

   // Chevron
   const chev = document.createElement('div'); chev.className='chev'; chev.textContent = '›';

   head.append(th, txt, chev);

   // Body (episodes)
   const body = document.createElement('div'); body.className='season-body';
   (season.episodes||[]).forEach(ep => body.append(episodeRowEl(ep)));

   head.addEventListener('click', ()=> card.classList.toggle('open'));
   card.append(head, body);
   return card;
 }

 function episodeRowEl(ep){
   const row = document.createElement('div'); row.className='episode';

   // Title line: SxxEyy – Title
   const title = document.createElement('div'); title.className='ep-title';
   const sNum = ep.seasonNumber != null ? Number(ep.seasonNumber) : null;
   const eNum = ep.episodeNumber != null ? Number(ep.episodeNumber) : null;
   const code = (ep.seasonEpisode && String(ep.seasonEpisode).toUpperCase()) ||
                (Number.isFinite(sNum) && Number.isFinite(eNum) ? `S${String(sNum).padStart(2,'0')}E${String(eNum).padStart(2,'0')}` : '');
   title.textContent = `${code ? code + ' – ' : ''}${ep.title || ''}`;

   // Right badges (optional rating)
   const right = document.createElement('div'); right.className='badges';
   const r = Number(ep.audienceRating ?? ep.rating);
   if(Number.isFinite(r)) right.append(badge(`★ ${r.toFixed(1)}`));

   // Meta: duration • date
   const meta = document.createElement('div'); meta.className='ep-meta';
   const durMin = ep.durationMin || (ep.duration ? Math.round(Number(ep.duration)/60000) : null);
   const durText = ep.durationHuman || (durMin ? `${durMin} min` : null);
   const dateText = ep.originallyAvailableAt || ep.date || '';
   meta.textContent = [durText, dateText].filter(Boolean).join(' • ');

   row.append(title, right, meta);
   return row;
 }

 function badge(text){ const b = document.createElement('span'); b.className='badge'; b.textContent = text; return b; }
 </script>

 <!-- JS-Helfer: "+N mehr" Chips-Reveal -->
 <script>
 // Aktiviert den "mehr"-Chip (hat Klasse .chip.more)
 function enableMoreChipBehavior(root = document){
   try{
     root.querySelectorAll('.chips .chip.more').forEach(btn=>{
       if(btn.dataset.bound) return;
       btn.dataset.bound = '1';
       btn.addEventListener('click', ()=>{
         const hidden = btn._extraChips || [];
         try{ hidden.forEach(ch => btn.before(ch)); }catch{}
         btn.remove();
       });
     });
   }catch{}
 }
 </script>
 </body>

</html>

